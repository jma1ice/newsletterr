{% extends "base.html" %}
{% block title %}newsletterr{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>newsletterr dashboard</h1>
        <button id="sendEmailBtn" class="btn btn-success btn-lg px-5 py-3" style="font-size: 1.6rem; font-weight: 700; min-width: 220px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            📧 Send Email
        </button>
    </div>
    {% if alert %}
        <p id="alert_p" style="color: #01b301; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">{{ alert }}</p>
    {% endif %}
    {% if error %}
        <p id="error_p" style="color: #770010; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">{{ error }}</p>
    {% endif %}
    <div class="foreground">
        <div>
            <table style="height: 60%; width: 100%;">
                <tr style="height: 100%; padding: 10px;">
                    <td style="width: 20%; padding: 10px; vertical-align: top;">
                        <form method="POST" id="stats_form">
                            <label for="items_to_pull">Recently Added Items (#):</label>
                            <input type="number" id="items_to_pull" name="items_to_pull" value="10" style="width: 8.5rem; margin-bottom: 8px;" /><br>
                            <label for="days_to_pull">Time Range (days):</label>
                            <input type="number" id="days_to_pull" name="days_to_pull" value="30" /><br>
                            <div class="quick-range-buttons d-flex flex-nowrap overflow-auto gap-2" style="padding-bottom: 5px;">
                                <button id="time_range_week" type="button" class="button">7</button>
                                <button id="time_range_month" type="button" class="button">30</button>
                                <button id="time_range_quarter" type="button" class="button">90</button>
                                <button id="time_range_two_q" type="button" class="button">180</button>
                                <button id="time_range_three_q" type="button" class="button">270</button>
                                <button id="time_range_year" type="button" class="button">365</button>
                            </div>
                            <button type="submit" class="button">Get Stats\Users</button>
                            <button id="clear_cache_btn" type="button" class="button" 
                                    style="background-color: #dc3545; margin-top: 5px;"
                                    title="Clear cached data to force fresh fetch">Clear Cache</button>
                        </form>
                        
                        {% if cache_info %}
                            <div class="card mt-3" id="cache-card">
                                <div class="card-header d-flex justify-content-between align-items-center" 
                                    style="cursor: pointer; padding: 8px 12px;" 
                                    onclick="document.getElementById('cache-status-badge').classList.toggle('d-none')">
                                    <h6 class="mb-0" style="font-size: 0.85rem;">Cache Status</h6>
                                    <span style="font-size: 0.8rem;">▼</span>
                                </div>
                                <div id="cache-status-badge" class="card-body d-none" style="padding: 8px 12px; font-size: 0.8rem;">
                                    {% for key, info in cache_info.items() %}
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="text-muted" style="text-transform: capitalize;">{{ key.replace('_', ' ') }}:</span>
                                            {% if info.exists %}
                                                {% if info.is_fresh %}
                                                    <span class="text-success">✓ Fresh ({{ "%.1f"|format(info.age_hours) }}h)</span>
                                                {% elif info.is_usable %}
                                                    <span class="text-warning">⚠ Old ({{ "%.1f"|format(info.age_hours) }}h)</span>
                                                {% else %}
                                                    <span class="text-danger">✗ Expired</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">○ None</span>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                    <small class="text-muted d-block mt-2">Cache refreshes daily automatically. Use "Get Stats\Users" to refresh manually.</small>
                                </div>
                            </div>
                        {% endif %}

                        <div class="card mb-3" style="margin-top: 20px;">
                            <div class="card-header d-flex justify-content-between align-items-center" 
                                 style="cursor: pointer;" 
                                 onclick="document.getElementById('bcc-collapse').classList.toggle('d-none')">
                                <h5 class="mb-0">Email Recipients</h5>
                                <span id="bcc-toggle-icon" style="transition: transform 0.3s;">▼</span>
                            </div>
                            <div id="bcc-collapse" class="card-body">
                                <form method="POST" action="/send_email">
                                    <div class="mb-3">
                                        <label class="form-label">Email Lists:</label>
                                        <div class="d-flex gap-2 align-items-center">
                                            <select id="email_list_selector" class="form-select" style="flex: 1;">
                                                <option value="(Save new list)">(Save new list)</option>
                                                <option value="ALL">ALL</option>
                                                <option value="Custom" selected>Custom</option>
                                                {% for list in email_lists|sort(attribute='name') %}
                                                    <option value="{{ list.id }}" data-emails="{{ list.emails }}">{{ list.name }}</option>
                                                {% endfor %}
                                            </select>
                                            <button id="delete_list_btn" type="button" class="btn btn-sm btn-danger d-none">Delete</button>
                                        </div>
                                        
                                        <div id="save_list_container" class="mt-2 d-none">
                                            <div class="d-flex gap-2">
                                                <input type="text" id="new_list_name" class="form-control" placeholder="Enter list name" />
                                                <button id="save_list_btn" type="button" class="btn btn-sm btn-success">Save</button>
                                                <button id="cancel_save_btn" type="button" class="btn btn-sm btn-secondary">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <label class="form-label">BCC:</label>
                                    <div id="bcc_chips" class="nl-chips" role="listbox" aria-label="BCC recipients">
                                        <input id="email_chip_input"
                                                type="text"
                                                placeholder="Add BCC emails"
                                                aria-label="Add recipient" />
                                    </div>
                                    <textarea name="to_emails" id="to_emails" class="d-none">
                                        {{ user_dict.values() | join(', ') }}
                                    </textarea>
                                </form>
                            </div>
                        </div>

                        {% if not user_dict %}
                            <button id="pullRecsBtn" class="button opacity-50 cursor-not-allowed" disabled>Get Recommendations</button>
                        {% else %}
                            <button id="pullRecsBtn" class="button">Get Recommendations</button>
                        {% endif %}
                        <p>Note, recommendations take 20-25 seconds per user. After getting stats/users with the top button, recommendations will be pulled for users in the BCC list.</p>

                        <form method="POST" action="/send_email" style="margin-top: 0;">
                            Subject: <input type="text" name="subject" id="subject" placeholder="Subject"
                                        value="{{ settings.server_name }} News" style="width: 18rem;" required><br><br>
                        </form>
                    </td>
                    <td style="width: 40%; padding: 10px; vertical-align: top; position: sticky; top: 80px;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Preview:</span>
                            <button id="popout-preview-btn" class="btn button-outline btn-sm" title="Open preview in new window">
                                🗗 Pop-out
                            </button>
                        </div>
                        <iframe class="frame bg-black !important" id="preview"></iframe>
                    </td>
                    <td style="width: 60%; padding: 10px; vertical-align: top;">
                        <div id="selected-items-pane">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2>Snap-ins</h2>
                                <div class="d-flex gap-2 align-items-center">
                                    <button id="reset-template-btn" class="btn btn-outline-secondary btn-sm" title="Clear all items and reset to Custom template">
                                        🔄 Reset
                                    </button>
                                    <label for="template-selector" class="form-label mb-0">Template:</label>
                                    <select id="template-selector" class="form-select" style="width: 200px;">
                                        <option value="">Custom</option>
                                        <option value="save-template">(Save template)</option>
                                    </select>
                                    <button id="delete-template-btn" class="btn btn-outline-danger btn-sm" style="display: none;">
                                        🗑️ Delete
                                    </button>
                                </div>
                            </div>
                            <div id="selected-items-list" class="border rounded p-3 mb-4" style="min-height: 100px; background: #8acbd4;">
                                <div id="selected-items-empty" class="text-muted text-center py-3">
                                    No items selected. Use the buttons below to add items to your email.
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2>Text Blocks</h2>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn button-outline btn-sm" id="add-title-btn" title="Add a title block with large heading text">
                                        + Title
                                    </button>
                                    <button type="button" class="btn button-outline btn-sm" id="add-header-btn" title="Add a header block with medium heading text">
                                        + Header
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="add-intro-btn" title="Add introduction text about server membership">
                                        + Intro
                                    </button>
                                    <button type="button" class="btn button btn-sm" id="add-text-block-btn">
                                        + Text Block
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="add-outro-btn" title="Add closing thank you message">
                                        + Outro
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                {% if recent_data %}
                                    <h2>Recently Added</h2>
                                    <div id="ra-lib-list" class="row"></div>
                                {% endif %}
                            </div>
                            <div class="col-md-6" id="recs-col">
                                {% if recommendations_json %}
                                    <h2>Recommendations</h2>
                                    <div id="recs-user-list" class="row"></div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <h2>Plex Collections</h2>
                                <button type="button" class="btn button btn-sm mb-2" id="add-collection-group-btn">
                                    + Collection Group
                                </button>
                                <div class="row">
                                    <div class="col-md-4">
                                        <h5>📽️ Movie Collections</h5>
                                        <div class="d-flex align-items-center gap-2 mb-3">
                                            <select id="movie-collections-dropdown" class="form-select" style="flex: 1;">
                                                <option value="">Pick collection...</option>
                                            </select>
                                            <button id="add-movie-collection-btn" class="btn button btn-sm" disabled>
                                                Add
                                            </button>
                                        </div>
                                        <div id="movie-collections-loading" class="text-center d-none">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="ms-2">Loading movie collections...</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h5>📺 TV Show Collections</h5>
                                        <div class="d-flex align-items-center gap-2 mb-3">
                                            <select id="show-collections-dropdown" class="form-select" style="flex: 1;">
                                                <option value="">Pick collection...</option>
                                            </select>
                                            <button id="add-show-collection-btn" class="btn button btn-sm" disabled>
                                                Add
                                            </button>
                                        </div>
                                        <div id="show-collections-loading" class="text-center d-none">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="ms-2">Loading TV collections...</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h5>🎧 Audio Collections</h5>
                                        <div class="d-flex align-items-center gap-2 mb-3">
                                            <select id="audio-collections-dropdown" class="form-select" style="flex: 1;">
                                                <option value="">Pick collection...</option>
                                            </select>
                                            <button id="add-audio-collection-btn" class="btn button btn-sm" disabled>
                                                Add
                                            </button>
                                        </div>
                                        <div id="audio-collections-loading" class="text-center d-none">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="ms-2">Loading audio collections...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                {% if stats %}
                                    <h2>Available Stats</h2>
                                    <div class="row">
                                        {% for stat in stats %}
                                            <div class="col-12 mb-2">
                                                <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                                    <span style="font-size: 0.9rem;">{{ stat.stat_title }}</span>
                                                    <div>
                                                        <button type="button" class="btn button-outline btn-sm me-1 view-stat-btn" 
                                                                data-target="stat-{{ loop.index0 }}" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                                            View
                                                        </button>
                                                        <button type="button" class="btn button btn-sm add-stat-btn" 
                                                                data-id="stat-{{ loop.index0 }}" 
                                                                data-name="{{ stat.stat_title }}"
                                                                data-type="stat" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                                            Add
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <h2>Available Graphs</h2>
                                {% if graph_data != [{},{}] %}
                                    <div class="row">
                                        {% for graph in graph_data %}
                                            <div class="col-12 mb-2">
                                                <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                                    <span style="font-size: 0.9rem;">{{ graph_commands[loop.index0].name }}</span>
                                                    <div>
                                                        <button type="button" class="btn button-outline btn-sm me-1 view-graph-btn" 
                                                                data-target="graph-{{ loop.index0 }}" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                                            View
                                                        </button>
                                                        <button type="button" class="btn button btn-sm add-graph-btn" 
                                                                data-id="graph-{{ loop.index0 }}" 
                                                                data-name="{{ graph_commands[loop.index0].name }}"
                                                                data-type="graph" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                                            Add
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-info" style="font-size: 0.9rem; padding: 0.75rem;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        No graph data available. Click <strong>"Get Stats\Users"</strong> to load data.
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        {% if stats %}
                            <div id="stat-preview" class="mt-3" style="display: none;">
                                {% for stat in stats %}
                                    <div id="stat-{{ loop.index0 }}" class="stat-table d-none">
                                        <div class="card my-4">
                                            <div class="card-header bg-primary text-white">
                                                {{ stat.stat_title }}
                                            </div>
                                            <div class="card-body blur-container p-0">
                                                {% if stat.rows %}
                                                    {% if stat.rows[0].art != '' %}
                                                        <img src="/proxy-art{{ stat.rows[0].art }}" class="bg-blur" alt="" />
                                                    {% elif stat.rows[0].grandparent_thumb != '' %}
                                                        <img src="/proxy-art{{ stat.rows[0].grandparent_thumb }}" class="bg-blur" alt="" />
                                                    {% endif %}
                                                    <table class="table table-striped content-table m-0">
                                                        {% if stat.stat_title == "Most Watched Movies" or stat.stat_title == "Most Watched TV Shows" %}
                                                            <thead class="table-dark">
                                                                <tr>
                                                                    <th>Title</th>
                                                                    <th>Year</th>
                                                                    <th>Plays</th>
                                                                    <th>Hours Played</th>
                                                                    <th>Rating</th>
                                                                </tr>
                                                            </thead>
                                                        {% elif stat.stat_title == "Most Popular Movies" or stat.stat_title == "Most Popular TV Shows" %}
                                                            <thead class="table-dark">
                                                                <tr>
                                                                    <th>Title</th>
                                                                    <th>Year</th>
                                                                    <th>Plays</th>
                                                                    <th>Users</th>
                                                                    <th>Rating</th>
                                                                </tr>
                                                            </thead>
                                                        {% elif stat.stat_title == "Most Played Artists" %}
                                                            <thead class="table-dark">
                                                                <tr>
                                                                    <th>Author</th>
                                                                    <th>Year</th>
                                                                    <th>Plays</th>
                                                                    <th>Hours Played</th>
                                                                </tr>
                                                            </thead>
                                                        {% elif stat.stat_title == "Most Popular Artists" %}
                                                            <thead class="table-dark">
                                                                <tr>
                                                                    <th>Author</th>
                                                                    <th>Year</th>
                                                                    <th>Plays</th>
                                                                    <th>Users</th>
                                                                </tr>
                                                            </thead>
                                                        {% elif stat.stat_title == "Recently Watched" %}
                                                            <thead class="table-dark">
                                                                <tr>
                                                                    <th>Title</th>
                                                                    <th>Year</th>
                                                                    <th>Rating</th>
                                                                </tr>
                                                            </thead>
                                                        {% elif stat.stat_title == "Most Active Libraries" %}
                                                            <thead class="table-dark">
                                                                <tr>
                                                                    <th>Library</th>
                                                                    <th>Plays</th>
                                                                    <th>Hours Played</th>
                                                                </tr>
                                                            </thead>
                                                        {% elif stat.stat_title == "Most Active Users" %}
                                                            <thead class="table-dark">
                                                                <tr>
                                                                    <th>Username</th>
                                                                    <th>Plays</th>
                                                                    <th>Hours Played</th>
                                                                </tr>
                                                            </thead>
                                                        {% elif stat.stat_title == "Most Active Platforms" %}
                                                            <thead class="table-dark">
                                                                <tr>
                                                                    <th>Platform</th>
                                                                    <th>Plays</th>
                                                                    <th>Hours Played</th>
                                                                </tr>
                                                            </thead>
                                                        {% elif stat.stat_title == "Most Concurrent Streams" %}
                                                            <thead class="table-dark">
                                                                <tr>
                                                                    <th>Category</th>
                                                                    <th>Count</th>
                                                                </tr>
                                                            </thead>
                                                        {% endif %}
                                                        <tbody>
                                                            {% for row in stat.rows %}
                                                                <tr>
                                                                    {% if stat.stat_title == "Most Active Libraries" %}
                                                                        <td>{{ row.section_name }}</td>
                                                                    {% elif stat.stat_title == "Most Active Users" %}
                                                                        <td>{{ row.user }}</td>
                                                                    {% elif stat.stat_title == "Most Active Platforms" %}
                                                                        <td>{{ row.platform }}</td>
                                                                    {% else %}
                                                                        <td>{{ row.title }}</td>
                                                                    {% endif %}

                                                                    {% if stat.stat_title == "Most Active Libraries" or stat.stat_title == "Most Active Users" or stat.stat_title == "Most Active Platforms" or stat.stat_title == "Most Concurrent Streams" %}
                                                                    {% else %}
                                                                        <td>{{ row.year }}</td>
                                                                    {% endif %}

                                                                    {% if "Recently" in stat.stat_title %}
                                                                    {% elif "Concurrent" in stat.stat_title %}
                                                                    {% else %}
                                                                        <td>{{ row.total_plays }}</td>
                                                                    {% endif %}

                                                                    {% if stat.stat_title == "Most Watched Movies" or stat.stat_title == "Most Watched TV Shows" or stat.stat_title == "Most Played Artists" or stat.stat_title == "Most Active Libraries" or stat.stat_title == "Most Active Users" or stat.stat_title == "Most Active Platforms" %}
                                                                        <td>{{ (row.total_duration / 3600) | round(0, 'ceil')  | int }}</td>
                                                                    {% elif stat.stat_title == "Most Popular Movies" or stat.stat_title == "Most Popular TV Shows" or stat.stat_title == "Most Popular Artists" %}
                                                                        <td>{{ row.users_watched }}</td>
                                                                    {% endif %}

                                                                    {% if stat.stat_title == "Most Active Libraries" or stat.stat_title == "Most Played Artists" or stat.stat_title == "Most Popular Artists" or stat.stat_title == "Most Active Users" or stat.stat_title == "Most Active Platforms" or stat.stat_title == "Most Concurrent Streams" %}
                                                                    {% else %}
                                                                        <td>{{ row.content_rating }}</td>
                                                                    {% endif %}

                                                                    {% if stat.stat_title == "Most Concurrent Streams" %}
                                                                        <td>{{ row.count }}</td>
                                                                    {% endif %}
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                {% else %}
                                                    <p class="m-3">No data available.</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if graph_data != [{},{}] %}
                            <div id="graph-preview" class="mt-3" style="display: none;">
                                {% for graph in graph_data %}
                                    <div class="graph-table d-none" id="graph-{{ loop.index0 }}"></div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if recent_data %}
                            <div id="ra-preview" class="mt-3" style="display: none;">
                                <div class="card my-4">
                                    <div class="card-header bg-primary">Recently Added</div>
                                    <div class="card-body">
                                        <ul id="ra-view" class="grid grid-cols-10 gap-3" style="margin: 0; padding: 0;"></ul>
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                        <div id="recs-preview" class="mt-3" style="display: none;">
                            {% if recommendations_json %}
                                <div class="card my-4">
                                    <div class="card-header bg-primary">Recommendations</div>
                                    <div class="card-body"></div>
                                </div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        <script>
            const recentPayload = {{ recent_data | tojson }};

            function buildThumb(path) {
                if (!path) return '';
                const p = path.startsWith('/') ? path : '/' + path;
                return `/proxy-art${p}`;
            }

            function pickThumb(it) {
                const type = (it.media_type || it.type || '').toLowerCase();

                const candidates = (type === 'episode' || type === 'season')
                    ? [it.grandparent_thumb, it.parent_thumb, it.thumb, it.art]
                    : [it.thumb, it.art, it.parent_thumb, it.grandparent_thumb];

                return candidates.find(Boolean) || '';
            }

            const flatten = (arr) => arr.flatMap(x => x?.recently_added || []);
            const msToHMS = (ms) => {
                ms = parseInt(ms || 0, 10);
                const s = Math.round(ms / 1000);
                const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
                return h ? `${h}h ${m}m` : `${m}m`;
            };
            const formatDate = (d) => {
                if (!d) return '';
                if (/^\d+$/.test(String(d))) return new Date(parseInt(d,10)*1000).toLocaleDateString();
                const dt = new Date(d); return isNaN(dt) ? '' : dt.toLocaleDateString();
            };

            const items = flatten(recentPayload).map(it => {
                const title = it.title || it.full_title || it.parent_title || it.grandparent_title || '(untitled)';
                const sub = it.year || it.grandparent_title || it.parent_title || '';
                const thumbPath = pickThumb(it);

                const item_type = (it.media_type || it.type || '').toLowerCase();
                let summary = '';
                if (item_type === 'episode' || item_type === 'season') {
                    summary = it.grandparent_tagline || it.grandparent_summary || it.parent_summary || it.tagline || it.summary || '';
                } else {
                    summary = it.tagline || it.summary || '';
                }

                return {
                    library: it.library_name || it.section_name || it.media_type || '',
                    title,
                    sub,
                    summary: summary,
                    duration: msToHMS(it.duration),
                    added: formatDate(it.added_at || it.originally_available_at),
                    thumb: thumbPath
                };
            });

            const slug = s => String(s || '').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

            function renderRAGrid(list, target) {
                target.innerHTML = '';
                list.forEach(it => {
                    const imgURL = it.thumb ? `/proxy-art${it.thumb.startsWith('/')?it.thumb:('/'+it.thumb)}` : '';
                    const li = document.createElement('li');
                    li.className = "group rounded-2xl overflow-hidden bg-[#8acbd4] dark:bg-[#333] ";
                    li.innerHTML = `
                        <div class="relative aspect-[2/3] bg-gray-200 dark:bg-gray-700">
                        ${imgURL ? `<img loading="lazy" src="${imgURL}" class="h-full w-full object-cover">` : ''}
                        ${it.library ? `<div class="ra-pill absolute top-1 right-1 text-xs px-2 py-1 rounded-full bg-black/70 text-white"><span class="pill_text">${it.library}</span></div>` : ''}
                        ${it.added ? `<div class="ra-pill absolute bottom-1 right-1 text-[11px] text-white/90"><span class="bg-black/60 rounded px-1.5 py-0.5"><span class="pill_text">${it.added}</span></span></div>` : ''}
                        </div>
                        <div class="p-3">
                        <div class="font-semibold line-clamp-2 text-[#333] dark:text-[#8acbd4]">${it.title}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${it.sub ? it.sub + ' • ' : ''}${it.duration}</div>
                        ${it.summary ? `<div class="mt-2 text-xs text-gray-600 dark:text-gray-300 line-clamp-5">${it.summary}</div>` : ''}
                        </div>`;
                    target.appendChild(li);
                });
            }

            (function buildRALibraryRows() {
                const libs = [...new Set(items.map(i => i.library).filter(Boolean))].sort();
                const host = document.getElementById('ra-lib-list');
                if (!host) return;

                libs.forEach(lib => {
                    const row = document.createElement('div');
                    row.className = 'col-12 mb-2';
                    const id = `ra-lib-${slug(lib)}`;

                    row.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                            <span style="font-size: .9rem;">${lib}</span>
                            <div>
                                <button type="button" class="btn button-outline btn-sm me-1 ra-view-btn" 
                                        data-lib="${lib}" data-target="${id}" style="font-size: .8rem; padding: .25rem .5rem;">
                                View
                                </button>
                                <button type="button" class="btn button btn-sm ra-add-btn" 
                                        data-type="ra" data-lib="${lib}" data-id="${id}" data-name="Recently Added: ${lib}"
                                        style="font-size: .8rem; padding: .25rem .5rem;">
                                Add
                                </button>
                            </div>
                        </div>`;
                    host.appendChild(row);
                });
            })();

            const libSel = document.getElementById('ra-lib');
            [...new Set(items.map(i => i.library).filter(Boolean))].sort().forEach(lib => {
                const opt = document.createElement('option');
                opt.value = lib; opt.textContent = lib;
                libSel.appendChild(opt);
            });

            const grid = document.getElementById('ra-grid');
            const empty = document.getElementById('ra-empty');

            function render(list) {
                grid.innerHTML = '';
                list.forEach(it => {
                    const imgURL = buildThumb(it.thumb);
                    const li = document.createElement('li');
                    li.className = "group rounded-2xl overflow-hidden bg-[#8acbd4] dark:bg-[#333] " + 
                    "!shadow-[0_6px_18px_rgba(0, 0, 0, 0.6)] hover:!shadow-[0_10px_28px_rgba(0, 0, 0, 0.6)] " + 
                    "dark:!shadow-[0_6px_18px_rgba(74, 127, 130, 0.6)] dark:hover:!shadow-[0_10px_28px_rgba(74, 127, 130, 0.6)]";
                    li.dataset.lib = it.library;
                    li.innerHTML = `
                        <style>
                            .ra-pill{ display:inline-flex; align-items:center; justify-content:center; line-height:1; }
                        </style>
                        <div class="relative aspect-[2/3] bg-gray-200 dark:bg-gray-700">
                            ${imgURL ? `<img loading="lazy" src="${imgURL}" class="h-full w-full object-cover">` : ''}
                            ${it.library ? `<div class="ra-pill absolute top-1 right-1 text-xs px-2 py-1 rounded-full bg-black/70 text-white"><span class="pill_text">${it.library}</span></div>` : ''}
                            ${it.added ? `<div class="ra-pill absolute bottom-1 right-1 text-[11px] text-white/90 bg-black/60 rounded px-1.5 py-0.5"><span class="pill_text">${it.added}</span></div>` : ''}
                        </div>
                        <div class="p-3">
                            <div class="font-semibold line-clamp-2">${it.title}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                ${it.sub ? it.sub + ' • ' : ''}${it.duration}
                            </div>
                            ${it.summary ? `<div class="mt-2 text-xs text-gray-600 dark:text-gray-300 line-clamp-5">${it.summary}</div>` : ''}
                        </div>
                    `;
                    grid.appendChild(li);
                });
                empty.classList.toggle('hidden', list.length !== 0);
            }

            function applyFilter() {
                const lb = libSel.value;
                if (lb === '') { render([], { showEmpty:false }); return; }
                if (lb === '__ALL__') { render(items); return; }
                render(items.filter(it => it.library === lb));
            }

            libSel.addEventListener('input', applyFilter);
        </script>
        <script>
            document.getElementById('time_range_week').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 7;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_month').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 30;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_quarter').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 90;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_two_q').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 180;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_three_q').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 270;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_year').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 365;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
        </script>
        <script>
            let selectedItems = [];
            const statsList = {{ stats | tojson }};
            const themeSettings = {{ theme_settings | tojson }};

            function getThemedEmailCSS() {
                const emailTheme = themeSettings.email_theme || 'newsletter_blue';
                const isDark = document.documentElement.classList.contains('dark');
                
                let bgColor, textColor, cardBg, borderColor, mutedColor;
                
                bgColor = themeSettings.background_color || '#333333';
                textColor = themeSettings.text_color || '#62a1a4';
                cardBg = '#2d2d2d';
                borderColor = '#404040';
                mutedColor = '#cccccc';
                
                const primaryColor = themeSettings.primary_color || '#8acbd4';
                const secondaryColor = themeSettings.secondary_color || '#222222';
                const accentColor = themeSettings.accent_color || '#62a1a4';
                const logoWidth = "{{ settings.logo_width or 80 }}";
                
                return `
                    <style>
                        @import url(https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400,700&display=swap);

                        :root {
                            --email-bg: ${bgColor};
                            --email-text: ${textColor};
                            --email-primary: ${primaryColor};
                            --email-secondary: ${secondaryColor};
                            --email-accent: ${accentColor};
                            --email-card-bg: ${cardBg};
                            --email-border: ${borderColor};
                            --email-muted: ${mutedColor};
                        }
                        
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'IBM Plex Sans';
                            background-color: var(--email-bg);
                            line-height: 1.6;
                            color: var(--email-text);
                        }
                        
                        .email-container {
                            width: 100%;
                            background: var(--email-card-bg);
                            border-radius: 8px;
                            overflow: hidden;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                            border: 1px solid var(--email-border);
                        }
                        
                        .email-header {
                            background: linear-gradient(135deg, var(--email-accent) 0%, var(--email-primary) 100%);
                            color: white;
                            padding: 10px 20px;
                            text-align: center;
                        }
                        
                        .email-logo {
                            max-width: ${logoWidth}px;
                            height: auto;
                        }
                        
                        .email-title {
                            font-size: 28px;
                            font-weight: bold;
                            margin: 0;
                            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                        }
                        
                        .email-content {
                            padding: 10px 15px;
                            color: var(--email-text);
                            background: var(--email-card-bg);
                        }
                        
                        .email-footer {
                            background: var(--email-secondary);
                            padding: 20px;
                            text-align: center;
                            border-top: 3px solid var(--email-primary);
                            color: var(--email-muted);
                            font-size: 12px;
                        }
                        
                        .email-footer a {
                            color: var(--email-accent);
                            text-decoration: none;
                        }
                        
                        .stats-card {
                            margin: 20px 0;
                            border-radius: 8px;
                            overflow: hidden;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                            border: 1px solid var(--email-border);
                            position: relative;
                        }
                        
                        .stats-bg-blur {
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background-size: cover;
                            background-position: center;
                            background-repeat: no-repeat;
                            filter: blur(5px) brightness(1);
                            z-index: 0;
                        }
                        
                        .stats-overlay {
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0, 0, 0, 0.3);
                            z-index: 1;
                        }
                        
                        .stats-content {
                            position: relative;
                            z-index: 2;
                        }
                        
                        .stats-header {
                            background: var(--email-bg);
                            color: var(--email-primary);
                            padding: 15px;
                            text-align: center;
                            font-weight: bold;
                            font-size: 18px;
                        }
                        
                        .stats-table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        
                        .stats-table th {
                            padding: 12px;
                            background: rgba(52, 58, 64, 0.9);
                            color: white;
                            font-weight: bold;
                            border: none;
                        }
                        
                        .stats-table td {
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.5);
                            color: #333;
                            border-bottom: 1px solid rgba(222, 226, 230, 0.8);
                        }
                        
                        .recently-added {
                            background: var(--email-card-bg);
                            padding-bottom: 10px;
                            border-radius: 8px;
                            margin: 20px 0;
                            border: 1px solid var(--email-border);
                        }
                        
                        .recently-added h2 {
                            text-align: center;
                            color: var(--email-text);
                            margin-bottom: 10px;
                            margin-top: 0;
                        }
                        
                        .recommendations-block {
                            margin: 30px 0;
                            padding: 20px;
                            background: var(--email-card-bg);
                            border-radius: 8px;
                            border: 1px solid var(--email-border);
                        }
                        
                        .recommendations-block h2, .recommendations-block h3 {
                            color: var(--email-text);
                        }
                        
                        .chart-placeholder {
                            margin: 20px 0;
                            padding: 30px;
                            background: var(--email-card-bg);
                            border: 2px dashed var(--email-border);
                            border-radius: 8px;
                            text-align: center;
                        }
                        
                        .chart-placeholder h3, .chart-placeholder p {
                            color: var(--email-muted);
                        }
                    </style>
                `;
            }

            async function updatePreview() {
                try {
                    console.log('updatePreview called with selectedItems:', selectedItems);
                    
                    if (typeof selectedItems === 'undefined') {
                        console.error('selectedItems is undefined in updatePreview');
                        return;
                    }
                    
                    const serverName = "{{ settings.server_name }}";
                    const subject = document.getElementById('subject').value;
                    const logoFilename = "{{ settings.logo_filename }}";
                    const logoWidth = "{{ settings.logo_width }}";
                    const customLogoFilename = "{{ settings.custom_logo_filename }}"
                    const themedCSS = getThemedEmailCSS();

                    let contentHTML = "";
                    
                    for (let item of selectedItems) {
                        if (item.type === 'textblock') {
                            const content = getTextBlockContent(item.id);
                            if (content && content.trim().length > 0) {
                                const formattedContent = content.trim().replace(/\n/g, "<br>");
                                contentHTML += `<div style="margin-bottom: 15px; line-height: 1.6; text-align: center; color: var(--email-text);">${formattedContent}</div>`;
                            }
                        } else if (item.type === 'headerblock') {
                            const content = getTextBlockContent(item.id);
                            if (content && content.trim().length > 0) {
                                const formattedContent = content.trim().replace(/\n/g, "<br>");
                                contentHTML += `<div style="margin-bottom: 20px; font-size: 1.5em; font-weight: bold; text-align: center; color: var(--email-text);">${formattedContent}</div>`;
                            }
                        } else if (item.type === 'titleblock') {
                            const content = getTextBlockContent(item.id);
                            if (content && content.trim().length > 0) {
                                const formattedContent = content.trim().replace(/\n/g, "<br>");
                                contentHTML += `<div style="margin-bottom: 20px; font-size: 2em; font-weight: bold; text-align: center; color: var(--email-text);">${formattedContent}</div>`;
                            }
                        } else if (item.type === 'stat') {
                            contentHTML += buildStatPreviewHTML(item.id);
                        } else if (item.type === 'graph') {
                            contentHTML += buildGraphPreviewHTML(item.id);
                        } else if (item.type === 'ra') {
                            contentHTML += buildRecentlyAddedPreviewHTML(item.raLibrary);
                        } else if (item.type === 'recs') {
                            contentHTML += buildRecommendationsPreviewHTML(item.userKey);
                        } else if (item.type === 'collection_group') {
                            if (item.collections && item.collections.length > 0) {
                                contentHTML += buildCollectionPreviewHTMLForEmail(
                                    item.title || 'Collections', 
                                    item.collections
                                );
                            }
                        }
                    }

                    const completeHTML = buildPreviewEmailHTML(contentHTML, serverName, subject, logoFilename, logoWidth, customLogoFilename, themedCSS);
                    
                    const frame = document.getElementById('preview');
                    if (!frame) {
                        console.error('Preview iframe not found!');
                        return;
                    }
                    
                    frame.srcdoc = completeHTML;
                    
                    frame.onload = function() {
                        try {
                            const doc = frame.contentDocument || frame.contentWindow.document;
                            if (doc && doc.documentElement) {
                                resizePreviewFrame(frame);
                            }
                        } catch (e) {
                            console.log('Could not resize iframe:', e);
                        }
                    };
                    
                    console.log('Preview updated successfully');
                } catch (error) {
                    console.error('Error in updatePreview:', error);
                    const frame = document.getElementById('preview');
                    if (frame) {
                        frame.srcdoc = `<html><body><p>Error updating preview: ${error.message}</p></body></html>`;
                    }
                }
            }

            function buildStatPreviewHTML(statId) {
                const statIndex = parseInt(statId.split('-')[1]);
                
                if (!statsList || !Array.isArray(statsList) || statIndex >= statsList.length) {
                    console.warn(`Stat index ${statIndex} not found in stats array`);
                    return `<div class="stats-card"><div class="stats-content"><div class="stats-header">Statistics data not available</div></div></div>`;
                }
                
                const stat = statsList[statIndex];
                if (!stat || !stat.rows || !Array.isArray(stat.rows)) {
                    console.warn(`Stat data invalid for index ${statIndex}`);
                    return `<div class="stats-card"><div class="stats-content"><div class="stats-header">Statistics data not available</div></div></div>`;
                }
                
                const title = stat.stat_title || 'Statistics';
                const rows = stat.rows;
                
                let backgroundElements = '';
                if (rows.length > 0) {
                    const artwork = rows[0].art || rows[0].grandparent_thumb;
                    if (artwork) {
                        const artworkUrl = `/proxy-art${artwork}`;
                        backgroundElements = `
                            <div class="stats-bg-blur" style="background-image: url('${artworkUrl}');"></div>
                            <div class="stats-overlay"></div>
                        `;
                    }
                }

                function getStatHeaders(title) {
                    if (title === "Most Watched Movies" || title === "Most Watched TV Shows") {
                        return ["Title", "Year", "Plays", "Hours Played", "Rating"];
                    } else if (title === "Most Popular Movies" || title === "Most Popular TV Shows") {
                        return ["Title", "Year", "Plays", "Users", "Rating"];
                    } else if (title === "Most Played Artists") {
                        return ["Author", "Year", "Plays", "Hours Played"];
                    } else if (title === "Most Popular Artists") {
                        return ["Author", "Year", "Plays", "Users"];
                    } else if (title === "Recently Watched") {
                        return ["Title", "Year", "Rating"];
                    } else if (title === "Most Active Libraries") {
                        return ["Library", "Plays", "Hours Played"];
                    } else if (title === "Most Active Users") {
                        return ["Username", "Plays", "Hours Played"];
                    } else if (title === "Most Active Platforms") {
                        return ["Platform", "Plays", "Hours Played"];
                    } else if (title === "Most Concurrent Streams") {
                        return ["Category", "Count"];
                    }
                    return ["Title", "Value"];
                }
                
                function getStatCells(title, row) {
                    const cells = [];
                    
                    if (title === "Most Active Libraries") {
                        cells.push(row.section_name || '');
                    } else if (title === "Most Active Users") {
                        cells.push(row.user || '');
                    } else if (title === "Most Active Platforms") {
                        cells.push(row.platform || '');
                    } else {
                        cells.push(row.title || '');
                    }
                    
                    const skipYearStats = ["Most Active Libraries", "Most Active Users", "Most Active Platforms", "Most Concurrent Streams"];
                    if (!skipYearStats.includes(title)) {
                        cells.push(row.year || '');
                    }
                    
                    if (!title.includes("Recently") && !title.includes("Concurrent")) {
                        cells.push(row.total_plays || 0);
                    }
                    
                    const hoursStats = ["Most Watched Movies", "Most Watched TV Shows", "Most Played Artists", "Most Active Libraries", "Most Active Users", "Most Active Platforms"];
                    const usersStats = ["Most Popular Movies", "Most Popular TV Shows", "Most Popular Artists"];
                    
                    if (hoursStats.includes(title)) {
                        const hours = Math.ceil((row.total_duration || 0) / 3600);
                        cells.push(hours);
                    } else if (usersStats.includes(title)) {
                        cells.push(row.users_watched || '');
                    }
                    
                    const skipRatingStats = ["Most Active Libraries", "Most Played Artists", "Most Popular Artists", "Most Active Users", "Most Active Platforms", "Most Concurrent Streams"];
                    if (!skipRatingStats.includes(title)) {
                        cells.push(row.content_rating || '');
                    }
                    
                    if (title === "Most Concurrent Streams") {
                        cells.push(row.count || 0);
                    }
                    
                    return cells;
                }
                
                const headers = getStatHeaders(title);
                const headerHTML = headers.map(h => `<th>${h}</th>`).join('');
                
                const rowsHTML = rows.map(row => {
                    const cells = getStatCells(title, row);
                    const cellsHTML = cells.map(cell => `<td>${cell}</td>`).join('');
                    return `<tr>${cellsHTML}</tr>`;
                }).join('');
                
                return `
                    <div class="stats-card">
                        ${backgroundElements}
                        <div class="stats-content">
                            <div class="stats-header">${title}</div>
                            <table class="stats-table">
                                <thead><tr>${headerHTML}</tr></thead>
                                <tbody>${rowsHTML}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            function buildGraphPreviewHTML(graphId) {
                const graphIndex = parseInt(graphId.split('-')[1]);
                
                if (graphIndex >= graphCommands.length || graphIndex >= graphDataList.length) {
                    return `
                        <div style="margin: 20px 0; padding: 30px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; text-align: center;">
                            <h3 style="color: #6c757d; margin-bottom: 10px;">Graph data not available</h3>
                            <p style="color: #6c757d; margin: 0; font-size: 14px;">Index ${graphIndex} out of range</p>
                        </div>
                    `;
                }
                
                const commandInfo = graphCommands[graphIndex];
                const graphData = graphDataList[graphIndex];
                
                if (!graphData || (!graphData.categories && !graphData.series)) {
                    return `
                        <div style="margin: 20px 0; padding: 30px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; text-align: center;">
                            <h3 style="color: #6c757d; margin-bottom: 10px;">${commandInfo.name}</h3>
                            <p style="color: #6c757d; margin: 0; font-size: 14px;">No chart data available</p>
                            <p style="color: #6c757d; margin: 5px 0 0; font-size: 12px; font-style: italic;">Interactive charts available in dashboard</p>
                        </div>
                    `;
                }
                
                let chart = Highcharts.charts.find(c => c && c.renderTo.id === graphId);
                
                if (!chart) {
                    const possibleIds = [
                        graphId,
                        `chart-${graphIndex}`,
                        `graph-${graphIndex}`,
                        `preview-${graphId}`,
                        graphId.replace('graph-', 'chart-')
                    ];
                    
                    for (const id of possibleIds) {
                        chart = Highcharts.charts.find(c => c && c.renderTo.id === id);
                        if (chart) break;
                    }
                }
                
                if (!chart) {
                    console.log('No existing chart found for', graphId, ', creating one...');
                    
                    const tempContainer = document.createElement('div');
                    tempContainer.id = `temp-${graphId}-${Date.now()}`;
                    tempContainer.style.cssText = 'position: fixed; left: -9999px; top: -9999px; width: 800px; height: 400px;';
                    document.body.appendChild(tempContainer);
                    
                    try {
                        chart = Highcharts.chart(tempContainer.id, {
                            chart: { type: 'line' },
                            title: { text: commandInfo.name },
                            exporting: { enabled: true },
                            xAxis: { categories: graphData.categories },
                            yAxis: { title: { text: 'Plays' } },
                            series: graphData.series
                        });
                        
                        renderedCharts.add(graphId);
                        const nowDark = document.documentElement.classList.contains('dark');
                        applyChartTheme(nowDark);
                        
                        console.log('Auto-created chart for preview:', graphId);
                    } catch (error) {
                        console.error('Error creating chart for preview:', error);
                        document.body.removeChild(tempContainer);
                        return `
                            <div style="margin: 20px 0; padding: 30px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; text-align: center;">
                                <h3 style="color: #6c757d; margin-bottom: 10px;">${commandInfo.name}</h3>
                                <p style="color: #6c757d; margin: 0; font-size: 14px;">Error creating chart</p>
                                <p style="color: #6c757d; margin: 5px 0 0; font-size: 12px; font-style: italic;">Try clicking "View" first to render the chart</p>
                            </div>
                        `;
                    }
                }
                
                if (chart) {
                    try {
                        const svg = chart.getSVG();
                        
                        const svgBlob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
                        const svgUrl = URL.createObjectURL(svgBlob);
                        
                        const tempElements = document.querySelectorAll(`[id^="temp-${graphId}"]`);
                        tempElements.forEach(el => {
                            if (el.parentNode) el.parentNode.removeChild(el);
                        });
                        
                        return `
                            <div style="width: 100%; border-radius: 4px; text-align: center;">
                                <img src="${svgUrl}" style="max-width: 100%; height: auto; border-radius: 4px;" alt="${commandInfo.name}" onload="URL.revokeObjectURL(this.src)">
                            </div>
                        `;
                        
                    } catch (error) {
                        console.error('Error processing graph', graphId, error);
                        
                        const tempElements = document.querySelectorAll(`[id^="temp-${graphId}"]`);
                        tempElements.forEach(el => {
                            if (el.parentNode) el.parentNode.removeChild(el);
                        });
                    }
                }
                
                return `
                    <div style="margin: 20px 0; padding: 30px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; text-align: center;">
                        <h3 style="color: #6c757d; margin-bottom: 10px;">${commandInfo.name}</h3>
                        <p style="color: #6c757d; margin: 0; font-size: 14px;">Chart rendering failed</p>
                        <p style="color: #6c757d; margin: 5px 0 0; font-size: 12px; font-style: italic;">Try clicking "View" in the dashboard to render the chart first</p>
                    </div>
                `;
            }

            function buildRecentlyAddedPreviewHTML(libraryFilter) {
                if (!recentPayload || recentPayload.length === 0) {
                    return `<div class="recently-added"><p style="text-align: center; color: var(--email-muted); padding: 20px;">No recently added items available</p></div>`;
                }
                
                let allItems = [];
                recentPayload.forEach(section => {
                    if (section && section.recently_added) {
                        allItems = allItems.concat(section.recently_added);
                    }
                });
                
                if (libraryFilter) {
                    allItems = allItems.filter(item => 
                        item.library_name && item.library_name.toLowerCase().includes(libraryFilter.toLowerCase())
                    );
                }

                const seenShows = new Set();
                const deduplicated = [];
                
                for (const item of allItems) {
                    const itemType = (item.media_type || item.type || '').toLowerCase();
                    
                    if (itemType === 'episode' || itemType === 'season') {
                        const showId = item.grandparent_rating_key || item.grandparent_title;
                        
                        if (showId && !seenShows.has(showId)) {
                            seenShows.add(showId);
                            const displayItem = { ...item };
                            displayItem.original_title = item.title;
                            displayItem.title = item.grandparent_title || item.title;
                            deduplicated.push(displayItem);
                        }
                    } else {
                        deduplicated.push(item);
                    }
                }
                
                allItems = deduplicated;
                
                if (allItems.length === 0) {
                    return `<div class="recently-added"><p style="text-align: center; color: var(--email-muted); padding: 20px;">No recently added items found${libraryFilter ? ` for ${libraryFilter}` : ''}</p></div>`;
                }
                
                const gridItems = allItems.map(item => {
                    const title = item.title || item.full_title || item.parent_title || item.grandparent_title || '(untitled)';
                    const sub = item.year || item.grandparent_title || item.parent_title || '';
                    const thumbPath = pickThumb(item);
                    const duration = msToHMS(item.duration);
                    const added = formatDate(item.added_at || item.originally_available_at);
                    const library = item.library_name || item.section_name || '';
                    
                    return {
                        title,
                        sub,
                        summary: item.tagline || item.summary || '',
                        duration,
                        added,
                        thumb: thumbPath,
                        library
                    };
                });
                
                const itemsHTML = gridItems.map(item => {
                    const imgURL = item.thumb ? `/proxy-art${item.thumb.startsWith('/') ? item.thumb : '/' + item.thumb}` : '/static/img/no-poster.png';
                    
                    return `
                        <div style="
                            position: relative;
                            background: var(--email-card-bg);
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
                            border: 1px solid var(--email-border);
                            width: 100%;
                            max-width: 200px;
                            margin: 0 auto;
                        ">
                            <div style="position: relative; aspect-ratio: 2/3; background: #f8f9fa;">
                                <img src="${imgURL}" style="width: 100%; height: 100%; object-fit: cover; display: block;" alt="${item.title}">
                                ${item.added ? `
                                    <div style="
                                        position: absolute;
                                        bottom: 1px;
                                        right: 1px;
                                        background: rgba(0, 0, 0, 0.6);
                                        color: rgba(255, 255, 255, 0.9);
                                        padding: 2px 6px;
                                        border-radius: 4px;
                                        font-size: 9px;
                                        line-height: 1;
                                    ">${item.added}</div>
                                ` : ''}
                            </div>
                            <div style="padding: 12px;">
                                <div style="font-weight: bold; font-size: 14px; color: var(--email-text); margin-bottom: 4px; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                    ${item.title}
                                </div>
                                <div style="font-size: 11px; color: var(--email-muted); margin-bottom: 8px;">
                                    ${item.sub ? item.sub + ' • ' : ''}${item.duration}
                                </div>
                                ${item.summary ? `
                                    <div style="font-size: 11px; color: var(--email-text); opacity: 0.8; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden;">
                                        ${item.summary}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="recently-added">
                        <h2>Recently Added${libraryFilter ? ` - ${libraryFilter}` : ''}</h2>
                        <div style="
                            display: grid;
                            grid-template-columns: repeat(5, 1fr);
                            gap: 12px;
                            margin: 15px auto 0 auto;
                            padding: 0;
                            width: 80%;
                        ">
                            ${itemsHTML}
                        </div>
                    </div>
                `;
            }

            function buildRecommendationsPreviewHTML(userKey) {
                if (!recsPayload || !userKey || !recsPayload[userKey]) {
                    return `<div class="recommendations-block"><p style="text-align: center; color: var(--email-muted); padding: 20px;">No recommendations available for this user</p></div>`;
                }
                
                const userRecs = recsPayload[userKey];
                const userEmail = userDict[userKey] || userKey;
                
                let sectionsHTML = '';
                
                if (userRecs.movie_posters && userRecs.movie_posters.length > 0) {
                    sectionsHTML += buildRecommendationsSectionHTML(
                        userRecs.movie_posters.slice(0, 20), 
                        userRecs.movie_posters_unavailable?.slice(0, 20) || [], 
                        'Recommended Movies'
                    );
                }
                
                if (userRecs.show_posters && userRecs.show_posters.length > 0) {
                    sectionsHTML += buildRecommendationsSectionHTML(
                        userRecs.show_posters.slice(0, 20), 
                        userRecs.show_posters_unavailable?.slice(0, 20) || [], 
                        'Recommended TV Shows'
                    );
                }
                
                if (!sectionsHTML) {
                    return `<div class="recommendations-block"><p style="text-align: center; color: var(--email-muted); padding: 20px;">No recommendations for ${userEmail}</p></div>`;
                }
                
                return `
                    <div class="recommendations-block" data-recs-user="${userKey}">
                        <h2>Recommendations for ${userEmail}</h2>
                        ${sectionsHTML}
                    </div>
                `;
            }

            function buildRecommendationsSectionHTML(availableItems, unavailableItems, title) {
                const allItems = [...availableItems, ...unavailableItems];
                
                const itemsHTML = allItems.map((item, index) => {
                    const isUnavailable = index >= availableItems.length;
                    const posterURL = item.url ? `/proxy-img?u=${encodeURIComponent(item.url)}` : '/static/img/no-poster.png';
                    const titleText = item.title || 'Unknown';
                    const year = item.year || '';
                    const vote = item.vote ? `★ ${item.vote.toFixed(1)}` : '';
                    const href = item.href || '#';
                    const overview = item.overview || '';
                    const runtime = item.runtime || '';
                    
                    const unavailableStyle = isUnavailable ? 'opacity: 0.7; filter: grayscale(30%);' : '';
                    
                    return `
                        <div style="
                            position: relative;
                            background: var(--email-card-bg);
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            border: 1px solid var(--email-border);
                            ${unavailableStyle}
                            width: 100%;
                            max-width: 200px;
                            margin: 0 auto;
                        ">
                            <a href="${href}" style="text-decoration: none; color: inherit; display: block;" target="_blank">
                                <div style="position: relative; aspect-ratio: 2/3; background: #f8f9fa;">
                                    <img src="${posterURL}" style="width: 100%; height: 100%; object-fit: cover; display: block;" alt="${titleText}">
                                    
                                    ${(year || vote) ? `
                                        <div style="
                                            position: absolute;
                                            top: 1px;
                                            left: 1px;
                                            background: rgba(0, 0, 0, 0.7);
                                            color: white;
                                            padding: 2px 6px;
                                            border-radius: 4px;
                                            font-size: 9px;
                                            line-height: 1;
                                        ">${year} ${vote}</div>
                                    ` : ''}
                                    
                                    ${isUnavailable ? `
                                        <div style="
                                            position: absolute;
                                            top: 16px;
                                            left: 1px;
                                            background: rgba(255, 0, 0, 0.8);
                                            color: white;
                                            padding: 2px 6px;
                                            border-radius: 4px;
                                            font-size: 9px;
                                            line-height: 1;
                                        ">Unavailable</div>
                                    ` : ''}
                                    
                                    <div style="
                                        position: absolute;
                                        bottom: 0;
                                        left: 0;
                                        right: 0;
                                        padding: 8px;
                                        background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
                                    ">
                                        <div style="font-weight: bold; font-size: 12px; color: white; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                            ${titleText}
                                        </div>
                                        ${runtime ? `<div style="font-size: 10px; color: rgba(255, 255, 255, 0.8); margin-top: 2px;">${runtime}</div>` : ''}
                                    </div>
                                </div>
                            </a>
                            
                            ${overview ? `
                                <div style="
                                    position: absolute;
                                    left: 0;
                                    right: 0;
                                    bottom: 0;
                                    transform: translateY(100%);
                                    transition: transform 0.3s ease;
                                    background: rgba(0, 0, 0, 0.8);
                                    color: white;
                                    padding: 8px;
                                    font-size: 10px;
                                    line-height: 1.3;
                                    display: -webkit-box;
                                    -webkit-line-clamp: 3;
                                    -webkit-box-orient: vertical;
                                    overflow: hidden;
                                " 
                                onmouseover="this.style.transform='translateY(0)'"
                                onmouseout="this.style.transform='translateY(100%)'"
                                >${overview}</div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
                return `
                    <div style="margin: 20px 0;">
                        <h3 style="color: var(--email-text); margin-bottom: 15px; padding-bottom: 16px;">${title}</h3>
                        <div style="
                            display: grid;
                            grid-template-columns: repeat(5, 1fr);
                            gap: 12px;
                            padding: 0;
                            margin: 0 auto 0 auto;
                            width: 80%;
                        ">
                            ${itemsHTML}
                        </div>
                    </div>
                `;
            }

            function getItemPosterURL(item) {
                const candidates = [item.thumb, item.art, item.parent_thumb, item.grandparent_thumb];
                for (const candidate of candidates) {
                    if (candidate) {
                        return `/proxy-art${candidate.startsWith('/') ? candidate : '/' + candidate}`;
                    }
                }
                return '/static/img/no-poster.png';
            }

            function buildCollectionCard(collection, themeColors) {
                const collectionTitle = collection.title || 'Unknown Collection';
                const count = collection.childCount || 0;
                const subtype = collection.subtype || 'unknown';
                const typeIcon = subtype === 'movie' ? '📽️' : subtype === 'show' ? '📺' : '🎧';
                
                let posterURL = null;
                const thumbUrl = collection.thumb;
                const artUrl = collection.art;
                
                if (thumbUrl) {
                    if (thumbUrl.startsWith('http')) {
                        try {
                            const url = new URL(thumbUrl);
                            posterURL = `/proxy-art${url.pathname}`;
                        } catch (e) {
                            console.log('Failed to parse thumb URL:', thumbUrl);
                        }
                    } else {
                        posterURL = `/proxy-art${thumbUrl.startsWith('/') ? thumbUrl : '/' + thumbUrl}`;
                    }
                } else if (artUrl) {
                    if (artUrl.startsWith('http')) {
                        try {
                            const url = new URL(artUrl);
                            posterURL = `/proxy-art${url.pathname}`;
                        } catch (e) {
                            console.log('Failed to parse art URL:', artUrl);
                        }
                    } else {
                        posterURL = `/proxy-art${artUrl.startsWith('/') ? artUrl : '/' + artUrl}`;
                    }
                }
                
                if (posterURL) {
                    return `
                        <table cellpadding="0" cellspacing="0" border="0" style="
                            background-color: ${themeColors.card_bg};
                            border-radius: 12px;
                            width: 120px;
                            margin: 0 auto;
                        ">
                            <tr>
                                <td style="
                                    background-image: url('${posterURL}');
                                    background-size: cover;
                                    background-position: center;
                                    background-repeat: no-repeat;
                                    height: 180px;
                                    background-color: #f8f9fa;
                                    border-radius: 12px;
                                    position: relative;
                                    vertical-align: top;
                                ">
                                    <table cellpadding="0" cellspacing="0" border="0" width="100%">
                                        <tr>
                                            <td style="text-align: right;">
                                                <div style="
                                                    background-color: rgba(0, 0, 0, 0.8);
                                                    color: white;
                                                    padding: 4px 6px;
                                                    border-radius: 4px;
                                                    font-size: 10px;
                                                    font-family: 'IBM Plex Sans';
                                                    line-height: 1;
                                                    display: inline-block;
                                                    margin: 6px;
                                                ">
                                                    ${typeIcon} ${count}
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="height: 150px; vertical-align: bottom;">
                                                <div style="
                                                    background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
                                                    border-radius: 0 0 11px 11px;
                                                    padding: 6px;
                                                ">
                                                    <div style="
                                                        font-weight: bold;
                                                        font-size: 12px;
                                                        color: white;
                                                        line-height: 1.2;
                                                        font-family: 'IBM Plex Sans';
                                                    ">${collectionTitle}</div>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    `;
                } else {
                    return `
                        <table cellpadding="0" cellspacing="0" border="0" style="
                            background-color: ${themeColors.card_bg};
                            border-radius: 12px;
                            border: 1px solid ${themeColors.border};
                            width: 120px;
                            height: 180px;
                            margin: 0 auto;
                        ">
                            <tr>
                                <td style="
                                    text-align: center;
                                    vertical-align: middle;
                                    padding: 12px;
                                ">
                                    <div style="
                                        font-weight: bold;
                                        font-size: 14px;
                                        color: ${themeColors.text};
                                        margin-bottom: 8px;
                                        font-family: 'IBM Plex Sans';
                                        padding: 2px;
                                    ">${collectionTitle}</div>
                                    <div style="
                                        font-size: 11px;
                                        color: ${themeColors.muted_text};
                                        font-family: 'IBM Plex Sans';
                                    ">${typeIcon} ${count} items</div>
                                </td>
                            </tr>
                        </table>
                    `;
                }
            }

            function buildCollectionPreviewHTMLForEmail(title, collections) {
                const themeColors = {
                    card_bg: 'var(--email-card-bg)',
                    text: 'var(--email-text)', 
                    border: 'var(--email-border)',
                    muted_text: 'var(--email-muted)'
                };
                
                if (!collections || collections.length === 0) {
                    return `
                        <div style="background-color: ${themeColors.card_bg}; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid ${themeColors.border}; font-family: 'IBM Plex Sans';">
                            <p style="text-align: center; color: ${themeColors.muted_text}; padding: 20px; margin: 0; font-family: 'IBM Plex Sans';">No collections available.</p>
                        </div>
                    `;
                }

                const itemsPerRow = 5;
                let itemsHTML = "";
                
                for (let i = 0; i < collections.length; i += itemsPerRow) {
                    const rowItems = collections.slice(i, i + itemsPerRow);
                    const isPartialRow = rowItems.length < itemsPerRow;
                    
                    if (isPartialRow) {
                        const itemsCount = rowItems.length;
                        
                        let rowHTML = `<tr><td colspan="${itemsPerRow}" style="text-align: center; padding: 8px;">`;
                        rowHTML += '<table cellpadding="0" cellspacing="0" border="0" style="margin: 0 auto; border-collapse: separate;">';
                        rowHTML += '<tr>';
                        
                        rowItems.forEach((collection, j) => {
                            let cellSpacing = "0";
                            if (itemsCount === 2) {
                                cellSpacing = j === 0 ? "60px" : "0";
                            } else if (itemsCount === 3) {
                                cellSpacing = j < 2 ? "40px" : "0";
                            } else if (itemsCount === 4) {
                                cellSpacing = j < 3 ? "20px" : "0";
                            } else if (itemsCount > 1) {
                                cellSpacing = j < itemsCount - 1 ? "6px" : "0";
                            }
                            
                            const cardHTML = buildCollectionCard(collection, themeColors);
                            rowHTML += `<td style="vertical-align: top; padding-right: ${cellSpacing};">${cardHTML}</td>`;
                        });
                        
                        rowHTML += '</tr></table></td></tr>';
                        itemsHTML += rowHTML;
                    } else {
                        let rowHTML = "<tr style='text-align: center;'>";
                        
                        rowItems.forEach((collection) => {
                            const cellStyle = `
                                width: 20%;
                                padding: 6px;
                                vertical-align: top;
                                font-family: 'IBM Plex Sans';
                            `;
                            
                            const cardHTML = buildCollectionCard(collection, themeColors);
                            rowHTML += `<td style="${cellStyle}">${cardHTML}</td>`;
                        });
                        
                        rowHTML += "</tr>";
                        itemsHTML += rowHTML;
                    }
                }
                
                const containerStyle = `
                    background-color: ${themeColors.card_bg};
                    border-radius: 8px;
                    margin: 20px 0;
                    border: 1px solid ${themeColors.border};
                    font-family: 'IBM Plex Sans';
                `;
                
                const titleStyle = `
                    text-align: center;
                    color: ${themeColors.text};
                    margin: 0 0 20px 0;
                    font-size: 24px;
                    font-weight: bold;
                    font-family: 'IBM Plex Sans';
                `;
                
                const tableStyle = `
                    width: 100%;
                    border-collapse: collapse;
                    margin: 0;
                    padding: 0;
                `;
                
                return `
                    <div style="${containerStyle}">
                        <h2 style="${titleStyle}">${title}</h2>
                        <table cellpadding="0" cellspacing="0" border="0" style="${tableStyle}">
                            ${itemsHTML}
                        </table>
                    </div>
                `;
            }

            function buildPreviewEmailHTML(contentHTML, serverName, subject, logoFilename, logoWidth, customLogoFilename, themedCSS) {
                let logoHTML = "";
                let logoSrc = "";
                if (logoFilename && logoWidth) {
                    if (logoFilename == 'custom') {
                        logoSrc = `/static/uploads/logos/${customLogoFilename}`;
                    } else {
                        logoSrc = `/static/img/${logoFilename}`;
                    }
                    logoHTML = `<img src="${logoSrc}" alt="${serverName}" class="email-logo" style="max-width: ${logoWidth}px; width: auto; height: auto;">`;
                }

                return `<!DOCTYPE html>
                    <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>${subject}</title>
                            ${themedCSS}
                        </head>
                        <body>
                            <div class="email-container">
                                <div class="email-header">
                                    ${logoHTML}
                                    <h1 class="email-title">${serverName} Newsletter</h1>
                                </div>
                                
                                <div class="email-content">
                                    ${contentHTML}
                                </div>
                                
                                <div class="email-footer">
                                    <div style="margin-bottom: 10px;">
                                        Generated for Plex Media Server by 
                                        <a href="https://github.com/jma1ice/newsletterr">newsletterr</a>
                                    </div>
                                    <div>
                                        newsletterr is not affiliated with or a product of Plex, Inc.
                                    </div>
                                </div>
                            </div>
                        </body>
                    </html>`;
            }

            function resizePreviewFrame(frame) {
                try {
                    const doc = frame.contentDocument || frame.contentWindow.document;
                    if (doc && doc.body) {
                        const contentHeight = Math.max(
                            doc.body.scrollHeight,
                            doc.body.offsetHeight,
                            doc.documentElement.clientHeight,
                            doc.documentElement.scrollHeight,
                            doc.documentElement.offsetHeight
                        );
                        
                        const minHeight = 480;
                        const maxHeight = 1200;
                        const newHeight = Math.max(minHeight, Math.min(maxHeight, contentHeight + 40));
                        
                        frame.style.height = newHeight + 'px';
                    }
                } catch (e) {
                    console.log('Could not resize iframe:', e);
                }
            }

            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            const debouncedUpdatePreview = debounce(updatePreview, 300);

            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('email_text').addEventListener('input', debouncedUpdatePreview);
                
                console.log('DOM loaded, testing preview...');
                const frame = document.getElementById('preview');
                if (frame) {
                    frame.srcdoc = '<html><body><h1>Test Preview</h1><p>If you can see this, the iframe is working.</p></body></html>';
                    console.log('Test preview set');
                } else {
                    console.error('Preview iframe not found on DOM load!');
                }
                
                setTimeout(() => {
                    console.log('Running initial updatePreview...');
                    updatePreview();
                }, 100);
            });
        </script>
        <script>
            function showRAPreviewFor(libName) {
                const preview = document.getElementById('ra-preview');
                const ul = document.getElementById('ra-view');
                const list = items.filter(i => i.library === libName);
                ul.style.gridTemplateColumns = 'repeat(5, 1fr)';
                renderRAGrid(list, ul);
                preview.style.display = 'block';
            }

            function showRecsPreviewFor(userKey) {
                const preview = document.getElementById('recs-preview');
                if (!preview) return;
                const header = preview.querySelector('.card-header');
                if (header) header.textContent = `Recommendations - ${userDict[userKey] || userKey}`;
                const body = preview.querySelector('.card-body');
                body.innerHTML = '';
                body.appendChild(buildRecsBlockForUser(userKey, { headingTag: 'h4' }, { bgColorway: 'view' }));
                preview.style.display = 'block';
            }

            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-stat-btn')) {
                    const targetId = e.target.dataset.target;
                    const previewDiv = document.getElementById('stat-preview');
                    const allStats = document.querySelectorAll('.stat-table');
                    
                    allStats.forEach(el => el.classList.add('d-none'));
                    
                    document.getElementById(targetId).classList.remove('d-none');
                    previewDiv.style.display = 'block';
                }
        
                if (e.target.classList.contains('view-graph-btn')) {
                    const targetId = e.target.dataset.target;
                    const previewDiv = document.getElementById('graph-preview');
                    const allGraphs = document.querySelectorAll('.graph-table');
                    
                    allGraphs.forEach(el => el.classList.add('d-none'));
                    
                    const container = document.getElementById(targetId);
                    container.classList.remove('d-none');
                    previewDiv.style.display = 'block';
                    
                    if (!renderedCharts.has(targetId)) {
                        const index = parseInt(targetId.split('-')[1]);
                        const graphData = graphDataList[index];

                        Highcharts.chart(targetId, {
                            chart: { type: 'line' },
                            title: { text: graphCommands[index].name },
                            exporting: {
                                enabled: true
                            },
                            xAxis: { categories: graphData.categories },
                            yAxis: { title: { text: 'Plays' } },
                            series: graphData.series
                        });

                        renderedCharts.add(targetId);
                    }
                    
                    const nowDark = document.documentElement.classList.contains('dark');
                    applyChartTheme(nowDark);
                }

                if (e.target.classList.contains('ra-view-btn')) {
                    const viewBtn = e.target.closest('.ra-view-btn');
                    if (viewBtn) {
                        const lib = viewBtn.dataset.lib;
                        showRAPreviewFor(lib);
                        return;
                    }
                }

                if (e.target.classList.contains('recs-view-btn')) {
                    const viewBtn = e.target.closest('.recs-view-btn');
                    if (viewBtn) {
                        const userKey = viewBtn.dataset.userKey;
                        if (userKey) showRecsPreviewFor(userKey);
                        return;
                    }
                }
            });
        </script>
        <script>
            function themeVars(isDark) {
                return {
                    text: isDark ? '#8acbd4' : '#333',
                    grid: isDark ? '#e5e7eb' : '#374151',
                    axis: isDark ? '#e5e7eb' : '#374151',
                    bg: isDark ? '#333' : '#8acbd4',
                };
            }

            function applyChartTheme(isDark) {
                const t = themeVars(isDark);

                Highcharts.setOptions({
                    chart: { backgroundColor: t.bg, style: { fontFamily: 'IBM Plex Sans' } },
                    title: { style: { color: t.text } },
                    legend: { itemStyle: { color: t.text } },
                    xAxis: { labels: { style: { color: t.text } }, gridLineColor: t.grid, lineColor: t.axis, tickColor: t.axis },
                    yAxis: { labels: { style: { color: t.text } }, title: { style: { color: t.text } }, gridLineColor: t.grid, lineColor: t.axis, tickColor: t.axis }
                });

                Highcharts.charts.filter(Boolean).forEach(c => {
                    c.update({
                        chart: { backgroundColor: t.bg },
                        title: { style: { color: t.text } },
                        legend: { itemStyle: { color: t.text } }
                    });

                    c.xAxis.forEach(ax => ax.update({
                        labels: { style: { color: t.text } },
                        gridLineColor: t.grid,
                        lineColor: t.axis,
                        tickColor: t.axis
                    }));

                    c.yAxis.forEach(ax => ax.update({
                        labels: { style: { color: t.text } },
                        title: { style: { color: t.text } },
                        gridLineColor: t.grid,
                        lineColor: t.axis,
                        tickColor: t.axis
                    }));

                    c.redraw();
                });
            }

            const isDark = document.documentElement.classList.contains('dark');
            applyChartTheme(isDark);

            document.getElementById('theme-toggle')?.addEventListener('click', () => {
                const nowDark = document.documentElement.classList.contains('dark');
                applyChartTheme(!nowDark);
            });

            const graphDataList = {{ graph_data | tojson }};
            const graphCommands = {{ graph_commands | tojson }};

            const renderedCharts = new Set();
        </script>
        <script>
            function updateSelectedItemsDisplay() {
                const container = document.getElementById('selected-items-list');
                
                if (selectedItems.length === 0) {
                    container.innerHTML = '<div id="selected-items-empty" class="text-muted text-center py-3">No items selected. Use the buttons below to add items to your email.</div>';
                } else {
                    let htmlContent = '';
                    
                    selectedItems.forEach((item, index) => {
                        if (item.type === 'titleblock') {
                            const currentContent = getTextBlockContent(item.id) || '';
                            const badgeStyle = 'badge-warning';
                            const placeholderText = 'Enter your title here...';
                            htmlContent += `
                                <div class="selected-item d-flex flex-column p-2 mb-2 border rounded" 
                                     data-index="${index}" data-fixed="top" draggable="false">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="item-name">${item.name}</span>
                                        <div>
                                            <span class="badge ${badgeStyle} me-2">${item.type}</span>
                                            <button type="button" class="btn btn-sm btn-outline-danger title-remove remove-item-btn" data-index="${index}">x</button>
                                        </div>
                                    </div>
                                    <textarea 
                                        data-textblock-id="${item.id}" 
                                        class="form-control text-block-editor" 
                                        style="height: 60px; font-size: 0.9rem; resize: vertical;"
                                        placeholder="${placeholderText}"
                                        oninput="updateTextBlockName('${item.id}', ${index})">${currentContent}</textarea>
                                </div>
                            `;
                        } else if (item.type === 'textblock' || item.type === 'headerblock') {
                            const currentContent = getTextBlockContent(item.id) || '';
                            const badgeStyle = item.type === 'headerblock' ? 'badge-warning' : 'badge-secondary';
                            const placeholderText = item.type === 'headerblock' ? 'Enter your header here...' : 'Enter your text here...';
                            htmlContent += `
                                <div class="selected-item d-flex flex-column p-2 mb-2 border rounded" 
                                     data-index="${index}" draggable="true">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="item-name">${item.name}</span>
                                        <div>
                                            <span class="badge ${badgeStyle} me-2">${item.type}</span>
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" data-index="${index}">x</button>
                                        </div>
                                    </div>
                                    <textarea 
                                        data-textblock-id="${item.id}" 
                                        class="form-control text-block-editor" 
                                        style="height: 60px; font-size: 0.9rem; resize: vertical;"
                                        placeholder="${placeholderText}"
                                        oninput="updateTextBlockName('${item.id}', ${index})">${currentContent}</textarea>
                                </div>
                            `;
                        } else if (item.type === 'collection_group') {
                            const currentTitle = item.title || 'Unnamed Collection Group';
                            const collectionCount = item.collections ? item.collections.length : 0;
                            
                            htmlContent += `
                                <div class="selected-item d-flex flex-column p-2 mb-2 border rounded" 
                                    data-index="${index}" draggable="true">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <input type="text" 
                                            class="form-control form-control-sm collection-group-title" 
                                            data-index="${index}"
                                            value="${currentTitle}" 
                                            placeholder="Enter group name..."
                                            style="max-width: 300px;">
                                        <div>
                                            <span class="badge badge-info me-2">${collectionCount} collection(s)</span>
                                            <span class="badge badge-secondary me-2">collection group</span>
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" data-index="${index}">x</button>
                                        </div>
                                    </div>
                                    <div class="collection-group-items text-[#333] dark:text-[#8acbd4]" style="font-size: 0.85rem;">
                                        ${item.collections && item.collections.length > 0 
                                            ? item.collections.map((col, i) => `
                                                <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                                    <span>${col.title} (${col.childCount} items)</span>
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-collection-btn" 
                                                            data-group-index="${index}" data-collection-index="${i}">x</button>
                                                </div>
                                            `).join('')
                                            : '<em class="text-[#333] dark:text-[#8acbd4]">No collections added yet</em>'
                                        }
                                    </div>
                                </div>
                            `;
                        } else {
                            htmlContent += `
                                <div class="selected-item d-flex justify-content-between align-items-center p-2 mb-2 border rounded bg-light" 
                                     data-index="${index}" draggable="true" style="padding-left: 32px !important;">
                                    <span class="item-name">${item.name}</span>
                                    <div>
                                        <span class="badge badge-secondary me-2">${item.type}</span>
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" data-index="${index}">x</button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    container.innerHTML = htmlContent;

                    document.querySelectorAll('.collection-group-title').forEach(input => {
                        input.addEventListener('input', (e) => {
                            const index = parseInt(e.target.dataset.index);
                            if (selectedItems[index] && selectedItems[index].type === 'collection_group') {
                                selectedItems[index].title = e.target.value;
                                debouncedUpdatePreview();
                            }
                        });
                    });
                    
                    document.querySelectorAll('.remove-collection-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const groupIndex = parseInt(e.target.dataset.groupIndex);
                            const collectionIndex = parseInt(e.target.dataset.collectionIndex);
                            
                            if (selectedItems[groupIndex] && selectedItems[groupIndex].collections) {
                                selectedItems[groupIndex].collections.splice(collectionIndex, 1);
                                updateSelectedItemsDisplay();
                            }
                        });
                    });
                    
                    setupDragAndDrop();
                }
                
                updatePreview();
            }

            function captureChartAsBase64(chartId) {
                const chart = Highcharts.charts.find(c => c && c.renderTo.id === chartId);
                if (!chart) {
                    console.log('Chart not found for ID:', chartId);
                    return null;
                }
                
                try {
                    const svg = chart.getSVG({
                        width: 600,
                        height: 400
                    });
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 600;
                    canvas.height = 400;
                    
                    const img = new Image();
                    const svgBlob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
                    const url = URL.createObjectURL(svgBlob);
                    
                    return new Promise((resolve) => {
                        img.onload = function() {
                            ctx.drawImage(img, 0, 0);
                            const dataUrl = canvas.toDataURL('image/png');
                            URL.revokeObjectURL(url);
                            resolve(dataUrl);
                        };
                        img.onerror = function() {
                            console.error('Failed to load chart image');
                            URL.revokeObjectURL(url);
                            resolve(null);
                        };
                        img.src = url;
                    });
                } catch (error) {
                    console.error('Error capturing chart:', error);
                    return null;
                }
            }

            async function addItemWithChartCapture(id, name, type, extra = {}) {
                if (!id || !type) {
                    console.warn('addItem aborted: missing id/type', { id, type, name, extra });
                    return false;
                }

                if (selectedItems.some(it => it.id === id && it.type === type)) {
                    console.log('Item already added:', { id, type });
                    return false;
                }

                const item = { id, name: name || id, type, ...extra };

                if (type === 'graph') {
                    console.log('Capturing chart for:', id);
                    
                    if (!renderedCharts.has(id)) {
                        try {
                            const index = parseInt(id.split('-')[1], 10);
                            const graphData = graphDataList[index];

                            Highcharts.chart(id, {
                                chart: { type: 'line' },
                                title: { text: graphCommands[index].name },
                                exporting: { enabled: true },
                                xAxis: { categories: graphData.categories },
                                yAxis: { title: { text: 'Plays' } },
                                series: graphData.series
                            });

                            renderedCharts.add(id);
                            const nowDark = document.documentElement.classList.contains('dark');
                            applyChartTheme(nowDark);
                        } catch (err) {
                            console.warn('Failed to render graph', id, err);
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const chartImage = await captureChartAsBase64(id);
                    if (chartImage) {
                        item.chartImage = chartImage;
                        console.log('Successfully captured chart image for:', id);
                    } else {
                        console.warn('Failed to capture chart image for:', id);
                    }
                }

                if (type === 'titleblock') {
                    const existing = selectedItems.findIndex(it => it.type === 'titleblock');
                    if (existing !== -1) selectedItems.splice(existing, 1);
                    selectedItems.unshift(item);
                } else {
                    selectedItems.push(item);
                }

                updateSelectedItemsDisplay();
                return true;
            }

            function addItem(id, name, type, extra = {}) {
                if (!id || !type) {
                    console.warn('addItem aborted: missing id/type', { id, type, name, extra });
                    return false;
                }

                if (selectedItems.some(it => it.id === id && it.type === type)) {
                    console.log('Item already added:', { id, type });
                    return false;
                }

                if (type === 'graph' && !renderedCharts.has(id)) {
                    try {
                        const index = parseInt(id.split('-')[1], 10);
                        const graphData = graphDataList[index];

                        Highcharts.chart(id, {
                            chart: { type: 'line' },
                            title: { text: graphCommands[index].name },
                            exporting: { enabled: true },
                            xAxis: { categories: graphData.categories },
                            yAxis: { title: { text: 'Plays' } },
                            series: graphData.series
                        });

                        renderedCharts.add(id);

                        const nowDark = document.documentElement.classList.contains('dark');
                        applyChartTheme(nowDark);
                        console.log('Auto-rendered graph:', id);
                    } catch (err) {
                        console.warn('Failed to auto-render graph', id, err);
                    }
                }

                const item = { id, name: name || id, type, ...extra };

                if (type === 'titleblock') {
                    const existing = selectedItems.findIndex(it => it.type === 'titleblock');
                    if (existing !== -1) selectedItems.splice(existing, 1);
                    selectedItems.unshift(item);
                } else {
                    selectedItems.push(item);
                }

                updateSelectedItemsDisplay();
                return true;
            }

            function removeItem(index) {
                const removedItem = selectedItems[index];
                selectedItems.splice(index, 1);
                updateSelectedItemsDisplay();
                
                const button = document.querySelector(`[data-id="${removedItem.id}"]`);
                if (button) {
                    button.textContent = `Add`;
                    button.classList.remove('btn-success');
                    button.classList.add('button');
                    button.disabled = false;
                }
            }

            function setupDragAndDrop() {
                const items = () => Array.from(document.querySelectorAll('.selected-item'));
                const indexOfEl = (el) => allItems().indexOf(el);
                const isFixed = (el) => el?.dataset?.fixed === 'top';
                const clampToMovable = (i) => Math.max(1, i);
                let draggedElement = null;
                
                items().forEach((item, index) => {
                    if (isFixed(item)) return;

                    item.addEventListener('dragstart', (e) => {
                        draggedElement = item;
                        e.dataTransfer.setData('text/plain', index);
                        e.dataTransfer.effectAllowed = 'move';
                        
                        setTimeout(() => {
                            item.classList.add('dragging');
                        }, 0);
                    });
                    
                    item.addEventListener('dragend', () => {
                        item.classList.remove('dragging');
                        items().forEach(i => i.classList.remove('drag-over'));
                        draggedElement = null;
                    });
                    
                    item.addEventListener('dragenter', (e) => {
                        e.preventDefault();
                        if (draggedElement && draggedElement !== item) {
                            item.classList.add('drag-over');
                        }
                    });
                    
                    item.addEventListener('dragleave', (e) => {
                        if (!item.contains(e.relatedTarget)) {
                            item.classList.remove('drag-over');
                        }
                    });
                    
                    item.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                    });
                    
                    item.addEventListener('drop', (e) => {
                        e.preventDefault();
                        item.classList.remove('drag-over');
                        
                        const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                        const targetIndex = parseInt(item.dataset.index);
                        
                        if (draggedIndex !== targetIndex) {
                            const draggedItem = selectedItems[draggedIndex];
                            selectedItems.splice(draggedIndex, 1);
                            selectedItems.splice(targetIndex, 0, draggedItem);
                            updateSelectedItemsDisplay();
                        }
                    });
                });
            }

            let textBlockCounter = 0;
            let titleBlockCounter = 0;
            let headerBlockCounter = 0;
            
            function createTextBlock() {
                textBlockCounter++;
                const textBlockId = `text-block-${textBlockCounter}`;
                const textContent = '';
                const displayName = 'New text block';
                
                if (addItem(textBlockId, displayName, 'textblock')) {
                    return textBlockId;
                }
                return null;
            }
            
            function getTextBlockContent(textBlockId) {
                const textarea = document.querySelector(`[data-textblock-id="${textBlockId}"]`);
                return textarea ? textarea.value : '';
            }
            
            function setTextBlockContent(textBlockId, content) {
                const textarea = document.querySelector(`[data-textblock-id="${textBlockId}"]`);
                if (textarea) {
                    textarea.value = content;
                    const index = selectedItems.findIndex(item => item.id === textBlockId);
                    if (index !== -1) {
                        selectedItems[index].name = getTextBlockDisplayName(content);
                        const nameSpan = document.querySelector(`[data-index="${index}"] .item-name`);
                        if (nameSpan) {
                            nameSpan.textContent = selectedItems[index].name;
                        }
                    }
                }
            }
            
            function getTextBlockDisplayName(content) {
                const firstLine = content.split('\n')[0].trim();
                if (firstLine.length === 0) return 'Empty text block';
                return firstLine.length > 30 ? firstLine.substring(0, 30) + '...' : firstLine;
            }
            
            function updateTextBlockName(textBlockId, index) {
                const content = getTextBlockContent(textBlockId);
                const newName = getTextBlockDisplayName(content);
                
                if (selectedItems[index]) {
                    selectedItems[index].name = newName;
                    
                    const nameSpan = document.querySelector(`[data-index="${index}"] .item-name`);
                    if (nameSpan) {
                        nameSpan.textContent = newName;
                    }
                }
                
                clearTimeout(window.previewUpdateTimeout);
                window.previewUpdateTimeout = setTimeout(updatePreview, 300);
            }

            function createIntroBlock() {
                textBlockCounter++;
                const textBlockId = `intro-block-${textBlockCounter}`;
                const serverName = "{{ settings.server_name }}";
                const introContent = `You are receiving this email because you are a member of ${serverName}.`;
                const displayName = 'Intro: Member message';
                
                if (addItem(textBlockId, displayName, 'textblock')) {
                    setTimeout(() => {
                        setTextBlockContent(textBlockId, introContent);
                        debouncedUpdatePreview();
                    }, 100);
                    return textBlockId;
                }
                return null;
            }
            
            function createOutroBlock() {
                textBlockCounter++;
                const textBlockId = `outro-block-${textBlockCounter}`;
                const outroContent = 'Thanks for using Plex and for reading this newsletterr email!';
                const displayName = 'Outro: Thank you message';
                
                if (addItem(textBlockId, displayName, 'textblock')) {
                    setTimeout(() => {
                        setTextBlockContent(textBlockId, outroContent);
                        debouncedUpdatePreview();
                    }, 100);
                    return textBlockId;
                }
                return null;
            }
            
            function createTitleBlock() {
                if (titleBlockCounter > 0) {
                    return null;
                } else {
                    titleBlockCounter++;
                    const textBlockId = `title-block-${titleBlockCounter}`;
                    const titleContent = 'Newsletter Title';
                    const displayName = 'Title: Newsletter Title';
                    
                    if (addItem(textBlockId, displayName, 'titleblock')) {
                        setTimeout(() => {
                            setTextBlockContent(textBlockId, titleContent);
                            debouncedUpdatePreview();
                        }, 100);
                        return textBlockId;
                    }
                    return null;
                }
            }

            function createHeaderBlock() {
                headerBlockCounter++;
                const textBlockId = `header-block-${headerBlockCounter}`;
                const headerContent = 'Newsletter Header';
                const displayName = 'Header: Newsletter Header';
                
                if (addItem(textBlockId, displayName, 'headerblock')) {
                    setTimeout(() => {
                        setTextBlockContent(textBlockId, headerContent);
                        debouncedUpdatePreview();
                    }, 100);
                    return textBlockId;
                }
                return null;
            }

            document.addEventListener('click', async (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;

                if (btn.id === 'add-text-block-btn') { createTextBlock(); return; }
                if (btn.id === 'add-intro-btn') { createIntroBlock(); return; }
                if (btn.id === 'add-outro-btn') { createOutroBlock(); return; }
                if (btn.id === 'add-title-btn') { createTitleBlock(); return; }
                if (btn.id === 'add-header-btn') { createHeaderBlock(); return; }

                if (btn.classList.contains('remove-item-btn')) {
                    const index = parseInt(btn.dataset.index, 10);
                    if (!Number.isNaN(index)) removeItem(index);
                    if (btn.classList.contains('title-remove')) { titleBlockCounter = 0; }
                    return;
                }


                const isAdd =
                    btn.classList.contains('add-stat-btn') ||
                    btn.classList.contains('add-graph-btn') ||
                    btn.classList.contains('ra-add-btn') ||
                    btn.classList.contains('recs-add-btn');

                if (!isAdd) return;

                const { id, name, type } = btn.dataset;
                if (!id || !type) return;

                console.log('Adding item:', { id, name, type });
                console.log('Current selectedItems before:', selectedItems);

                const extra = {};
                if (type === 'ra' && btn.dataset.lib) {
                    extra.raLibrary = btn.dataset.lib;
                }
                if (type === 'recs') {
                    if (btn.dataset.userKey) extra.userKey = btn.dataset.userKey;
                }
                if (type === 'graph') {
                    btn.textContent = 'Capturing...';
                    btn.disabled = true;
                }

                if (await addItemWithChartCapture(id, name || id, type, extra)) {
                    btn.textContent = 'Added';
                    btn.classList.remove('button');
                    btn.classList.add('btn-success');
                    btn.disabled = true;

                    console.log('Item added. Current selectedItems:', selectedItems);
                } else {
                    if (type === 'graph') {
                        btn.textContent = 'Add';
                        btn.disabled = false;
                    }
                    console.log('Item already exists');
                }
            });

            updateSelectedItemsDisplay();
        </script>
        <script id="recommendations-json" type="application/json">
            {{ recommendations_json | tojson }}
        </script>
        <script>
            function readJSONFromScript(id) {
                const el = document.getElementById(id);
                if (!el) return {};
                try {
                    const txt = (el.textContent || '').trim();
                    if (!txt) return {};
                    return JSON.parse(txt);
                } catch (e) {
                    console.error(`Invalid JSON in #${id}`, e);
                    return {};
                }
            }

            let recsPayload = readJSONFromScript('recommendations-json');
            const userDict = {{ user_dict | tojson }} || {};
        </script>
        <script>
            function posterCard(p, faded=false) {
                const src = p.url ? `/proxy-img?u=${encodeURIComponent(p.url)}` : '';
                const title = p.title || '';
                const runtime = p.runtime || '';
                const y = p.year ? String(p.year) : '';
                const vote = typeof p.vote === 'number'
                                    ? String((Math.round(p.vote * 10) / 10)).replace(/\.0$/,'')
                                    : '';
                const bits = [y, vote ? `★ ${vote}` : ''].filter(Boolean).join(' • ');
                const ov = p.overview || '';

                return `
                    <li class="relative group rounded-3 overflow-hidden bg-gray-200 dark:bg-gray-700 text-white">
                        <a href="${p.href || '#'}" target="_blank" rel="noopener" class="block text-white">
                            <div class="aspect-[2/3]">
                                ${src ? `<img loading="eager" src="${src}" class="h-full w-full object-cover">` : ''}
                            </div>

                            <div class="absolute top-1 left-1 text-[11px] text-white/90">
                                ${bits ? `<span class="bg-black/70 rounded px-1.5 py-0.5 text-white"><span class="text-white pill_text">${bits}</span></span>` : ''}
                            </div>

                            ${faded ? `
                                <div class="absolute top-6 left-1 text-[10px] bg-rose-600/85 text-white rounded px-1.5 py-0.5">
                                    <span class="text-white pill_text">Unavailable</span>
                                </div>` : ''}

                            <div class="absolute inset-x-0 bottom-0 p-2 bg-gradient-to-t from-black/70 to-transparent">
                                <div class="text-[12px] font-semibold text-white line-clamp-2">${title}</div>
                                ${runtime ? `<div class="text-[11px] text-white/80">${runtime}</div>` : ''}
                            </div>
                        </a>

                        ${ov ? `
                            <div class="absolute left-0 right-0 bottom-0 translate-y-full group-hover:translate-y-0 transition
                                    text-[10px] bg-black/80 text-white px-2 py-1 line-clamp-3">${ov}</div>` : ''}
                    </li>`;
            }

            function buildRecsBlockForUser(userKey, { headingTag = 'h4' } = {}, { bgColorway = 'view' } = {}) {
                const COLUMNS = 5;

                recsPayload = readJSONFromScript('recommendations-json');
                const data = recsPayload[userKey] || {};
                const moviesAvail = data.movie_posters || [];
                const moviesUn = data.movie_posters_unavailable || [];
                const showsAvail = data.show_posters || [];
                const showsUn = data.show_posters_unavailable || [];

                const wrap = document.createElement('div');
                if (bgColorway === 'view') {
                    wrap.className = "rec-user-card rounded-3 bg-[#8acbd4] dark:bg-[#333] relative !shadow-none";
                } else {
                    wrap.className = "rec-user-card rounded-3 bg-[#282A2D] relative !shadow-none";
                }

                const section = (label) => {
                    const h = document.createElement(headingTag);
                    h.textContent = label;
                    if (bgColorway === 'view') {
                        h.classList.add('text-[#333]');
                        h.classList.add('dark:text-[#8acbd4]');
                    } else {
                        h.classList.add('text-[#8acbd4]');
                        h.classList.add('!important');
                    }
                    h.classList.add('pb-4')
                    wrap.appendChild(h);
                };

                const grid = () => {
                    const ul = document.createElement('ul');
                    ul.className = "grid grid-cols-5 gap-3";
                    ul.style.display = 'grid';
                    ul.style.gridTemplateColumns = `repeat(${COLUMNS}, minmax(0, 1fr))`;
                    ul.style.gap = '12px';
                    ul.style.listStyle = 'none';
                    ul.style.padding = '0';
                    ul.style.margin = '0';
                    return ul;
                };

                const appendPosters = (ul, arr, faded=false) => {
                    ul.insertAdjacentHTML('beforeend', arr.map(p => posterCard(p, faded)).join(''));
                };

                const firstSpan = (availLen) => {
                    const remainder = (COLUMNS - (availLen % COLUMNS)) % COLUMNS;
                    return remainder !== 0 ? remainder : COLUMNS;
                };

                const clampGap = (span) => {
                    if (span <= 1) return '0.75rem';
                    const v = span / (span - 1.5);
                    return (Math.max(0.5, Math.min(2.0, v))).toFixed(2) + 'rem';
                };

                const makeUnavailableRows = (unArr, span) => {
                    const frag = document.createDocumentFragment();
                    const firstRow = unArr.slice(0, span);
                    const rest = unArr.slice(span);

                    if (firstRow.length) {
                        const li = document.createElement('li');
                        li.className = "col-span-full";
                        li.style.gridColumn = `span ${span} / span ${span}`;
                        const box = document.createElement('div');
                        box.className = "relative rounded";
                        const ring = document.createElement('div');
                        ring.className = "pointer-events-none absolute inset-0 rounded";
                        ring.style.boxShadow = '0 0 0 1px #f59e0b inset';
                        const ul = document.createElement('ul');
                        ul.className = "grid p-1";
                        ul.style.display = 'grid';
                        ul.style.gridTemplateColumns = `repeat(${span}, minmax(0, 1fr))`;
                        ul.style.gap = clampGap(span);
                        firstRow.forEach(p => ul.insertAdjacentHTML('beforeend', posterCard(p, true)));
                        box.appendChild(ring);
                        box.appendChild(ul);
                        li.appendChild(box);
                        frag.appendChild(li);
                    }

                    for (let i=0; i<rest.length; i+=COLUMNS) {
                        const chunk = rest.slice(i, i+COLUMNS);
                        const li = document.createElement('li');
                        li.className = "col-span-full";
                        const box = document.createElement('div');
                        box.className = "relative rounded";
                        const ring = document.createElement('div');
                        ring.className = "pointer-events-none absolute inset-0 rounded";
                        ring.style.boxShadow = '0 0 0 1px #f59e0b inset';
                        const ul = document.createElement('ul');
                        ul.className = "grid p-1";
                        ul.style.display = 'grid';
                        ul.style.gridTemplateColumns = `repeat(${COLUMNS}, minmax(0, 1fr))`;
                        ul.style.gap = '0.75rem';
                        chunk.forEach(p => { if (p) ul.insertAdjacentHTML('beforeend', posterCard(p, true)); });
                        box.appendChild(ring);
                        box.appendChild(ul);
                        li.appendChild(box);
                        frag.appendChild(li);
                    }

                    return frag;
                };

                if (moviesAvail.length || moviesUn.length) {
                    section("Recommended Movies");
                    const ul = grid();
                    appendPosters(ul, moviesAvail, false);
                    if (moviesUn.length) ul.appendChild(makeUnavailableRows(moviesUn, firstSpan(moviesAvail.length)));
                    wrap.appendChild(ul);
                }

                if (showsAvail.length || showsUn.length) {
                    section("Recommended Shows");
                    const ul = grid();
                    appendPosters(ul, showsAvail, false);
                    if (showsUn.length) ul.appendChild(makeUnavailableRows(showsUn, firstSpan(showsAvail.length)));
                    wrap.appendChild(ul);
                }

                return wrap;
            }

            function buildRecsUserRows() {
                recsPayload = readJSONFromScript('recommendations-json');
                const host = document.getElementById('recs-user-list');
                if (!host) return;

                const users = Object.keys(recsPayload || {}).filter(Boolean).sort();

                users.forEach(userKey => {
                    const display = userDict[userKey] || userKey;
                    const id = `recs-user-${slug(display)}`;

                    const row = document.createElement('div');
                    row.className = 'col-12 mb-2';
                    row.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                            <span style="font-size: .9rem;">${display}</span>
                            <div>
                                <button type="button"
                                        class="btn button-outline btn-sm me-1 recs-view-btn"
                                        data-user-key="${userKey}" data-target="${id}"
                                        style="font-size: .8rem; padding: .25rem .5rem;">View</button>
                                <button type="button"
                                        class="btn button btn-sm recs-add-btn"
                                        data-type="recs" data-id="${id}"
                                        data-name="Recommendations: ${display}"
                                        data-user-key="${userKey}"
                                        style="font-size: .8rem; padding: .25rem .5rem;">Add</button>
                            </div>
                        </div>`;
                    host.appendChild(row);
                });
            };
            buildRecsUserRows();
        </script>
        <script>
            document.getElementById('pullRecsBtn').addEventListener('click', async () => {
                showSpinner('Pulling recommendations...');

                function collectEmailsFromChips() {
                    return Array.from(document.querySelectorAll('#bcc_chips .nl-chip'))
                        .map(ch => ch.dataset.email)
                        .filter(Boolean);
                }

                const chipInput = document.getElementById('email_chip_input');
                    if (chipInput && chipInput.value.trim()) {
                        chipInput.dispatchEvent(new Event('blur'));
                }

                const toList = collectEmailsFromChips();
                    if (!toList.length) {
                        alert('Please add at least one recipient.');
                        return;
                }

                const to_emails = toList.join(', ');

                const payload = {
                    stats: {{ stats | tojson }},
                    user_dict: {{ user_dict | tojson }},
                    graph_data: {{ graph_data | tojson }},
                    graph_commands: {{ graph_commands | tojson }},
                    recent_data: {{ recent_data | tojson }},
                    libs: {{ libs | tojson }},
                    settings: {{ settings | tojson }},
                    to_emails
                };

                try {
                    const resp = await fetch('/pull_recommendations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'text/html' },
                        body: JSON.stringify(payload),
                        credentials: 'same-origin'
                    });
                    
                    if (!resp.ok) throw new Error('Error pulling recommendations.');

                    const html = await resp.text();
                    const doc = new DOMParser().parseFromString(html, 'text/html');

                    const oldCacheCard = document.getElementById('cache-card');
                    const newCacheCard = doc.getElementById('cache-card');
                    oldCacheCard.replaceWith(newCacheCard);

                    const oldRecsRow = document.getElementById('recs-col');
                    const newRecsRow = doc.getElementById('recs-col');
                    oldRecsRow.replaceWith(newRecsRow);

                    const oldRecsPreview = document.getElementById('recs-preview');
                    const newRecsPreview = doc.getElementById('recs-preview');
                    oldRecsPreview.replaceWith(newRecsPreview);

                    const oldData = document.getElementById('recommendations-json');
                    const newData = doc.getElementById('recommendations-json');
                    if (newData) {
                        if (oldData) oldData.replaceWith(newData); else document.body.appendChild(newData);
                        window.recommendationsData = JSON.parse(document.getElementById('recommendations-json').textContent);
                    }

                    buildRecsUserRows();
                } catch (err) {
                    console.error("Error pulling recommendations:", err);
                    const error_p= document.getElementById('error_p');
                    error_p.textContent = err;
                    alert("Something went wrong while pulling recommendations.");
                } finally {
                    try { hideSpinner(); } catch(_) {}
                }
            });
        </script>
        <script>
            function collectEmailsFromChips() {
                return Array.from(document.querySelectorAll('#bcc_chips .nl-chip'))
                    .map(ch => ch.dataset.email)
                    .filter(Boolean);
            }

            document.getElementById('sendEmailBtn').addEventListener('click', async () => {
                const subject = document.getElementById('subject').value;
                
                const chipInput = document.getElementById('email_chip_input');
                if (chipInput && chipInput.value.trim()) {
                    chipInput.dispatchEvent(new Event('blur'));
                }

                const toList = collectEmailsFromChips();
                if (!toList.length) {
                    alert('Please add at least one recipient.');
                    return;
                }

                const to_emails = toList.join(', ');

                const ok = window.confirm(
                    `Send email?\n\nSubject: ${subject || '(no subject)'}\n\nRecipients (${toList.length}):\n${toList.join('\n')}`
                );
                if (!ok) return;

                showSpinner('Preparing email content...');

                try {
                    const previewFrame = document.getElementById('preview');
                    const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                    const emailHTML = previewDoc.documentElement.outerHTML;

                    for (let item of selectedItems) {
                        if (item.type === 'graph' && !item.chartImage) {
                            console.log('Capturing missing chart for:', item.id);
                            const chartImage = await captureChartAsBase64(item.id);
                            if (chartImage) {
                                item.chartImage = chartImage;
                            }
                        }
                    }

                    selectedItems.forEach(item => {
                        if (['textblock', 'titleblock', 'headerblock'].includes(item.type)) {
                            const content = getTextBlockContent(item.id);
                            item.content = content;
                        }
                    });

                    showSpinner('Sending email...');

                    const resp = await fetch('/send_email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            to_emails,
                            subject,
                            email_html: emailHTML,
                            selected_items: selectedItems,
                            user_dict: userDict
                        })
                    });
                    
                    if (resp.ok) {
                        const data = await resp.json();
                        alert(`Email sent successfully to ${toList.length} recipient${toList.length !== 1 ? 's' : ''}!`);
                    } else {
                        const data = await resp.json();
                        alert("Error sending email: " + data.error);
                    }
                } catch (err) {
                    console.error("Error sending email:", err);
                    alert("Something went wrong while sending the email.");
                }

                hideSpinner();
            });
        </script>
        <script>
            document.getElementById('stats_form').addEventListener('submit', (e) => {
                showSpinner('Getting stats and users...');
            });
        </script>
        <script>
            (function () {
                const box = document.getElementById('bcc_chips');
                const input = document.getElementById('email_chip_input');
                const ta = document.getElementById('to_emails');

                if (!box || !input || !ta) return;

                function normalize(token) {
                    const m = String(token).match(/<([^>]+)>/);
                    return (m ? m[1] : token).trim().toLowerCase();
                }
                function isEmail(s) {
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
                }

                function syncHiddenFromDOM() {
                    const list = Array.from(box.querySelectorAll('.nl-chip'))
                        .map(ch => ch.dataset.email)
                        .filter(Boolean);
                    ta.value = list.join(', ');
                    input.placeholder = 'Add BCC emails';
                }

                function makeChip(email) {
                    const chip = document.createElement('span');
                    chip.className = 'nl-chip';
                    chip.dataset.email = email;
                    chip.innerHTML = `
                        <span>${email}</span>
                        <button type="button" class="remove" aria-label="Remove ${email}">x</button>
                    `;
                    return chip;
                }

                function addEmail(email) {
                    if (!email || !isEmail(email)) return;
                    const sel = `.nl-chip[data-email="${CSS.escape(email)}"]`;
                    if (box.querySelector(sel)) return;
                    box.insertBefore(makeChip(email), input);
                    syncHiddenFromDOM();
                }

                function addTokens(str) {
                    String(str).split(/[,\n;\s]+/).filter(Boolean).forEach(t => {
                        addEmail(normalize(t));
                    });
                }

                addTokens(ta.value || '');

                input.addEventListener('keydown', (e) => {
                    if (['Enter', 'Tab'].includes(e.key) || e.key === ',' || e.key === ';') {
                        e.preventDefault();
                        if (input.value.trim()) { addTokens(input.value); input.value = ''; }
                    } else if (e.key === 'Backspace' && !input.value) {
                        const last = box.querySelector('.nl-chip:last-of-type');
                        if (last) { last.remove(); syncHiddenFromDOM(); }
                    }
                });

                input.addEventListener('paste', (e) => {
                    const text = (e.clipboardData || window.clipboardData).getData('text');
                    if (/[,\n;\s]/.test(text)) { e.preventDefault(); addTokens(text); }
                });

                input.addEventListener('blur', () => {
                    if (input.value.trim()) { addTokens(input.value); input.value = ''; }
                });

                box.addEventListener('click', (e) => {
                    const btn = e.target.closest('.remove');
                    if (!btn) return;
                    const chip = btn.closest('.nl-chip');
                    if (chip) { chip.remove(); syncHiddenFromDOM(); }
                });

                new MutationObserver(syncHiddenFromDOM).observe(box, { childList: true });

                document.getElementById('sendEmailBtn')?.addEventListener('click', () => {
                    if (input.value.trim()) { addTokens(input.value); input.value = ''; }
                    syncHiddenFromDOM();
                });

                syncHiddenFromDOM();
            })();
        </script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const selector = document.getElementById('email_list_selector');
                const deleteBtn = document.getElementById('delete_list_btn');
                const saveContainer = document.getElementById('save_list_container');
                const newListNameInput = document.getElementById('new_list_name');
                const saveBtn = document.getElementById('save_list_btn');
                const cancelBtn = document.getElementById('cancel_save_btn');
                const bccChipsContainer = document.getElementById('bcc_chips');
                const emailInput = document.getElementById('email_chip_input');
                
                const allUserEmails = {{ user_dict.values() | list | tojson }};
                
                function collectEmailsFromChips() {
                    return Array.from(document.querySelectorAll('#bcc_chips .nl-chip'))
                        .map(ch => ch.dataset.email)
                        .filter(Boolean);
                }
                
                function clearAllChips() {
                    document.querySelectorAll('#bcc_chips .nl-chip').forEach(chip => chip.remove());
                }
                
                function addEmailChip(email) {
                    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return;
                    const sel = `.nl-chip[data-email="${CSS.escape(email)}"]`;
                    if (bccChipsContainer.querySelector(sel)) return;
                    
                    const chip = document.createElement('span');
                    chip.className = 'nl-chip';
                    chip.dataset.email = email;
                    chip.innerHTML = `
                        <span>${email}</span>
                        <button type="button" class="remove" aria-label="Remove ${email}">x</button>
                    `;
                    bccChipsContainer.insertBefore(chip, emailInput);
                }
                
                function setReadOnlyMode(readOnly) {
                    const chips = document.querySelectorAll('#bcc_chips .nl-chip .remove');
                    chips.forEach(btn => {
                        btn.style.display = readOnly ? 'none' : 'inline';
                    });
                    emailInput.disabled = readOnly;
                    if (readOnly) {
                        emailInput.placeholder = 'Read-only mode';
                    } else {
                        emailInput.placeholder = 'Add BCC emails';
                    }
                }
                
                selector.addEventListener('change', async () => {
                    const selectedValue = selector.value;
                    
                    deleteBtn.classList.add('d-none');
                    saveContainer.classList.add('d-none');
                    
                    if (selectedValue === 'Custom') {
                        setReadOnlyMode(false);
                    } else if (selectedValue === 'ALL') {
                        clearAllChips();
                        allUserEmails.forEach(email => addEmailChip(email));
                        setReadOnlyMode(true);
                    } else if (selectedValue === '(Save new list)') {
                        saveContainer.classList.remove('d-none');
                        newListNameInput.focus();
                        setReadOnlyMode(false);
                    } else {
                        const option = selector.querySelector(`option[value="${selectedValue}"]`);
                        if (option) {
                            const emails = option.dataset.emails;
                            clearAllChips();
                            emails.split(', ').forEach(email => addEmailChip(email.trim()));
                            deleteBtn.classList.remove('d-none');
                            setReadOnlyMode(false);
                        }
                    }
                });
                
                saveBtn.addEventListener('click', async () => {
                    const name = newListNameInput.value.trim();
                    if (!name) {
                        alert('Please enter a list name');
                        return;
                    }
                    
                    const emails = collectEmailsFromChips();
                    if (emails.length === 0) {
                        alert('Cannot save empty email list');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/email_lists', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: name,
                                emails: emails.join(', ')
                            })
                        });
                        
                        const result = await response.json();
                        if (result.status === 'success') {
                            const newOption = document.createElement('option');
                            newOption.value = 'temp_' + Date.now();
                            newOption.textContent = name;
                            newOption.dataset.emails = emails.join(', ');
                            selector.insertBefore(newOption, selector.querySelector('option[value="(Save new list)"]'));
                            
                            selector.value = newOption.value;
                            saveContainer.classList.add('d-none');
                            newListNameInput.value = '';
                            deleteBtn.classList.remove('d-none');
                            
                            alert(result.message);
                            
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            alert(result.message);
                        }
                    } catch (error) {
                        alert('Error saving list: ' + error.message);
                    }
                });
                
                cancelBtn.addEventListener('click', () => {
                    saveContainer.classList.add('d-none');
                    newListNameInput.value = '';
                    selector.value = 'Custom';
                });
                
                deleteBtn.addEventListener('click', async () => {
                    const selectedValue = selector.value;
                    const option = selector.querySelector(`option[value="${selectedValue}"]`);
                    
                    if (!option || !confirm(`Delete list "${option.textContent}"?`)) return;
                    
                    try {
                        const response = await fetch(`/email_lists/${selectedValue}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        if (result.status === 'success') {
                            option.remove();
                            selector.value = 'Custom';
                            deleteBtn.classList.add('d-none');
                            alert(result.message);
                        } else {
                            alert(result.message);
                        }
                    } catch (error) {
                        alert('Error deleting list: ' + error.message);
                    }
                });
                
                setReadOnlyMode(false);
            });
        </script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const bccHeader = document.querySelector('[onclick*="bcc-collapse"]');
                if (bccHeader) {
                    bccHeader.addEventListener('click', () => {
                        const icon = document.getElementById('bcc-toggle-icon');
                        const collapse = document.getElementById('bcc-collapse');
                        if (collapse.classList.contains('d-none')) {
                            icon.style.transform = 'rotate(0deg)';
                            icon.textContent = '▼';
                        } else {
                            icon.style.transform = 'rotate(-90deg)';
                            icon.textContent = '▶';
                        }
                    });
                }
                
                document.getElementById('bcc-collapse').classList.add('d-none');
                document.getElementById('bcc-toggle-icon').style.transform = 'rotate(-90deg)';
                document.getElementById('bcc-toggle-icon').textContent = '▶';
                
                const clearCacheBtn = document.getElementById('clear_cache_btn');
                if (clearCacheBtn) {
                    clearCacheBtn.addEventListener('click', async () => {
                        try {
                            clearCacheBtn.textContent = 'Clearing...';
                            clearCacheBtn.disabled = true;
                            
                            const response = await fetch('/clear_cache', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                clearCacheBtn.textContent = 'Cleared!';
                                clearCacheBtn.style.backgroundColor = '#28a745';
                                setTimeout(() => {
                                    clearCacheBtn.textContent = 'Clear Cache';
                                    clearCacheBtn.style.backgroundColor = '#dc3545';
                                    clearCacheBtn.disabled = false;
                                }, 2000);
                            } else {
                                throw new Error('Failed to clear cache');
                            }
                        } catch (error) {
                            console.error('Error clearing cache:', error);
                            clearCacheBtn.textContent = 'Error';
                            clearCacheBtn.style.backgroundColor = '#dc3545';
                            setTimeout(() => {
                                clearCacheBtn.textContent = 'Clear Cache';
                                clearCacheBtn.disabled = false;
                            }, 2000);
                        }
                    });
                }
            });

            let emailTemplates = [];

            async function loadEmailTemplates() {
                try {
                    const response = await fetch('/email_templates');
                    emailTemplates = await response.json();
                    updateTemplateDropdown();
                } catch (error) {
                    console.error('Error loading templates:', error);
                }
            }

            function updateTemplateDropdown() {
                const selector = document.getElementById('template-selector');
                
                while (selector.children.length > 2) {
                    selector.removeChild(selector.lastChild);
                }
                
                emailTemplates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    selector.appendChild(option);
                });
            }

            document.getElementById('template-selector').addEventListener('change', async function() {
                const value = this.value;
                const deleteBtn = document.getElementById('delete-template-btn');
                
                if (value === 'save-template') {
                    const templateName = prompt('Enter template name:');
                    if (templateName && templateName.trim()) {
                        await saveCurrentTemplate(templateName.trim());
                    }
                    this.value = '';
                    deleteBtn.style.display = 'none';
                } else if (value === '') {
                    deleteBtn.style.display = 'none';
                } else {
                    const templateId = parseInt(value);
                    const template = emailTemplates.find(t => t.id === templateId);
                    if (template) {
                        loadTemplate(template);
                        deleteBtn.style.display = 'inline-block';
                        deleteBtn.dataset.templateId = templateId;
                    }
                }
            });

            document.getElementById('reset-template-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to reset? This will clear all selected items and reset to Custom template.')) {
                    selectedItems.length = 0;
                    
                    document.getElementById('template-selector').value = '';
                    
                    document.getElementById('delete-template-btn').style.display = 'none';
                    
                    document.querySelectorAll('.add-stat-btn, .add-graph-btn, .ra-add-btn, .recs-add-btn').forEach(btn => {
                        btn.textContent = 'Add';
                        btn.classList.remove('btn-success');
                        btn.classList.add('button');
                        btn.disabled = false;
                    });
                    
                    updateSelectedItemsDisplay();
                    
                    textBlockCounter = 0;
                }
            });

            async function saveCurrentTemplate(name) {
                try {
                    const textBlocks = selectedItems
                        .filter(item => item.type === 'textblock' || item.type === 'titleblock' || item.type === 'headerblock')
                        .map(item => getTextBlockContent(item.id))
                        .filter(content => content.trim().length > 0);
                    
                    const itemsWithContent = selectedItems.map(item => {
                        if (item.type === 'textblock' || item.type === 'titleblock' || item.type === 'headerblock') {
                            return {
                                ...item,
                                content: getTextBlockContent(item.id) || ''
                            };
                        }
                        return item;
                    });
                    
                    const templateData = {
                        name: name,
                        selected_items: JSON.stringify(itemsWithContent),
                        email_text: textBlocks.join('\n\n'),
                        subject: document.getElementById('subject').value
                    };

                    const response = await fetch('/email_templates', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(templateData)
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        console.log('Template saved successfully');
                        await loadEmailTemplates();
                    } else {
                        alert('Error saving template: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error saving template:', error);
                    alert('Error saving template');
                }
            }

            function ensureTitleOnTop() {
                const i = selectedItems.findIndex(it => it.type === 'titleblock');
                if (i > 0) {
                    const [t] = selectedItems.splice(i, 1);
                    selectedItems.unshift(t);
                }
            }

            function loadTemplate(template) {
                try {
                    const items = JSON.parse(template.selected_items);
                    
                    selectedItems = [];
                    
                    document.querySelectorAll('.add-stat-btn, .add-graph-btn, .ra-add-btn, .recs-add-btn').forEach(btn => {
                        btn.textContent = 'Add';
                        btn.classList.remove('btn-success');
                        btn.classList.add('button');
                        btn.disabled = false;
                    });
                    
                    selectedItems = items.map(item => {
                        if ((item.type === 'textblock' || item.type === 'titleblock' || item.type === 'headerblock') && item.content) {
                            if (item.type === 'textblock' && item.id.startsWith('text-block-')) {
                                const counter = parseInt(item.id.split('-')[2]);
                                if (counter >= textBlockCounter) {
                                    textBlockCounter = counter;
                                }
                            } else if (item.type === 'titleblock' && item.id.startsWith('title-block-')) {
                                const counter = parseInt(item.id.split('-')[2]);
                                if (counter >= titleBlockCounter) {
                                    titleBlockCounter = counter;
                                }
                            } else if (item.type === 'headerblock' && item.id.startsWith('header-block-')) {
                                const counter = parseInt(item.id.split('-')[2]);
                                if (counter >= headerBlockCounter) {
                                    headerBlockCounter = counter;
                                }
                            } else if (item.type === 'textblock' && item.id.startsWith('intro-block-')) {
                                const counter = parseInt(item.id.split('-')[2]);
                                if (counter >= textBlockCounter) {
                                    textBlockCounter = counter;
                                }
                            } else if (item.type === 'textblock' && item.id.startsWith('outro-block-')) {
                                const counter = parseInt(item.id.split('-')[2]);
                                if (counter >= textBlockCounter) {
                                    textBlockCounter = counter;
                                }
                            }
                        }
                        return { ...item };
                    });
                    
                    selectedItems.forEach(item => {
                        if (item.type === 'graph' && !renderedCharts.has(item.id)) {
                            try {
                                const index = parseInt(item.id.split('-')[1]);
                                const graphData = graphDataList[index];

                                if (graphData && graphCommands[index]) {
                                    Highcharts.chart(item.id, {
                                        chart: { type: 'line' },
                                        title: { text: graphCommands[index].name },
                                        exporting: {
                                            enabled: true
                                        },
                                        xAxis: { categories: graphData.categories },
                                        yAxis: { title: { text: 'Plays' } },
                                        series: graphData.series
                                    });

                                    renderedCharts.add(item.id);
                                    
                                    const nowDark = document.documentElement.classList.contains('dark');
                                    applyChartTheme(nowDark);
                                    
                                    console.log('Auto-rendered graph during template load:', item.id);
                                }
                            } catch (error) {
                                console.warn('Failed to auto-render graph during template load', item.id, error);
                            }
                        }
                    });
                    
                    selectedItems.forEach(item => {
                        const button = document.querySelector(`[data-id="${item.id}"]`);
                        if (button) {
                            button.textContent = 'Added';
                            button.classList.remove('button');
                            button.classList.add('btn-success');
                            button.disabled = true;
                        }
                    });
                    
                    document.getElementById('subject').value = template.subject || '';
                    
                    ensureTitleOnTop();
                    updateSelectedItemsDisplay();
                    
                    setTimeout(() => {
                        selectedItems.forEach(item => {
                            if ((item.type === 'textblock' || item.type === 'titleblock' || item.type === 'headerblock') && item.content) {
                                setTextBlockContent(item.id, item.content);
                            }
                        });
                        updatePreview();
                    }, 100);
                    
                    console.log('Template loaded:', template.name);
                } catch (error) {
                    console.error('Error loading template:', error);
                    alert('Error loading template');
                }
            }

            document.getElementById('delete-template-btn').addEventListener('click', async function() {
                const templateId = this.dataset.templateId;
                if (!templateId) return;
                
                const template = emailTemplates.find(t => t.id == templateId);
                if (!template) return;
                
                if (confirm(`Are you sure you want to delete the template "${template.name}"?`)) {
                    try {
                        const response = await fetch(`/email_templates/${templateId}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        if (result.status === 'success') {
                            console.log('Template deleted successfully');
                            await loadEmailTemplates();
                            
                            document.getElementById('template-selector').value = '';
                            this.style.display = 'none';
                        } else {
                            alert('Error deleting template: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Error deleting template:', error);
                        alert('Error deleting template');
                    }
                }
            });

            document.getElementById('popout-preview-btn').addEventListener('click', function() {
                const frame = document.getElementById('preview');
                if (!frame || !frame.srcdoc) {
                    alert('No preview content available');
                    return;
                }
                
                const popupWindow = window.open('', 'EmailPreview', 'width=800,height=600,scrollbars=yes,resizable=yes');
                
                if (popupWindow) {
                    popupWindow.document.open();
                    popupWindow.document.write(frame.srcdoc);
                    popupWindow.document.close();
                    
                    popupWindow.document.title = 'Email Preview';
                    
                    popupWindow.focus();
                } else {
                    alert('Pop-up blocked! Please allow pop-ups for this site to use the preview feature.');
                }
            });

            document.addEventListener('DOMContentLoaded', () => {
                loadEmailTemplates();
            });
        </script>

        <script>
            let movieCollections = [];
            let showCollections = [];

            async function loadCollections() {
                try {
                    document.getElementById('movie-collections-loading').classList.remove('d-none');
                    const movieResponse = await fetch('/fetch_collections/movie');
                    const movieData = await movieResponse.json();
                    
                    if (movieData.status === 'success') {
                        movieCollections = movieData.collections;
                        populateCollectionsDropdown('movie-collections-dropdown', movieCollections);
                    } else {
                        console.error('Error loading movie collections:', movieData.message);
                    }
                    document.getElementById('movie-collections-loading').classList.add('d-none');

                    document.getElementById('show-collections-loading').classList.remove('d-none');
                    const showResponse = await fetch('/fetch_collections/show');
                    const showData = await showResponse.json();
                    
                    if (showData.status === 'success') {
                        showCollections = showData.collections;
                        populateCollectionsDropdown('show-collections-dropdown', showCollections);
                    } else {
                        console.error('Error loading show collections:', showData.message);
                    }
                    document.getElementById('show-collections-loading').classList.add('d-none');

                    document.getElementById('audio-collections-loading').classList.remove('d-none');
                    const audioResponse = await fetch('/fetch_collections/artist');
                    const audioData = await audioResponse.json();
                    
                    if (audioData.status === 'success') {
                        audioCollections = audioData.collections;
                        populateCollectionsDropdown('audio-collections-dropdown', audioCollections);
                    } else {
                        console.error('Error loading audio collections:', audioData.message);
                    }
                    document.getElementById('audio-collections-loading').classList.add('d-none');

                } catch (error) {
                    console.error('Error loading collections:', error);
                    document.getElementById('movie-collections-loading').classList.add('d-none');
                    document.getElementById('show-collections-loading').classList.add('d-none');
                    document.getElementById('audio-collections-loading').classList.add('d-none');
                }
            }

            function populateCollectionsDropdown(dropdownId, collections) {
                const dropdown = document.getElementById(dropdownId);
                
                while (dropdown.children.length > 1) {
                    dropdown.removeChild(dropdown.lastChild);
                }

                collections.forEach(collection => {
                    const option = document.createElement('option');
                    option.value = collection.key;
                    option.textContent = `${collection.title} (${collection.childCount} items)`;
                    option.dataset.collection = JSON.stringify(collection);
                    dropdown.appendChild(option);
                });
            }

            function buildCollectionPreviewHTML(collection) {
                const typeIcon = collection.subtype === 'movie' ? '📽️' : collection.subtype === 'movie' ? '📺' : '🎧';
                
                return `
                    <div class="collection-preview card my-3">
                        <div class="card-header d-flex align-items-center">
                            <span class="me-2" style="font-size: 1.2em;">${typeIcon}</span>
                            <h5 class="mb-0">${collection.title}</h5>
                            <span class="badge bg-secondary ms-auto">${collection.childCount} items</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    ${collection.thumb ? 
                                        `<img src="${collection.thumb}" class="img-fluid rounded" alt="${collection.title}" style="max-height: 200px; object-fit: cover;">` :
                                        `<div class="placeholder-image d-flex align-items-center justify-content-center bg-light rounded" style="height: 200px;">
                                            <span class="text-muted">${typeIcon} No Poster</span>
                                        </div>`
                                    }
                                </div>
                                <div class="col-md-9">
                                    <p><strong>Library:</strong> ${collection.sectionTitle}</p>
                                    <p><strong>Type:</strong> ${collection.subtype.charAt(0).toUpperCase() + collection.subtype.slice(1)} Collection</p>
                                    ${collection.summary ? `<p><strong>Description:</strong> ${collection.summary}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('movie-collections-dropdown').addEventListener('change', function() {
                const button = document.getElementById('add-movie-collection-btn');
                
                if (this.value) {
                    button.disabled = false;
                } else {
                    button.disabled = true;
                }
                
                document.getElementById('show-collections-dropdown').value = '';
                document.getElementById('add-show-collection-btn').disabled = true;
                document.getElementById('audio-collections-dropdown').value = '';
                document.getElementById('add-audio-collection-btn').disabled = true;
            });

            document.getElementById('show-collections-dropdown').addEventListener('change', function() {
                const button = document.getElementById('add-show-collection-btn');
                
                if (this.value) {
                    button.disabled = false;
                } else {
                    button.disabled = true;
                }
                
                document.getElementById('movie-collections-dropdown').value = '';
                document.getElementById('add-movie-collection-btn').disabled = true;
                document.getElementById('audio-collections-dropdown').value = '';
                document.getElementById('add-audio-collection-btn').disabled = true;
            });

            document.getElementById('audio-collections-dropdown').addEventListener('change', function() {
                const button = document.getElementById('add-audio-collection-btn');
                
                if (this.value) {
                    button.disabled = false;
                } else {
                    button.disabled = true;
                }
                
                document.getElementById('movie-collections-dropdown').value = '';
                document.getElementById('add-movie-collection-btn').disabled = true;
                document.getElementById('show-collections-dropdown').value = '';
                document.getElementById('add-show-collection-btn').disabled = true;
            });

            document.getElementById('add-movie-collection-btn').addEventListener('click', function() {
                const dropdown = document.getElementById('movie-collections-dropdown');
                if (dropdown.value) {
                    const collection = JSON.parse(dropdown.selectedOptions[0].dataset.collection);
                    addCollectionItem(collection);
                }
            });

            document.getElementById('add-show-collection-btn').addEventListener('click', function() {
                const dropdown = document.getElementById('show-collections-dropdown');
                if (dropdown.value) {
                    const collection = JSON.parse(dropdown.selectedOptions[0].dataset.collection);
                    addCollectionItem(collection);
                }
            });

            document.getElementById('add-audio-collection-btn').addEventListener('click', function() {
                const dropdown = document.getElementById('audio-collections-dropdown');
                if (dropdown.value) {
                    const collection = JSON.parse(dropdown.selectedOptions[0].dataset.collection);
                    addCollectionItem(collection);
                }
            });

            let collectionGroupCounter = 0;

            document.getElementById('add-collection-group-btn').addEventListener('click', function() {
                collectionGroupCounter++;
                const groupId = `collection-group-${collectionGroupCounter}`;
                
                const newGroup = {
                    id: groupId,
                    name: 'Collection Group',
                    type: 'collection_group',
                    title: 'New Collection Group',
                    collections: []
                };
                
                selectedItems.push(newGroup);
                updateSelectedItemsDisplay();
            });

            function addCollectionItem(collection) {
                let targetGroup = null;
                for (let i = selectedItems.length - 1; i >= 0; i--) {
                    if (selectedItems[i].type === 'collection_group') {
                        targetGroup = selectedItems[i];
                        break;
                    }
                }
                
                if (!targetGroup) {
                    collectionGroupCounter++;
                    targetGroup = {
                        id: `collection-group-${collectionGroupCounter}`,
                        name: 'Collection Group',
                        type: 'collection_group',
                        title: 'New Collection Group',
                        collections: []
                    };
                    selectedItems.push(targetGroup);
                }
                
                const exists = targetGroup.collections.some(c => c.key === collection.key);
                if (exists) {
                    console.log('Collection already in this group:', collection.title);
                    return;
                }
                
                targetGroup.collections.push(collection);
                updateSelectedItemsDisplay();
                
                document.getElementById('movie-collections-dropdown').value = '';
                document.getElementById('show-collections-dropdown').value = '';
                document.getElementById('audio-collections-dropdown').value = '';
                document.getElementById('add-movie-collection-btn').disabled = true;
                document.getElementById('add-show-collection-btn').disabled = true;
                ment.getElementById('add-audio-collection-btn').disabled = true;
                
                console.log('Added collection to group:', collection.title);
            }

            document.addEventListener('DOMContentLoaded', loadCollections);
        </script>
    </div>
</div>
{% endblock %}
