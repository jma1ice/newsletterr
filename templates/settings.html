{% extends "base.html" %}
{% block title %}settings{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>settings</h1>
    </div>
    {% if settings.from_email == '' %}
        <p style="color: #770010; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">
            Welcome to newsletterr! Please enter in your settings below, if you have any questions about them please see the readme.md file for an explanation.
        </p>
    {% else %}
        <p class="text-info mb-4">Configure your application settings, Plex connection, and email preferences.</p>
    {% endif %}
    {% if alert %}
        <p style="color: #01b301; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">{{ alert }}</p>
    {% endif %}
    {% if error %}
        <p style="color: #770010; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">{{ error }}</p>
    {% endif %}
    <div class="foreground">
        <div style="margin: 0px 0px 0px 15px;">
            <div>
                <h3>Plex Account</h3>
                <button id="connect_plex" class="button">Connect Plex</button>
                <div id="plex_status">{% if settings.plex_token %}<p style="padding-left: 8px; color: #01b301; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">Connected</p>{% endif %}</div>
            </div><br>

            <form method="POST" id="settings_form">
                <label for="from_email">From:</label><br>
                <input type="email" id="from_email" name="from_email"
                    {% if settings.from_email != "" %}value="{{ settings.from_email }}"{% endif %}
                    placeholder="Your email" required><br><br>

                <label for="from_name">From Name (Optional - used to specify a name for who the email is from, shows next to email address):</label><br>
                <input type="text" id="from_name" name="from_name"
                    {% if settings.from_name != "" %}value="{{ settings.from_name }}"{% endif %}
                    placeholder="Your name"><br><br>

                <label for="alias_email">Send-As Alias (Optional - used for domain specific email addresses):</label><br>
                <input type="email" id="alias_email" name="alias_email"
                    {% if settings.alias_email != "" %}value="{{ settings.alias_email }}"{% endif %}
                    placeholder="Blank if no alias"><br><br>

                <label for="reply_to_email">Reply-To (Optional - used to specify a specific email address for replies):</label><br>
                <input type="email" id="reply_to_email" name="reply_to_email"
                    {% if settings.reply_to_email != "" %}value="{{ settings.reply_to_email }}"{% endif %}
                    placeholder="Optional reply-to email"><br><br>

                <label for="password">Password:</label><br>
                <input type="password" id="password" name="password"
                    {% if settings.password != "" %}value="{{ settings.password }}"{% endif %}
                    placeholder="Email Password or App Password" required><br><br>

                <label for="smtp_username">SMTP Username (Optional - used for SMTP clients that need username login):</label><br>
                <input type="text" id="smtp_username" name="smtp_username"
                    {% if settings.smtp_username != "" %}value="{{ settings.smtp_username }}"{% endif %}
                    placeholder="Leave blank to use your email address"><br><br>

                <label for="smtp_server">SMTP Server:</label><br>
                <input type="text" id="smtp_server" name="smtp_server"
                    {% if settings.smtp_server != "" %}value="{{ settings.smtp_server }}"{% endif %}
                    placeholder="SMTP Server (e.g. smtp.gmail.com)" required><br><br>

                <label for="smtp_port">SMTP Port:</label><br>
                <input type="number" id="smtp_port" name="smtp_port"
                    {% if settings.smtp_port != "" %}value="{{ settings.smtp_port }}"{% endif %}
                    placeholder="SMTP Port (i.e. 465 or 587)" required><br><br>

                <label for="smtp_protocol">SMTP Protocol (SSL typically used with port 465, TLS typically used with port 587):</label><br>
                <select id="smtp_protocol" name="smtp_protocol">
                    <option value="SSL" {% if settings.smtp_protocol == "SSL" %}selected{% endif %}>SSL</option>
                    <option value="TLS" {% if settings.smtp_protocol == "TLS" %}selected{% endif %}>TLS</option>
                </select><br><br>

                <label for="server_name">Plex Server Name:</label><br>
                <input type="text" id="server_name" name="server_name"
                    {% if settings.server_name != "" %}value="{{ settings.server_name }}"{% endif %}
                    placeholder="Paramount Plex" required><br><br>

                <label for="plex_url">Plex URL (Optional - used for posters on 'recently added' and 'stats'):</label><br>
                <input type="text" id="plex_url" name="plex_url"
                    {% if settings.plex_url != "" %}value="{{ settings.plex_url }}"{% endif %}
                    placeholder="http://localhost:32400"><br><br>

                <label for="tautulli_url">Tautulli Base URL (Optional - used for user emails, stats, graphs, and recently added):</label><br>
                <input type="text" id="tautulli_url" name="tautulli_url"
                    {% if settings.tautulli_url != "" %}value="{{ settings.tautulli_url }}"{% endif %}
                    placeholder="http://localhost:8181"><br><br>

                <label for="tautulli_api">Tautulli API Key (Optional - see above):</label><br>
                <input type="text" id="tautulli_api" name="tautulli_api"
                    {% if settings.tautulli_api != "" %}value="{{ settings.tautulli_api }}"{% endif %}
                    placeholder="Tautulli API Key"><br><br>

                <label for="conjurr_url">Conjurr Base URL (Optional - used for recommendations):</label><br>
                <input type="text" id="conjurr_url" name="conjurr_url"
                    {% if settings.conjurr_url != "" %}value="{{ settings.conjurr_url }}"{% endif %}
                    placeholder="http://localhost:2665"><br><br>

                <label for="recipient_display_name">Recipient Display Name (used in recommendation emails):</label><br>
                <select id="recipient_display_name" name="recipient_display_name">
                    <option value="email" {% if settings.recipient_display_name == 'email' %}selected{% endif %}>Email Address</option>
                    <option value="username" {% if settings.recipient_display_name == 'username' %}selected{% endif %}>Username</option>
                    <option value="friendly_name" {% if settings.recipient_display_name == 'friendly_name' %}selected{% endif %}>Friendly Name</option>
                </select><br><br>

                <label for="logo_filename">Logo File (Optional - used for custom logos at the top of emails. Email Theme must be custom to change!):</label><br>
                <select id="logo_filename" name="logo_filename">
                    <option value="newsletterr_blue_small"
                        {% if settings.logo_filename == 'Asset_54x.png' %}selected{% endif %}
                    >Newsletterr Square Blue</option>
                    <option value="newsletterr_orange_small"
                        {% if settings.logo_filename == 'Asset_46x.png' %}selected{% endif %}
                    >Newsletterr Square Orange</option>
                    <option value="newsletterr_blue_banner"
                        {% if settings.email_theme == 'newsletterr_blue' or settings.logo_filename == 'Asset_94x.png' %}selected{% endif %}
                    >Newsletterr Banner Blue</option>
                    <option value="newsletterr_orange_banner"
                        {% if settings.email_theme == 'plex_orange' or settings.logo_filename == 'Asset_45x.png' %}selected{% endif %}
                    >Newsletterr Banner Orange</option>
                    <option value="custom"
                        {% if settings.logo_filename == 'custom' %}selected{% endif %}
                    >Custom</option>
                    <option value="none"
                        {% if settings.logo_filename == '' %}selected{% endif %}
                    >No Logo</option>
                </select><br>

                <div class="logo-preview-small">
                    {% if settings.logo_filename %}
                        {% if settings.logo_filename == 'custom' %}
                            <img src="/static/uploads/logos/{{ settings.logo_filename }}" alt="Current Logo" class="logo-preview-img-small" />
                        {% else %}
                            <img src="/static/img/{{ settings.logo_filename }}" alt="Current Logo" class="logo-preview-img-small" />
                        {% endif %}
                        <span class="logo-filename-small">{{ settings.logo_filename }}</span>
                    {% endif %}
                </div><br>

                <div id="upload_logo_div" style="display: {% if settings.logo_filename == 'custom' %}block{% else %}none{% endif %};">
                    <label for="logo_file">Upload Custom Logo:</label><br>
                    <input type="file" id="logo_file" name="logo_file" accept="image/png,image/jpg,image/jpeg,image/webp" />
                    <button type="button" id="upload_logo" class="btn button btn-sm" disabled>Upload</button>
                    {% if settings.logo_filename == 'custom' and settings.custom_logo_filename %}
                        <button type="button" id="delete_logo" class="btn button btn-sm" style="display: inline-block;">Delete</button>
                    {% else %}
                        <button type="button" id="delete_logo" class="btn button btn-sm" style="display: none;">Delete</button>
                    {% endif %}

                    <input type="hidden" id="custom_logo_filename" name="custom_logo_filename" 
                        {% if settings.custom_logo_filename %}value="{{ settings.custom_logo_filename }}"{% endif %} /><br><br>
                </div>

                <label for="logo_width">Logo Width (Optional - used to size custom logos):</label><br>
                <input type="number" id="logo_width" name="logo_width"
                    {% if settings.logo_width != "" %}value="{{ settings.logo_width }}"{% endif %}
                    placeholder="80"><br><br>

                <label for="email_theme">Email Theme (must choose custom to change the logo file):</label><br>
                <select id="email_theme" name="email_theme">
                    <option value="newsletterr_blue" {% if settings.email_theme == 'newsletterr_blue' %}selected{% endif %}>Newsletterr Blue</option>
                    <option value="plex_orange" {% if settings.email_theme == 'plex_orange' %}selected{% endif %}>Plex Orange</option>
                    <option value="custom" {% if settings.email_theme == 'custom' %}selected{% endif %}>Custom</option>
                </select><br><br>

                <div id="color_inputs" style="display: {% if settings.email_theme == 'custom' %}block{% else %}none{% endif %};">
                    <label for="primary_color">Primary Color (Main brand color for headers and accents):</label>
                    <div class="input-group">
                        <input type="color" id="primary_color" name="primary_color" value="{{ settings.primary_color }}">
                        <input type="text" value="{{ settings.primary_color }}" readonly>
                    </div><br>

                    <label for="secondary_color">Secondary Color (Secondary color for footers and borders):</label>
                    <div class="input-group">
                        <input type="color" id="secondary_color" name="secondary_color" value="{{ settings.secondary_color }}">
                        <input type="text" value="{{ settings.secondary_color }}" readonly>
                    </div><br>

                    <label for="accent_color">Accent Color (Accent color for links and highlights):</label>
                    <div class="input-group">
                        <input type="color" id="accent_color" name="accent_color" value="{{ settings.accent_color }}">
                        <input type="text" value="{{ settings.accent_color }}" readonly>
                    </div><br>

                    <label for="background_color">Background Color:</label>
                    <div class="input-group">
                        <input type="color" id="background_color" name="background_color" value="{{ settings.background_color }}">
                        <input type="text" value="{{ settings.background_color }}" readonly>
                    </div><br>

                    <label for="text_color">Text Color:</label>
                    <div class="input-group">
                        <input type="color" id="text_color" name="text_color" value="{{ settings.text_color }}">
                        <input type="text" value="{{ settings.text_color }}" readonly>
                    </div><br>
                </div>
                
                <button id="apply_settings" class="button">Apply Settings</button>
            </form>
        </div>
        <script>
            document.getElementById('settings_form').addEventListener('submit', (e) => {
                showSpinner('Applying settings...');
            });
        </script>
        <script>
            document.querySelectorAll('input[type="color"]').forEach(colorInput => {
                const textInput = colorInput.parentElement.querySelector('input[type="text"]');
                
                colorInput.addEventListener('change', function() {
                    textInput.value = this.value;
                });
                
                textInput.addEventListener('change', function() {
                    if (this.value.match(/^#[0-9A-F]{6}$/i)) {
                        colorInput.value = this.value;
                    }
                });
            });
        </script>
        <script>
            document.getElementById('email_theme').addEventListener('change', function() {
                const colorInputs = document.getElementById('color_inputs');
                if (this.value === 'custom') {
                    colorInputs.style.display = 'block';
                } else {
                    colorInputs.style.display = 'none';
                }
            });
        </script>
        <script>
            function openCenteredPopup(url, w = 520, h = 680, name = 'plex-auth', offsetX = 0, offsetY = 0) {
                const dualLeft = window.screenLeft ?? window.screenX;
                const dualTop  = window.screenTop  ?? window.screenY;

                const vw = window.innerWidth  || document.documentElement.clientWidth  || screen.width;
                const vh = window.innerHeight || document.documentElement.clientHeight || screen.height;

                let left = dualLeft + (vw - w) / 2 + offsetX;
                let top  = dualTop  + (vh - h) / 2 + offsetY;

                left = Math.max(dualLeft, Math.min(left, dualLeft + vw - w));
                top  = Math.max(dualTop,  Math.min(top,  dualTop  + vh - h));

                const features = `width=${w},height=${h},left=${Math.round(left)},top=${Math.round(top)},` +
                                `resizable=yes,scrollbars=yes,toolbar=no,menubar=no,location=yes,noopener,noreferrer`;

                const win = window.open(url, name, features);

                try {
                    win.focus();
                } catch (e) {
                    console.warn('Could not focus popup window');
                    if (!win) {
                        return null;
                    }
                }

                return win;
            }

            function showPopupBlockedWarning() {
                const statusEl = document.getElementById('plex_status');
                statusEl.innerHTML = `
                    <div style="color: #f39c12; margin: 10px 0;">
                        <strong>Popup Blocked!</strong><br>
                        Please allow popups for this site and try again.<br>
                        <small>Look for a popup blocker icon in your browser's address bar.</small>
                    </div>
                `;
            }

            function createManualLinkFallback(authUrl, code) {
                const statusEl = document.getElementById('plex_status');
                statusEl.innerHTML = `
                    <div style="color: #3498db; margin: 10px 0;">
                        <strong>Manual Authorization May Be Required</strong><br>
                        Enter this code into Plex: <strong style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">${code}</strong><br>
                        <a href="${authUrl}" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: underline;">
                            Click here to open Plex authorization page if it did not pop up
                        </a>
                    </div>
                `;
            }
            
            const button = document.getElementById('connect_plex');
            const statusEl = document.getElementById('plex_status');
            let pollTimer = null;
            let connected_to_plex = false;

            button?.addEventListener('click', async () => {
                button.disabled = true;
                statusEl.textContent = '';
                showSpinner('Waiting for Plex approval...');

                try {
                    const r = await fetch('/api/plex/pin', {method: 'POST'});
                    if (!r.ok) throw new Error('Failed to create PIN');
                    const data = await r.json();

                    hideSpinner();
                    showSpinner(`Enter this code into Plex: ${data.code}`);
                    const authWin = openCenteredPopup(data.auth_url, 520, 480, 'plex-auth', 520);

                    if (!authWin) {
                        hideSpinner();
                        showPopupBlockedWarning();
                        setTimeout(() => {
                            createManualLinkFallback(data.auth_url, data.code);
                        }, 2000);
                        
                        startPolling(data, null);
                        return;
                    }

                    startPolling(data, authWin);
                } catch (e) {
                    hideSpinner();
                    statusEl.innerHTML = `
                        <div style="color: #e74c3c;">
                            <strong>Error starting Plex connection:</strong><br>
                            ${e.message}
                        </div>
                    `;
                    button.disabled = false;
                }
            });

            function startPolling(data, authWin) {
                const start = Date.now();
                const timeoutMs = (data.expires_in ?? 600) * 1000;

                async function waitForPIN() {
                    return new Promise((resolve, reject) => {
                        const poll = async () => {
                            const pollr = await fetch(`/api/plex/pin/${data.pin_id}`);
                            const polld = await pollr.json();
                            if (polld.connected) {
                                hideSpinner();
                                statusEl.textContent = 'Connected! Your Plex token is saved.';
                                clearInterval(pollTimer);
                                button.disabled = false;
                                resolve(polld);
                                return;
                            }
                            if (Date.now() - start > timeoutMs) {
                                hideSpinner();
                                statusEl.textContent = 'PIN expired. Please try again.';
                                clearInterval(pollTimer);
                                button.disabled = false;
                                reject(new Error('PIN expired.'));
                            }
                        };
                        pollTimer = setInterval(poll, 1500);
                        poll();
                    });
                }

                async function getPlexInfo(authWin) {
                    const polld = await waitForPIN();

                    showSpinner('Retreiving Plex information...');
                    const infor = await fetch('/api/plex/info', {method: 'GET'});
                    if (!infor.ok) throw new Error('Failed to get info');
                    const infod = await infor.json();

                    if (infod.connected) {
                        try { if (authWin && !authWin.closed) authWin.close(); } catch {}
                        hideSpinner();
                        statusEl.textContent = 'Plex information retrieved.';
                        setTimeout(() => location.replace(location.href), 2000);
                        return;
                    }
                }

                getPlexInfo(authWin);
            }

            document.addEventListener('keydown', function(event) {
                if (event.ctrlKey && event.key === 's') {
                    event.preventDefault();
                    
                    const settingsForm = document.getElementById('settings_form');
                    const applyButton = document.getElementById('apply_settings');
                    
                    if (settingsForm && applyButton) {
                        showSpinner('Applying settings...');
                        settingsForm.submit();
                    }
                }
            });
        </script>
        <script>
            const logoFileInput = document.getElementById('logo_file');
            const logoFilenameSelect = document.getElementById('logo_filename');
            const customLogoFilenameHidden = document.getElementById('custom_logo_filename');
            const uploadLogoBtn = document.getElementById('upload_logo');
            const deleteLogoBtn = document.getElementById('delete_logo');
            const uploadLogoDiv = document.getElementById('upload_logo_div');

            const preset_logo_name_to_file = {
                "newsletterr_blue_small": "Asset_54x.png",
                "newsletterr_orange_small": "Asset_46x.png",
                "newsletterr_blue_banner": "Asset_94x.png",
                "newsletterr_orange_banner": "Asset_45x.png"
            }

            const serverCustomLogoFilename = "{{ settings.custom_logo_filename if settings.custom_logo_filename else '' }}";

            logoFilenameSelect?.addEventListener('change', function() {
                const isCustomSelected = this.value === 'custom';
                const isNoneSelected = this.value === 'none' || this.value === '';
                
                uploadLogoDiv.style.display = isCustomSelected ? 'block' : 'none';
                
                if (!isCustomSelected) {
                    customLogoFilenameHidden.value = '';
                } else {
                    if (serverCustomLogoFilename && !customLogoFilenameHidden.value) {
                        customLogoFilenameHidden.value = serverCustomLogoFilename;
                    }
                }
                
                if (isCustomSelected) {
                    const customFilename = customLogoFilenameHidden.value || serverCustomLogoFilename;
                    if (customFilename) {
                        updateLogoPreview(customFilename, true);
                    } else {
                        updateLogoPreview('');
                    }
                } else if (isNoneSelected) {
                    updateLogoPreview('');
                } else {
                    updateLogoPreview(this.value, false);
                }
            });

            function updateLogoPreview(filename, isCustom = false) {
                const previewImg = document.querySelector('.logo-preview-img-small');
                const filenameSpan = document.querySelector('.logo-filename-small');
                const previewContainer = document.querySelector('.logo-preview-small');

                if (previewImg) previewImg.remove();
                if (filenameSpan) filenameSpan.remove();

                if (!filename || filename === 'none') {
                    const noLogoSpan = document.createElement('span');
                    noLogoSpan.className = 'logo-filename-small';
                    noLogoSpan.textContent = 'No logo';
                    previewContainer.appendChild(noLogoSpan);
                    return;
                }

                const imgEl = document.createElement('img');
                imgEl.className = 'logo-preview-img-small';

                let displayFilename = filename;
                
                if (isCustom) {
                    imgEl.src = `/static/uploads/logos/${filename}`;
                    imgEl.alt = 'Custom logo';
                    displayFilename = 'Custom logo';
                } else if (preset_logo_name_to_file[filename]) {
                    const actualFilename = preset_logo_name_to_file[filename];
                    imgEl.src = `/static/img/${actualFilename}`;
                    imgEl.alt = filename;
                    displayFilename = filename.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                } else {
                    imgEl.src = `/static/img/${filename}`;
                    imgEl.alt = filename;
                }
                
                const newFilenameSpan = document.createElement('span');
                newFilenameSpan.className = 'logo-filename-small';
                newFilenameSpan.textContent = isCustom ? 'Custom logo' : filename;
                
                previewContainer.appendChild(imgEl);
                previewContainer.appendChild(newFilenameSpan);
            }

            logoFileInput?.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    uploadLogoBtn.disabled = false;
                    uploadLogoBtn.textContent = `Upload ${file.name}`;
                } else {
                    uploadLogoBtn.disabled = true;
                    uploadLogoBtn.textContent = 'Upload';
                }
            });

            uploadLogoBtn?.addEventListener('click', async function() {
                const file = logoFileInput.files[0];
                if (!file) return;

                showSpinner('Uploading logo...');
                uploadLogoBtn.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('logo', file);

                    const response = await fetch('/upload-logo', {
                        method: 'POST',
                        body: (() => {
                            // formData.append('csrf_token', '{{ csrf_token }}');
                            return formData;
                        })()
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.status === 'success') {
                        hideSpinner();
                        logoFilenameSelect.value = 'custom';
                        customLogoFilenameHidden.value = result.filename;
                        updateLogoPreview(result.filename, true);
                        uploadLogoBtn.disabled = true;
                        uploadLogoBtn.textContent = 'Upload';
                        logoFileInput.value = '';
                        if (deleteLogoBtn) {
                            deleteLogoBtn.style.display = 'inline-block';
                        }
                        alert('Logo uploaded successfully!');
                    } else {
                        hideSpinner();
                        alert(`Upload failed: ${result.message}`);
                        uploadLogoBtn.disabled = false;
                    }
                } catch (error) {
                    hideSpinner();
                    alert(`Upload error: ${error.message || error.toString()}`);
                    uploadLogoBtn.disabled = false;
                }
            });

            deleteLogoBtn?.addEventListener('click', async function() {
                if (!confirm('Are you sure you want to delete the current custom logo?')) return;

                showSpinner('Deleting logo...');
                deleteLogoBtn.disabled = true;

                try {
                    const response = await fetch('/delete-logo', {
                        method: 'POST'
                        // headers: { 'X-CSRF-Token': '{{ csrf_token }}' }
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        hideSpinner();
                        logoFilenameSelect.value = 'none';
                        customLogoFilenameHidden.value = '';
                        updateLogoPreview('');
                        uploadLogoDiv.style.display = 'none';
                        deleteLogoBtn.style.display = 'none';
                        alert('Custom logo deleted successfully!');
                    } else {
                        hideSpinner();
                        alert(`Delete failed: ${result.message}`);
                        deleteLogoBtn.disabled = false;
                    }
                } catch (error) {
                    hideSpinner();
                    alert(`Delete error: ${error.message || error.toString()}`);
                    deleteLogoBtn.disabled = false;
                }
            });

            document.addEventListener('DOMContentLoaded', function() {
                const currentLogoSelection = logoFilenameSelect.value;
                const currentCustomFilename = customLogoFilenameHidden.value;
                
                if (currentLogoSelection === 'custom') {
                    uploadLogoDiv.style.display = 'block';
                    if (currentCustomFilename) {
                        updateLogoPreview(currentCustomFilename, true);
                        if (deleteLogoBtn) {
                            deleteLogoBtn.style.display = 'inline-block';
                        }
                    }
                } else {
                    uploadLogoDiv.style.display = 'none';
                    if (deleteLogoBtn) {
                        deleteLogoBtn.style.display = 'none';
                    }
                }
                
                if (currentLogoSelection === 'custom' && currentCustomFilename) {
                    updateLogoPreview(currentCustomFilename, true);
                } else if (currentLogoSelection && currentLogoSelection !== 'none') {
                    updateLogoPreview(currentLogoSelection, false);
                } else {
                    updateLogoPreview('');
                }
            });
        </script>
    </div>
</div>
{% endblock %}
