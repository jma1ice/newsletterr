{% extends "base.html" %}
{% block title %}settings{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>settings</h1>
    </div>
    {% if settings.from_email == '' %}
        <p class="alert-error">
            Welcome to newsletterr! Please enter in your settings below, if you have any questions about them please see the readme.md file for an explanation.
        </p>
    {% else %}
        <p class="text-info mb-4">Configure your application settings, Plex connection, and email preferences.</p>
    {% endif %}
    {% if alert %}
        <p class="alert-success">{{ alert }}</p>
    {% endif %}
    {% if error %}
        <p class="alert-error">{{ error }}</p>
    {% endif %}
    <div class="foreground">
        <div class="settings-container">
            <div>
                <h3>Plex Account</h3>
                <button id="connect_plex" class="button">Connect Plex</button>
                <div id="plex_status">{% if settings.plex_token %}<p class="plex-connected">Connected</p>{% endif %}</div>
            </div><br>

            <form method="POST" id="settings_form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <label for="from_email">From:</label><br>
                <input type="email" id="from_email" name="from_email"
                    {% if settings.from_email != "" %}value="{{ settings.from_email }}"{% endif %}
                    placeholder="Your email" required><br><br>

                <label for="alias_email">Send-As Alias (Optional - used for domain specific email addresses):</label><br>
                <input type="email" id="alias_email" name="alias_email"
                    {% if settings.alias_email != "" %}value="{{ settings.alias_email }}"{% endif %}
                    placeholder="Blank if no alias"><br><br>

                <label for="reply_to_email">Reply-To (Optional - used to specify a specific email address for replies):</label><br>
                <input type="email" id="reply_to_email" name="reply_to_email"
                    {% if settings.reply_to_email != "" %}value="{{ settings.reply_to_email }}"{% endif %}
                    placeholder="Optional reply-to email"><br><br>

                <label for="password">Password:</label><br>
                <input type="password" id="password" name="password"
                    value=""
                    placeholder="••••••••" autocomplete="new-password" required><br><br>

                <label for="smtp_username">SMTP Username (Optional - used for SMTP clients that need username login):</label><br>
                <input type="text" id="smtp_username" name="smtp_username"
                    {% if settings.smtp_username != "" %}value="{{ settings.smtp_username }}"{% endif %}
                    placeholder="Leave blank to use your email address"><br><br>

                <label for="smtp_server">SMTP Server:</label><br>
                <input type="text" id="smtp_server" name="smtp_server"
                    {% if settings.smtp_server != "" %}value="{{ settings.smtp_server }}"{% endif %}
                    placeholder="SMTP Server (e.g. smtp.gmail.com)" required><br><br>

                <label for="smtp_port">SMTP Port:</label><br>
                <input type="number" id="smtp_port" name="smtp_port"
                    {% if settings.smtp_port != "" %}value="{{ settings.smtp_port }}"{% endif %}
                    placeholder="SMTP Port (i.e. 465 or 587)" required><br><br>

                <label for="smtp_protocol">SMTP Protocol (SSL typically used with port 465, TLS typically used with port 587):</label><br>
                <select id="smtp_protocol" name="smtp_protocol">
                    <option value="SSL" {% if settings.smtp_protocol == "SSL" %}selected{% endif %}>SSL</option>
                    <option value="TLS" {% if settings.smtp_protocol == "TLS" %}selected{% endif %}>TLS</option>
                </select><br><br>

                <label for="server_name">Plex Server Name:</label><br>
                <input type="text" id="server_name" name="server_name"
                    {% if settings.server_name != "" %}value="{{ settings.server_name }}"{% endif %}
                    placeholder="Paramount Plex" required><br><br>

                <label for="plex_url">Plex URL (Optional - used for posters on 'recently added' and 'stats'):</label><br>
                <input type="text" id="plex_url" name="plex_url"
                    {% if settings.plex_url != "" %}value="{{ settings.plex_url }}"{% endif %}
                    placeholder="http://localhost:32400"><br><br>

                <label for="tautulli_url">Tautulli Base URL (Optional - used for user emails, stats, graphs, and recently added):</label><br>
                <input type="text" id="tautulli_url" name="tautulli_url"
                    {% if settings.tautulli_url != "" %}value="{{ settings.tautulli_url }}"{% endif %}
                    placeholder="http://localhost:8181"><br><br>

                <label for="tautulli_api">Tautulli API Key (Optional - see above):</label><br>
                <input type="password" id="tautulli_api" name="tautulli_api"
                    value=""
                    placeholder="••••••••" autocomplete="new-password"><br><br>

                <label for="conjurr_url">Conjurr Base URL (Optional - used for recommendations):</label><br>
                <input type="text" id="conjurr_url" name="conjurr_url"
                    {% if settings.conjurr_url != "" %}value="{{ settings.conjurr_url }}"{% endif %}
                    placeholder="http://localhost:2665"><br><br>

                <label for="logo_filename_input">Logo Filename:</label><br>
                <input type="text" id="logo_filename_input" name="logo_filename_input" 
                    {% if settings.logo_filename != "" %}value="{{ settings.logo_filename }}"{% endif %}
                    placeholder="Enter logo filename (e.g., Asset_45x.png) or leave blank for no logo" 
                    class="logo-input-field" />
                <div class="logo-input-help">
                    <small>Available logos: Asset_45x.png, Asset_46x.png, Asset_4722x.png, Asset_47x.png, Asset_94x.png, dreflix.png</small>
                </div><br>
                
                <div class="logo-preview-small">
                    {% if settings.logo_filename and settings.logo_filename != 'Asset_45x.png' %}
                        {% if settings.logo_filename.startswith('logo_') %}
                            <img src="/static/uploads/logos/{{ settings.logo_filename }}" alt="Current Logo" class="logo-preview-img-small" />
                        {% else %}
                            <img src="/static/img/{{ settings.logo_filename }}" alt="Current Logo" class="logo-preview-img-small" />
                        {% endif %}
                        <span class="logo-filename-small">{{ settings.logo_filename }}</span>
                    {% else %}
                        <img src="/static/img/Asset_45x.png" alt="Default Logo" class="logo-preview-img-small" />
                        <span class="logo-filename-small">Default Logo</span>
                    {% endif %}
                </div><br>
                
                <label for="logo_file">Upload Custom Logo:</label><br>
                <input type="file" id="logo_file" name="logo_file" accept="image/png,image/jpg,image/jpeg,image/webp" />
                <button type="button" id="upload_logo" class="button" disabled>Upload</button>
                {% if settings.logo_filename and settings.logo_filename != 'Asset_45x.png' %}
                    <button type="button" id="delete_logo" class="button">Delete</button>
                {% endif %}
                <button type="button" id="reset_logo" class="button">Reset</button><br><br>
                    
                    <!-- Hidden fields for form submission -->
                    <input type="hidden" id="logo_filename" name="logo_filename" 
                        {% if settings.logo_filename != "" %}value="{{ settings.logo_filename }}"{% endif %} />
                    <input type="hidden" id="logo_width" name="logo_width" 
                        {% if settings.logo_width != "" %}value="{{ settings.logo_width }}"{% endif %} />
                
                <button id="apply_settings" class="button">Apply Settings</button>
            </form>
        </div>
        <script nonce="{{ nonce }}">
            document.getElementById('settings_form').addEventListener('submit', (e) => {
                showSpinner('Applying settings...');
            });
        </script>
        <script nonce="{{ nonce }}">
            function openCenteredPopup(url, w = 520, h = 680, name = 'plex-auth', offsetX = 0, offsetY = 0) {
                const dualLeft = window.screenLeft ?? window.screenX;
                const dualTop  = window.screenTop  ?? window.screenY;

                const vw = window.innerWidth  || document.documentElement.clientWidth  || screen.width;
                const vh = window.innerHeight || document.documentElement.clientHeight || screen.height;

                let left = dualLeft + (vw - w) / 2 + offsetX;
                let top  = dualTop  + (vh - h) / 2 + offsetY;

                left = Math.max(dualLeft, Math.min(left, dualLeft + vw - w));
                top  = Math.max(dualTop,  Math.min(top,  dualTop  + vh - h));

                const features = `width=${w},height=${h},left=${Math.round(left)},top=${Math.round(top)},` +
                                `resizable=yes,scrollbars=yes,toolbar=no,menubar=no,location=yes,noopener,noreferrer`;

                const win = window.open(url, name, features);
                if (!win) return window.open(url, '_blank', 'noopener,noreferrer');
                win.focus();
                return win;
            }
            
            const button = document.getElementById('connect_plex');
            const statusEl = document.getElementById('plex_status');
            let pollTimer = null;
            let connected_to_plex = false;

            button?.addEventListener('click', async () => {
                button.disabled = true;
                statusEl.textContent = '';
                showSpinner('Waiting for Plex approval...');

                try {
                    const r = await fetch('/api/plex/pin', {method: 'POST'});
                    if (!r.ok) throw new Error('Failed to create PIN');
                    const data = await r.json();

                    hideSpinner();
                    showSpinner(`Enter this code into Plex: ${data.code}`);
                    const authWin = openCenteredPopup(data.auth_url, 520, 480, 'plex-auth', 520);

                    const start = Date.now();
                    const timeoutMs = (data.expires_in ?? 600) * 1000;

                    async function waitForPIN() {
                        return new Promise((resolve, reject) => {
                            const poll = async () => {
                                const pollr = await fetch(`/api/plex/pin/${data.pin_id}`);
                                const polld = await pollr.json();
                                if (polld.connected) {
                                    hideSpinner();
                                    statusEl.textContent = 'Connected! Your Plex token is saved.';
                                    clearInterval(pollTimer);
                                    button.disabled = false;
                                    resolve(polld);
                                    return;
                                }
                                if (Date.now() - start > timeoutMs) {
                                    hideSpinner();
                                    statusEl.textContent = 'PIN expired. Please try again.';
                                    clearInterval(pollTimer);
                                    button.disabled = false;
                                    reject(new Error('PIN expired.'));
                                }
                            };
                            pollTimer = setInterval(poll, 1500);
                            poll();
                        });
                    }

                    async function getPlexInfo(authWin) {
                        const polld = await waitForPIN();

                        showSpinner('Retreiving Plex information...');
                        const infor = await fetch('/api/plex/info', {method: 'GET'});
                        if (!infor.ok) throw new Error('Failed to get info');
                        const infod = await infor.json();

                        if (infod.connected) {
                            try { if (authWin && !authWin.closed) authWin.close(); } catch {}
                            hideSpinner();
                            statusEl.textContent = 'Plex information retrieved.';
                            setTimeout(() => location.replace(location.href), 2000);
                            return;
                        }
                    }

                    getPlexInfo(authWin);
                } catch (e) {
                    hideSpinner();
                    statusEl.textContent = 'Error starting Plex connection.';
                    button.disabled = false;
                }
            });

            document.addEventListener('keydown', function(event) {
                if (event.ctrlKey && event.key === 's') {
                    event.preventDefault();
                    
                    const settingsForm = document.getElementById('settings_form');
                    const applyButton = document.getElementById('apply_settings');
                    
                    if (settingsForm && applyButton) {
                        showSpinner('Applying settings...');
                        settingsForm.submit();
                    }
                }
            });

            // Logo Management Functionality
            const logoFileInput = document.getElementById('logo_file');
            const logoFilenameInput = document.getElementById('logo_filename_input');
            const logoFilenameHidden = document.getElementById('logo_filename');
            const uploadLogoBtn = document.getElementById('upload_logo');
            const deleteLogoBtn = document.getElementById('delete_logo');
            const resetLogoBtn = document.getElementById('reset_logo');

            // Sync text input with hidden field and update preview
            logoFilenameInput?.addEventListener('input', function() {
                const filename = this.value.trim();
                logoFilenameHidden.value = filename;
                updateLogoPreview(filename);
            });

            // Update logo preview based on filename
            function updateLogoPreview(filename) {
                const previewImg = document.querySelector('.logo-preview-img-small');
                const filenameSpan = document.querySelector('.logo-filename-small');

                if (!filename) {
                    // No logo selected
                    if (previewImg) previewImg.remove();
                    if (filenameSpan) filenameSpan.textContent = 'No logo';
                    return;
                }

                // Ensure preview image exists
                let imgEl = previewImg;
                if (!imgEl) {
                    const container = document.querySelector('.logo-preview-small');
                    imgEl = document.createElement('img');
                    imgEl.className = 'logo-preview-img-small';
                    container.prepend(imgEl);
                }

                const isUploadedLogo = filename.startsWith('logo_');
                const imgSrc = isUploadedLogo ? `/static/uploads/logos/${filename}` : `/static/img/${filename}`;
                imgEl.src = imgSrc;
                imgEl.alt = filename;
                if (filenameSpan) filenameSpan.textContent = filename;
            }

            // Enable upload button when file is selected
            logoFileInput?.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    uploadLogoBtn.disabled = false;
                    uploadLogoBtn.textContent = `Upload ${file.name}`;
                } else {
                    uploadLogoBtn.disabled = true;
                    uploadLogoBtn.textContent = 'Upload Logo';
                }
            });

            // Handle logo upload
            uploadLogoBtn?.addEventListener('click', async function() {
                const file = logoFileInput.files[0];
                if (!file) return;

                showSpinner('Uploading logo...');
                uploadLogoBtn.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('logo', file);

                    const response = await fetch('/upload-logo', {
                        method: 'POST',
                        body: (() => { formData.append('csrf_token', '{{ csrf_token }}'); return formData; })()
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.status === 'success') {
                        hideSpinner();
                        // Update the text input with the new filename
                        logoFilenameInput.value = result.filename;
                        logoFilenameHidden.value = result.filename;
                        updateLogoPreview(result.filename);
                        uploadLogoBtn.disabled = true;
                        uploadLogoBtn.textContent = 'Upload Logo';
                        logoFileInput.value = ''; // Clear file input
                    } else {
                        hideSpinner();
                        alert(`Upload failed: ${result.message}`);
                        uploadLogoBtn.disabled = false;
                    }
                } catch (error) {
                    hideSpinner();
                    alert(`Upload error: ${error.message || error.toString()}`);
                    uploadLogoBtn.disabled = false;
                }
            });

            // Handle logo deletion
            deleteLogoBtn?.addEventListener('click', async function() {
                if (!confirm('Are you sure you want to delete the current logo?')) return;

                showSpinner('Deleting logo...');
                deleteLogoBtn.disabled = true;

                try {
                    const response = await fetch('/delete-logo', {
                        method: 'POST',
                        headers: { 'X-CSRF-Token': '{{ csrf_token }}' }
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        hideSpinner();
                        // Clear to no logo
                        logoFilenameInput.value = '';
                        logoFilenameHidden.value = '';
                        updateLogoPreview('');
                        deleteLogoBtn.disabled = false;
                    } else {
                        hideSpinner();
                        alert(`Delete failed: ${result.message}`);
                        deleteLogoBtn.disabled = false;
                    }
                } catch (error) {
                    hideSpinner();
                    alert(`Delete error: ${error.message || error.toString()}`);
                    deleteLogoBtn.disabled = false;
                }
            });

            // Handle logo reset (clear to no logo)
            resetLogoBtn?.addEventListener('click', async function() {
                if (!confirm('Clear header logo and use no logo?')) return;

                showSpinner('Resetting logo...');
                resetLogoBtn.disabled = true;

                try {
                    const response = await fetch('/delete-logo', {
                        method: 'POST',
                        headers: { 'X-CSRF-Token': '{{ csrf_token }}' }
                    });

                    const result = await response.json();

                    if (result.status === 'success' || result.status === 'info') {
                        hideSpinner();
                        // Clear to no logo
                        logoFilenameInput.value = '';
                        logoFilenameHidden.value = '';
                        updateLogoPreview('');
                        resetLogoBtn.disabled = false;
                    } else {
                        hideSpinner();
                        alert(`Reset failed: ${result.message}`);
                        resetLogoBtn.disabled = false;
                    }
                } catch (error) {
                    hideSpinner();
                    alert(`Reset error: ${error.message || error.toString()}`);
                    resetLogoBtn.disabled = false;
                }
            });
        </script>
    </div>
</div>
{% endblock %}
