{% extends "base.html" %}
{% block title %}dashboard{% endblock %}
{% block content %}
<div class="container-fluid">
    <h1>Dashboard</h1><br>
    {% if alert %}
        <p id="alert_p" style="color: #01b301; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">{{ alert }}</p>
    {% endif %}
    {% if error %}
        <p id="error_p" style="color: #770010; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">{{ error }}</p>
    {% endif %}
    <div class="foreground">
        <div>
            <table style="height: 60%; width: 100%;">
                <tr style="height: 100%; padding: 10px;">
                    <td style="width: 20%; padding: 10px;">
                        <form method="POST" id="stats_form">
                            <label for="items_to_pull">Recently Added Items (#):</label>
                            <input type="number" id="items_to_pull" name="items_to_pull" value="10" style="width: 8.5rem; margin-bottom: 8px;" /><br>
                            <label for="days_to_pull">Time Range (days):</label>
                            <input type="number" id="days_to_pull" name="days_to_pull" value="30" /><br>
                            <button id="time_range_week" type="button" class="button">7</button>
                            <button id="time_range_month" type="button" class="button">30</button>
                            <button id="time_range_quarter" type="button" class="button">90</button>
                            <button id="time_range_two_q" type="button" class="button">180</button>
                            <button id="time_range_three_q" type="button" class="button">270</button>
                            <button id="time_range_year" type="button" class="button">365</button>
                            <button type="submit" class="button">Get Stats\Users</button>
                        </form>
                        {% if not user_dict %}
                            <button id="pullRecsBtn" class="button opacity-50 cursor-not-allowed" disabled>Get Recommendations</button>
                        {% else %}
                            <button id="pullRecsBtn" class="button">Get Recommendations</button>
                        {% endif %}
                        <p>Note, recommendations take 20-25 seconds per user. After getting stats/users with the top button, recommendations will be pulled for users in the BCC list.</p>
                        <form method="POST" action="/send_email">
                            <label class="form-label">BCC:</label>
                            <div id="bcc_chips" class="nl-chips" role="listbox" aria-label="BCC recipients">
                                <input id="email_chip_input"
                                        type="text"
                                        placeholder="Add BCC emails"
                                        aria-label="Add recipient" />
                            </div>
                            <textarea name="to_emails" id="to_emails" class="d-none">
                                {{ user_dict.values() | join(', ') }}
                            </textarea><br>
                            Subject: <input type="text" name="subject" id="subject" placeholder="Subject"
                                value="{{ settings.server_name }} News" required><br><br>
                            <label for="layout">Choose a layout:</label>
                            <select id="layout" name="layout" onchange="updatePreview()">
                                <option value="none">Plain Text</option>
                                <option value="standard">Standard</option>
                                <option value="recently_added">Recently Added</option>
                            </select><br><br>
                            <textarea name="email_text" id="email_text" placeholder="Write your message..." rows="10"
                                cols="40" oninput="updatePreview()" required></textarea><br><br>
                            <label for="graph_placeholder">Graph Placeholder:</label>
                            <input type="text" id="graph_placeholder" name="graph_placeholder" value="[GRAPHS]"
                                oninput="updatePreview()"><br><br>
                            <label for="stat_placeholder">Stat Placeholder:</label>
                            <input type="text" id="stat_placeholder" name="stat_placeholder" value="[STATS]"
                                oninput="updatePreview()"><br><br>
                        </form>
                        <button id="sendEmailBtn" class="button">Send Email with Selected Graphs</button>
                    </td>
                    <td style="width: 40%; padding: 10px;">
                        Preview: <iframe class="frame" id="preview"></iframe>
                    </td>
                    <td style="width: 40%; padding: 10px;">
                        {% if stats %}
                            <h2>Select a Stat Category</h2>
                            <select id="statSelector" class="form-select w-50 mb-4">
                                <option selected>Choose an option...</option>
                                {% for stat in stats %}
                                    <option value="stat-{{ loop.index0 }}">{{ stat.stat_title }}</option>
                                {% endfor %}
                            </select>
                            {% for stat in stats %}
                                <div class="stat-checkbox-container d-none" id="checkbox-stat-{{ loop.index0 }}">
                                    <label>
                                        <input type="checkbox" class="stat-checkbox" value="stat-{{ loop.index0 }}">
                                        Include {{ stat.stat_title }} in email
                                    </label>
                                </div>
                                <div id="stat-{{ loop.index0 }}" class="stat-table d-none">
                                    <div class="card my-4">
                                        <div class="card-header bg-primary text-white">
                                            {{ stat.stat_title }}
                                        </div>
                                        <div class="card-body blur-container p-0">
                                            {% if stat.rows %}
                                                {% if stat.rows[0].art != '' %}
                                                    <img src="/proxy-art{{ stat.rows[0].art }}" class="bg-blur" alt="" />
                                                {% elif stat.rows[0].grandparent_thumb != '' %}
                                                    <img src="/proxy-art{{ stat.rows[0].grandparent_thumb }}" class="bg-blur" alt="" />
                                                {% endif %}
                                                <table class="table table-striped content-table m-0">
                                                    {% if stat.stat_title == "Most Watched Movies" or stat.stat_title == "Most Watched TV Shows" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Title</th>
                                                                <th>Year</th>
                                                                <th>Plays</th>
                                                                <th>Hours Played</th>
                                                                <th>Rating</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Popular Movies" or stat.stat_title == "Most Popular TV Shows" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Title</th>
                                                                <th>Year</th>
                                                                <th>Plays</th>
                                                                <th>Users</th>
                                                                <th>Rating</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Played Artists" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Author</th>
                                                                <th>Year</th>
                                                                <th>Plays</th>
                                                                <th>Hours Played</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Popular Artists" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Author</th>
                                                                <th>Year</th>
                                                                <th>Plays</th>
                                                                <th>Users</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Recently Watched" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Title</th>
                                                                <th>Year</th>
                                                                <th>Rating</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Active Libraries" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Library</th>
                                                                <th>Plays</th>
                                                                <th>Hours Played</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Active Users" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Username</th>
                                                                <th>Plays</th>
                                                                <th>Hours Played</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Active Platforms" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Platform</th>
                                                                <th>Plays</th>
                                                                <th>Hours Played</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Concurrent Streams" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Category</th>
                                                                <th>Count</th>
                                                            </tr>
                                                        </thead>
                                                    {% endif %}
                                                    <tbody>
                                                        {% for row in stat.rows %}
                                                            <tr>
                                                                {% if stat.stat_title == "Most Active Libraries" %}
                                                                    <td>{{ row.section_name }}</td>
                                                                {% elif stat.stat_title == "Most Active Users" %}
                                                                    <td>{{ row.user }}</td>
                                                                {% elif stat.stat_title == "Most Active Platforms" %}
                                                                    <td>{{ row.platform }}</td>
                                                                {% else %}
                                                                    <td>{{ row.title }}</td>
                                                                {% endif %}

                                                                {% if stat.stat_title == "Most Active Libraries" or stat.stat_title == "Most Active Users" or stat.stat_title == "Most Active Platforms" or stat.stat_title == "Most Concurrent Streams" %}
                                                                {% else %}
                                                                    <td>{{ row.year }}</td>
                                                                {% endif %}

                                                                {% if "Recently" in stat.stat_title %}
                                                                {% elif "Concurrent" in stat.stat_title %}
                                                                {% else %}
                                                                    <td>{{ row.total_plays }}</td>
                                                                {% endif %}

                                                                {% if stat.stat_title == "Most Watched Movies" or stat.stat_title == "Most Watched TV Shows" or stat.stat_title == "Most Played Artists" or stat.stat_title == "Most Active Libraries" or stat.stat_title == "Most Active Users" or stat.stat_title == "Most Active Platforms" %}
                                                                    <td>{{ (row.total_duration / 3600) | round(0, 'ceil')  | int }}</td>
                                                                {% elif stat.stat_title == "Most Popular Movies" or stat.stat_title == "Most Popular TV Shows" or stat.stat_title == "Most Popular Artists" %}
                                                                    <td>{{ row.users_watched }}</td>
                                                                {% endif %}

                                                                {% if stat.stat_title == "Most Active Libraries" or stat.stat_title == "Most Played Artists" or stat.stat_title == "Most Popular Artists" or stat.stat_title == "Most Active Users" or stat.stat_title == "Most Active Platforms" or stat.stat_title == "Most Concurrent Streams" %}
                                                                {% else %}
                                                                    <td>{{ row.content_rating }}</td>
                                                                {% endif %}

                                                                {% if stat.stat_title == "Most Concurrent Streams" %}
                                                                    <td>{{ row.count }}</td>
                                                                {% endif %}
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            {% else %}
                                                <p class="m-3">No data available.</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </td>
                </tr>
            </table>
            <table style="height: 20%; width: 100%;">
                <tr style="height: 100%; padding: 10px;">
                    <td style="width: 15%; padding: 10px;">
                        {% if graph_data != [{},{}] %}
                            <h2>Select a Graph</h2>
                            <select id="graphSelector" class="form-select w-100 mb-4">
                                <option selected>Choose an option...</option>
                                {% for graph in graph_data %}
                                    <option value="graph-{{ loop.index0 }}">{{ graph_commands[loop.index0].name }}</option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    </td>
                    <td style="width: 85%; padding: 10px;">
                        {% for graph in graph_data %}
                            <div class="graph-checkbox-container d-none" id="checkbox-graph-{{ loop.index0 }}">
                                <label>
                                    <input type="checkbox" class="graph-checkbox" value="graph-{{ loop.index0 }}">
                                    Include {{ graph_commands[loop.index0].name }} in email
                                </label>
                            </div>
                            <div class="graph-table d-none" id="graph-{{ loop.index0 }}"></div>
                        {% endfor %}
                    </td>
                </tr>
            </table>
            <section>
                <div class="flex items-end justify-between gap-3 mb-6">
                    <h2>Recently Added</h2>
                    <select id="ra-lib" class="border rounded px-3 py-2 dark:bg-[#333]">
                        <option value="" selected>Select A Library...</option>
                        <option value="__ALL__">All Libraries</option>
                    </select>
                </div>

                <ul id="ra-grid" class="grid grid-cols-10 gap-4" style="padding-right: 2rem;"></ul>

                <div id="ra-empty" class="hidden text-center text-gray-500 dark:text-gray-400 mt-10">
                    No items match your filters.
                </div>
            </section><br>
            <section>
                <div id="recommendations_pane">
                </div>
            </section>
        </div>
        <script>
            const recentPayload = {{ recent_data | tojson }};

            function buildThumb(path) {
                if (!path) return '';
                const p = path.startsWith('/') ? path : '/' + path;
                return `/proxy-art${p}`;
            }

            function pickThumb(it) {
                const type = (it.media_type || it.type || '').toLowerCase();

                const candidates = (type === 'episode' || type === 'season')
                    ? [it.grandparent_thumb, it.parent_thumb, it.thumb, it.art]
                    : [it.thumb, it.art, it.parent_thumb, it.grandparent_thumb];

                return candidates.find(Boolean) || '';
            }

            const flatten = (arr) => arr.flatMap(x => x?.recently_added || []);
            const msToHMS = (ms) => {
                ms = parseInt(ms || 0, 10);
                const s = Math.round(ms / 1000);
                const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
                return h ? `${h}h ${m}m` : `${m}m`;
            };
            const formatDate = (d) => {
                if (!d) return '';
                if (/^\d+$/.test(String(d))) return new Date(parseInt(d,10)*1000).toLocaleDateString();
                const dt = new Date(d); return isNaN(dt) ? '' : dt.toLocaleDateString();
            };

            const items = flatten(recentPayload).map(it => {
                const title = it.title || it.full_title || it.parent_title || it.grandparent_title || '(untitled)';
                const sub = it.year || it.grandparent_title || it.parent_title || '';
                const thumbPath = pickThumb(it);
                return {
                    library: it.library_name || it.section_name || '',
                    title,
                    sub,
                    summary: it.tagline || it.summary || '',
                    duration: msToHMS(it.duration),
                    added: formatDate(it.added_at || it.originally_available_at),
                    thumb: thumbPath
                };
            });

            const libSel = document.getElementById('ra-lib');
            [...new Set(items.map(i => i.library).filter(Boolean))].sort().forEach(lib => {
                const opt = document.createElement('option');
                opt.value = lib; opt.textContent = lib;
                libSel.appendChild(opt);
            });

            const grid = document.getElementById('ra-grid');
            const empty = document.getElementById('ra-empty');

            function render(list) {
                grid.innerHTML = '';
                list.forEach(it => {
                    const imgURL = buildThumb(it.thumb);
                    const li = document.createElement('li');
                    li.className = "group rounded-2xl overflow-hidden bg-[#8acbd4] dark:bg-[#333] " + 
                    "!shadow-[0_6px_18px_rgba(0,0,0,0.6)] hover:!shadow-[0_10px_28px_rgba(0,0,0,0.6)] " + 
                    "dark:!shadow-[0_6px_18px_rgba(74,127,130,0.6)] dark:hover:!shadow-[0_10px_28px_rgba(74,127,130,0.6)]";
                    li.dataset.lib = it.library;
                    li.innerHTML = `
                        <div class="relative aspect-[2/3] bg-gray-200 dark:bg-gray-700">
                        ${imgURL ? `<img loading="lazy" src="${imgURL}" class="h-full w-full object-cover">` : ''}
                        ${it.library ? `<div class="absolute top-1 right-1 text-xs px-2 py-1 rounded-full bg-black/70 text-white">${it.library}</div>` : ''}
                        ${it.added ? `<div class="absolute bottom-1 right-1 text-[11px] text-white/90"><span class="bg-black/60 rounded px-1.5 py-0.5">${it.added}</span></div>` : ''}
                        </div>
                        <div class="p-3">
                        <div class="font-semibold line-clamp-2">${it.title}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            ${it.sub ? it.sub + ' â€¢ ' : ''}${it.duration}
                        </div>
                        ${it.summary ? `<div class="mt-2 text-xs text-gray-600 dark:text-gray-300 line-clamp-5">${it.summary}</div>` : ''}
                        </div>
                    `;
                    grid.appendChild(li);
                });
                empty.classList.toggle('hidden', list.length !== 0);
            }

            function applyFilter() {
                const lb = libSel.value;
                if (lb === '') { render([], { showEmpty:false }); return; }
                if (lb === '__ALL__') { render(items); return; }
                render(items.filter(it => it.library === lb));
            }

            libSel.addEventListener('input', applyFilter);
        </script>
        <script>
            document.getElementById('time_range_week').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 7;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_month').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 30;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_quarter').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 90;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_two_q').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 180;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_three_q').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 270;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_year').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 365;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
        </script>
        <script>
            async function updatePreview() {
                const raw = document.getElementById('email_text').value;
                const layout = document.getElementById('layout').value;
                const serverName = "{{ settings.server_name }}";
                const subject = document.getElementById('subject').value;
                const isDark = document.documentElement.classList.contains('dark');

                let body = raw.replace(/\n/g, "<br>");
                let html = "";
                let displaySubject = subject.startsWith(serverName) 
                    ? subject.slice(serverName.length).trimStart()
                    : subject;

                const selectedGraphs = Array.from(document.querySelectorAll('.graph-checkbox:checked'))
                    .map(cb => cb.value);
                const selectedStats = Array.from(document.querySelectorAll('.stat-checkbox:checked'))
                    .map(cb => cb.value);

                let graphImagesHTML = "";
                for (let id of selectedGraphs) {
                    const chart = Highcharts.charts.find(c => c && c.renderTo.id === id);
                    if (chart) {
                        const svg = chart.getSVG();
                        const canvas = document.createElement("canvas");
                        const ctx = canvas.getContext("2d");
                        const img = new Image();

                        await new Promise((resolve, reject) => {
                            img.onload = () => {
                                canvas.width = img.width;
                                canvas.height = img.height;
                                ctx.drawImage(img, 0, 0);
                                const dataUrl = canvas.toDataURL("image/png");
                                graphImagesHTML += `<img src="${dataUrl}" style="max-width: 100%; margin-bottom: 10px;">`;
                                resolve();
                            };
                            img.onerror = reject;
                            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
                        });
                    }
                }

                let statImagesHTML = "";
                for (let id of selectedStats) {
                    const tableElement = document.getElementById(id);
                    if (tableElement) {
                        const wasHidden = tableElement.classList.contains('d-none');
                        if (wasHidden) {
                            tableElement.classList.remove('d-none');
                        }
                        await new Promise(resolve => setTimeout(resolve, 150));

                        const original = document.getElementById(id);
                        if (!original) continue;

                        const clone = original.cloneNode(true);
                        const tempWrapper = document.createElement('div');

                        clone.style.display = 'inline-block';
                        clone.style.width = 'auto';

                        const table = clone.querySelector('.content-table');
                        if (table) {
                            table.style.width = 'auto';
                        }

                        tempWrapper.style.position = 'fixed';
                        tempWrapper.style.top = '-10000px';
                        tempWrapper.style.left = '0';
                        tempWrapper.style.zIndex = '-1';
                        tempWrapper.style.overflow = 'hidden';
                        tempWrapper.appendChild(clone);
                        document.body.appendChild(tempWrapper);

                        const blurImage = clone.querySelector('.bg-blur');
                        if (blurImage) {
                            await blurImageElement(blurImage);
                        }

                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                        const canvas = await html2canvas(clone, {
                            backgroundColor: null,
                            scale: 1,
                            useCORS: true
                        });

                        const dataUrl = canvas.toDataURL("image/png");
                        statImagesHTML += `<img src="${dataUrl}" style="max-width: 100%; margin-bottom: 10px;">`;

                        document.body.removeChild(tempWrapper);

                        if (wasHidden) {
                            tableElement.classList.add('d-none');
                        }
                    }
                }

                const graphPlaceholder = document.getElementById('graph_placeholder').value;
                const statPlaceholder = document.getElementById('stat_placeholder').value;
                let gContent = body;

                if (raw.includes(graphPlaceholder)) {
                    gContent = body.replace(graphPlaceholder, graphImagesHTML);
                } else {
                    gContent = `${body}`;
                }

                if (raw.includes(statPlaceholder)) {
                    content = gContent.replace(statPlaceholder, statImagesHTML);
                } else {
                    content = `${gContent}`;
                }

                switch (layout) {
                    case "standard":
                        html = `
                                <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400,500,600,700&display=swap" rel="stylesheet">
                                <style>
                                    :root { color-scheme: ${isDark ? 'dark' : 'light'}; }
                                    html, body { background: ${isDark ? '#333' : '#8acbd4'}; }
                                </style>
                                <html><body style="font-family: IBM Plex Sans; margin: 0;">
                                    <table class="body" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;" border="0" cellspacing="0" cellpadding="0">
                                        <tbody>
                                            <tr>
                                                <td class="preview-container" style="font-family: IBM Plex Sans; font-size: 14px; vertical-align: top; display: block;">
                                                    <div class="content" style="box-sizing: border-box; display: block;"><span class="preheader" style="color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;">${serverName} Newsletter</span>
                                                        <table class="main" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background: #282A2D; border-radius: 3px; color: #ffffff;" border="0" cellspacing="0" cellpadding="3">
                                                            <tbody>
                                                                <tr>
                                                                    <td class="wrapper" style="font-family: IBM Plex Sans; font-size: 14px; vertical-align: top; box-sizing: border-box; padding: 5px; overflow: auto;">
                                                                        <div class="header" style="width: 50%; height: 10px; text-align: center;"><img class="header-img" style="border: none; -ms-interpolation-mode: bicubic; max-width: 9%; width: 492px; height: 20px; margin-left: -35px;" src="https://d15k2d11r6t6rl.cloudfront.net/public/users/Integrators/669d5713-9b6a-46bb-bd7e-c542cff6dd6a/3bef3c50f13f4320a9e31b8be79c6ad2/Plex%20Logo%20Update%202022/plex-logo-heavy-stroke.png" width="492" height="90" /></div>
                                                                        <div class="server-name" style="font-size: 25px; text-align: center; margin-bottom: 0;">${serverName} Newsletter</div>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="footer" style="font-family: IBM Plex Sans; font-size: 12px; vertical-align: top; clear: both; margin-top: 0; text-align: center; width: 100%;">
                                                                        <h1 class="footer-bar" style="margin-left: auto; margin-right: auto; width: 250px; border-top: 1px solid #E5A00D; margin-top: 5px;">${displaySubject}</h1>
                                                                        <p>
                                                                            ${content}
                                                                        </p>
                                                                        <div class="footer-bar" style="margin-left: auto; margin-right: auto; width: 250px; border-top: 1px solid #E5A00D; margin-top: 25px;">&nbsp;</div>
                                                                        <div class="content-block powered-by" style="padding-bottom: 10px; padding-top: 0;">Generated for Plex Media Server by newsletterr</div>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table></body></html>`;
                        break;
                    case "recently_added":
                        html = {{ html_recent_grid | tojson }};
                        break;
                    default:
                        html = `<style>
                                    :root { color-scheme: ${isDark ? 'dark' : 'light'}; }
                                    html, body { background: ${isDark ? '#333' : '#8acbd4'}; }
                                </style>
                                <html><body>${content}</body></html>`;
                }

                const frame = document.getElementById('preview');
                const doc = frame.contentDocument || frame.contentWindow.document;
                doc.documentElement.classList.toggle('dark', isDark);
                frame.srcdoc = html;
            }

            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('email_text').addEventListener('input', updatePreview);
                document.getElementById('layout').addEventListener('change', updatePreview);
                document.querySelectorAll('.graph-checkbox').forEach(cb => {
                    cb.addEventListener('change', updatePreview);
                });
                document.querySelectorAll('.stat-checkbox').forEach(cb => {
                    cb.addEventListener('change', updatePreview);
                });
            });
        </script>
        <script>
            document.getElementById('statSelector').addEventListener('change', function () {
                const selectedId = this.value;
                document.querySelectorAll('.stat-table').forEach(el => {el.classList.add('d-none');});
                document.querySelectorAll('.stat-checkbox-container').forEach(el => el.classList.add('d-none'));

                document.getElementById(selectedId).classList.remove('d-none');
                document.getElementById(`checkbox-${selectedId}`).classList.remove('d-none');
            });
        </script>
        <script>
            document.getElementById('graphSelector').addEventListener('change', function () {
                const selectedId = this.value;
                document.querySelectorAll('.graph-table').forEach(el => el.classList.add('d-none'));
                document.querySelectorAll('.graph-checkbox-container').forEach(el => el.classList.add('d-none'));

                document.getElementById(selectedId).classList.remove('d-none');
                document.getElementById(`checkbox-${selectedId}`).classList.remove('d-none');
            });
        </script>
        <script>
            function themeVars(isDark) {
                return {
                    text: isDark ? '#8acbd4' : '#333',
                    grid: isDark ? '#e5e7eb' : '#374151',
                    axis: isDark ? '#e5e7eb' : '#374151',
                    bg: isDark ? '#333' : '#8acbd4',
                };
            }

            function applyChartTheme(isDark) {
                const t = themeVars(isDark);

                Highcharts.setOptions({
                    chart: { backgroundColor: t.bg, style: { fontFamily: 'IBM Plex Sans' } },
                    title: { style: { color: t.text } },
                    legend: { itemStyle: { color: t.text } },
                    xAxis: { labels: { style: { color: t.text } }, gridLineColor: t.grid, lineColor: t.axis, tickColor: t.axis },
                    yAxis: { labels: { style: { color: t.text } }, title: { style: { color: t.text } }, gridLineColor: t.grid, lineColor: t.axis, tickColor: t.axis }
                });

                Highcharts.charts.filter(Boolean).forEach(c => {
                    c.update({
                        chart: { backgroundColor: t.bg },
                        title: { style: { color: t.text } },
                        legend: { itemStyle: { color: t.text } }
                    });

                    c.xAxis.forEach(ax => ax.update({
                        labels: { style: { color: t.text } },
                        gridLineColor: t.grid,
                        lineColor: t.axis,
                        tickColor: t.axis
                    }));

                    c.yAxis.forEach(ax => ax.update({
                        labels: { style: { color: t.text } },
                        title: { style: { color: t.text } },
                        gridLineColor: t.grid,
                        lineColor: t.axis,
                        tickColor: t.axis
                    }));

                    c.redraw();
                });
            }

            const isDark = document.documentElement.classList.contains('dark');
            applyChartTheme(isDark);

            document.getElementById('theme-toggle')?.addEventListener('click', () => {
                const nowDark = document.documentElement.classList.contains('dark');
                applyChartTheme(!nowDark);
            });

            const graphDataList = {{ graph_data | tojson }};
            const graphCommands = {{ graph_commands | tojson }};

            const renderedCharts = new Set();

            document.getElementById('graphSelector').addEventListener('change', function () {
                const selectedId = this.value;

                document.querySelectorAll('.graph-table').forEach(el => el.classList.add('d-none'));

                const container = document.getElementById(selectedId);
                container.classList.remove('d-none');

                if (!renderedCharts.has(selectedId)) {
                    const index = parseInt(selectedId.split('-')[1]);
                    const graphData = graphDataList[index];

                    Highcharts.chart(selectedId, {
                        chart: { type: 'line' },
                        title: { text: graphCommands[index].name },
                        exporting: {
                            enabled: true
                        },
                        xAxis: { categories: graphData.categories },
                        yAxis: { title: { text: 'Plays' } },
                        series: graphData.series
                    });

                    renderedCharts.add(selectedId);
                }

                const nowDark = document.documentElement.classList.contains('dark');
                applyChartTheme(nowDark);
            });
        </script>
        <script>
            document.getElementById('pullRecsBtn').addEventListener('click', async () => {
                showSpinner('Pulling recommendations...');

                function collectEmailsFromChips() {
                    return Array.from(document.querySelectorAll('#bcc_chips .nl-chip'))
                        .map(ch => ch.dataset.email)
                        .filter(Boolean);
                }

                const chipInput = document.getElementById('email_chip_input');
                    if (chipInput && chipInput.value.trim()) {
                        chipInput.dispatchEvent(new Event('blur'));
                }

                const toList = collectEmailsFromChips();
                    if (!toList.length) {
                        alert('Please add at least one recipient.');
                        return;
                }

                const to_emails = toList.join(', ');

                const payload = {
                    stats: {{ stats | tojson }},
                    user_dict: {{ user_dict | tojson }},
                    graph_data: {{ graph_data | tojson }},
                    graph_commands: {{ graph_commands | tojson }},
                    recent_data: {{ recent_data | tojson }},
                    libs: {{ libs | tojson }},
                    html_recent_grid: {{ html_recent_grid | tojson }},
                    settings: {{ settings | tojson }},
                    to_emails
                };

                try {
                    const resp = await fetch('/pull_recommendations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        credentials: 'same-origin'
                    });
                    
                    const data = await resp.json();
                    if (!resp.ok || !data.ok) throw new Error(data.error || 'Error pulling recommendations.');

                    const alert_p = document.getElementById('alert_p');
                    alert_p.textContent = data.alert;

                    const pane = document.getElementById('recommendations_pane');
                    pane.innerHTML = data.html;
                    initRecommendationsFilter(pane);
                } catch (err) {
                    console.error("Error pulling recommendations:", err);
                    const error_p= document.getElementById('error_p');
                    error_p.textContent = err;
                    alert("Something went wrong while pulling recommendations.");
                } finally {
                    try { hideSpinner(); } catch(_) {}
                }
            });
        </script>
        <script>
            function initRecommendationsFilter(rootEl) {
                const root = rootEl?.querySelector('#recommendations') || document.getElementById('recommendations') || rootEl || document;
                const sel = root?.querySelector('#rec-user-filter');
                const cards = Array.from(root?.querySelectorAll('.rec-user-card') || []);
                if (!sel || !cards.length) return;

                function apply() {
                    const opt = sel.options[sel.selectedIndex];
                    const val = sel.value;

                    if (val === "") {
                        cards.forEach(c => c.classList.add('hidden'));
                        return;
                    }

                    if (val === '__ALL__') {
                        cards.forEach(c => c.classList.remove('hidden'));
                        return;
                    }

                    cards.forEach(c => c.classList.toggle('hidden', c.dataset.user !== val));
                };

                sel.addEventListener('change', apply);
                apply();
            }
        </script>
        <script>
            function collectEmailsFromChips() {
                return Array.from(document.querySelectorAll('#bcc_chips .nl-chip'))
                    .map(ch => ch.dataset.email)
                    .filter(Boolean);
            }

            document.getElementById('sendEmailBtn').addEventListener('click', async () => {
                const subject = document.getElementById('subject').value;
                const email_text = document.getElementById('email_text').value;
                const layout = document.getElementById('layout').value;
                const graphImages = [];
                const statImages = [];

                const chipInput = document.getElementById('email_chip_input');
                    if (chipInput && chipInput.value.trim()) {
                        chipInput.dispatchEvent(new Event('blur'));
                }

                const toList = collectEmailsFromChips();
                    if (!toList.length) {
                        alert('Please add at least one recipient.');
                        return;
                }

                const to_emails = toList.join(', ');

                const ok = window.confirm(
                    `Send email?\n\nSubject: ${subject || '(no subject)'}`
                );
                if (!ok) return;

                showSpinner('Sending email...');

                const selectedGraphs = Array.from(document.querySelectorAll('.graph-checkbox:checked'))
                    .map(cb => cb.value);
                const selectedStats = Array.from(document.querySelectorAll('.stat-checkbox:checked'))
                    .map(cb => cb.value);

                for (let id of selectedGraphs) {
                    const chart = Highcharts.charts.find(c => c && c.renderTo.id === id);
                    if (chart) {
                        const svg = chart.getSVG();
                        const canvas = document.createElement("canvas");
                        const ctx = canvas.getContext("2d");
                        const img = new Image();

                        await new Promise((resolve, reject) => {
                            img.onload = () => {
                                canvas.width = img.width;
                                canvas.height = img.height;
                                ctx.drawImage(img, 0, 0);
                                const dataUrl = canvas.toDataURL("image/png");
                                graphImages.push({ id, img: dataUrl });
                                resolve();
                            };
                            img.onerror = reject;
                            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
                        });
                    }
                }

                for (let id of selectedStats) {
                    const tableElement = document.getElementById(id);
                    if (tableElement) {
                        const wasHidden = tableElement.classList.contains('d-none');
                        if (wasHidden) {
                            tableElement.classList.remove('d-none');
                        }
                        await new Promise(resolve => setTimeout(resolve, 150));

                        const original = document.getElementById(id);
                        if (!original) continue;

                        const clone = original.cloneNode(true);
                        const tempWrapper = document.createElement('div');

                        clone.style.display = 'inline-block';
                        clone.style.width = 'auto';

                        const table = clone.querySelector('.content-table');
                        if (table) {
                            table.style.width = 'auto';
                        }

                        tempWrapper.style.position = 'fixed';
                        tempWrapper.style.top = '-10000px';
                        tempWrapper.style.left = '0';
                        tempWrapper.style.zIndex = '-1';
                        tempWrapper.style.overflow = 'hidden';
                        tempWrapper.appendChild(clone);
                        document.body.appendChild(tempWrapper);

                        const blurImage = clone.querySelector('.bg-blur');
                        if (blurImage) {
                            await blurImageElement(blurImage);
                        }

                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                        const canvas = await html2canvas(clone, {
                            backgroundColor: null,
                            scale: 1,
                            useCORS: true
                        });

                        const dataUrl = canvas.toDataURL("image/png");
                        statImages.push({ id, img: dataUrl });

                        document.body.removeChild(tempWrapper);

                        if (wasHidden) {
                            tableElement.classList.add('d-none');
                        }
                    }
                }

                try {
                    const resp = await fetch('/send_email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            to_emails,
                            subject,
                            email_text,
                            layout,
                            graphs: graphImages,
                            stats: statImages
                        })
                    });
                    
                    if (resp.ok) {
                        alert("Email sent!");
                    } else {
                        const data = await resp.json();
                        alert("Error sending email: " + data.error);
                    }
                } catch (err) {
                    console.error("Error sending email:", err);
                    alert("Something went wrong while sending the email.");
                }

                hideSpinner();
            });
        </script>
        <script>
            document.getElementById('stats_form').addEventListener('submit', (e) => {
                showSpinner('Getting stats and users...');
            });
        </script>
        <script>
            async function blurImageElement(imgElement) {
                const tempImg = new Image();
                tempImg.crossOrigin = 'anonymous';
                tempImg.src = imgElement.src;

                await new Promise((resolve, reject) => {
                    tempImg.onload = resolve;
                    tempImg.onerror = reject;
                });

                const rect = imgElement.getBoundingClientRect();
                const canvas = document.createElement('canvas');
                canvas.width = rect.width || 800;
                canvas.height = rect.height || 450;

                const ctx = canvas.getContext('2d');
                ctx.filter = 'blur(4px) brightness(0.75)';
                ctx.drawImage(tempImg, 0, 0, canvas.width, canvas.height);

                const blurredDataURL = canvas.toDataURL('image/png');
                imgElement.src = blurredDataURL;
                imgElement.style.position = 'absolute';
                imgElement.style.width = '100%';
                imgElement.style.height = '100%';
                imgElement.style.objectFit = 'cover';
                imgElement.style.zIndex = '0';
                imgElement.style.filter = 'none';
            }
        </script>
        <script>
            (function () {
                const box = document.getElementById('bcc_chips');
                const input = document.getElementById('email_chip_input');
                const ta = document.getElementById('to_emails');

                if (!box || !input || !ta) return;

                function normalize(token) {
                    const m = String(token).match(/<([^>]+)>/);
                    return (m ? m[1] : token).trim().toLowerCase();
                }
                function isEmail(s) {
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
                }

                function syncHiddenFromDOM() {
                    const list = Array.from(box.querySelectorAll('.nl-chip'))
                    .map(ch => ch.dataset.email)
                    .filter(Boolean);
                    ta.value = list.join(', ');
                    input.placeholder = list.length ? '' : 'Add BCC emails';
                }

                function makeChip(email) {
                    const chip = document.createElement('span');
                    chip.className = 'nl-chip';
                    chip.dataset.email = email;
                    chip.innerHTML = `
                        <span>${email}</span>
                        <button type="button" class="remove" aria-label="Remove ${email}">x</button>
                    `;
                    return chip;
                }

                function addEmail(email) {
                    if (!email || !isEmail(email)) return;
                    const sel = `.nl-chip[data-email="${CSS.escape(email)}"]`;
                    if (box.querySelector(sel)) return;
                    box.insertBefore(makeChip(email), input);
                    syncHiddenFromDOM();
                }

                function addTokens(str) {
                    String(str).split(/[,\n;\s]+/).filter(Boolean).forEach(t => {
                        addEmail(normalize(t));
                    });
                }

                addTokens(ta.value || '');

                input.addEventListener('keydown', (e) => {
                    if (['Enter', 'Tab'].includes(e.key) || e.key === ',' || e.key === ';') {
                        e.preventDefault();
                        if (input.value.trim()) { addTokens(input.value); input.value = ''; }
                    } else if (e.key === 'Backspace' && !input.value) {
                        const last = box.querySelector('.nl-chip:last-of-type');
                        if (last) { last.remove(); syncHiddenFromDOM(); }
                    }
                });

                input.addEventListener('paste', (e) => {
                    const text = (e.clipboardData || window.clipboardData).getData('text');
                    if (/[,\n;\s]/.test(text)) { e.preventDefault(); addTokens(text); }
                });

                input.addEventListener('blur', () => {
                    if (input.value.trim()) { addTokens(input.value); input.value = ''; }
                });

                box.addEventListener('click', (e) => {
                    const btn = e.target.closest('.remove');
                    if (!btn) return;
                    const chip = btn.closest('.nl-chip');
                    if (chip) { chip.remove(); syncHiddenFromDOM(); }
                });

                new MutationObserver(syncHiddenFromDOM).observe(box, { childList: true });

                document.getElementById('sendEmailBtn')?.addEventListener('click', () => {
                    if (input.value.trim()) { addTokens(input.value); input.value = ''; }
                    syncHiddenFromDOM();
                });

                syncHiddenFromDOM();
            })();
        </script>
    </div>
</div>
{% endblock %}
