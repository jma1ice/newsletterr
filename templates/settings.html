{% extends "base.html" %}
{% block title %}settings{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>settings</h1>
    </div>
    {% if settings.from_email == '' %}
        <p style="color: #770010; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">
            Welcome to newsletterr! Please enter in your settings below, if you have any questions about them please see the readme.md file for an explanation.
        </p>
    {% else %}
        <p class="text-info mb-4">Configure your application settings, Plex connection, and email preferences.</p>
    {% endif %}
    {% if alert %}
        <p style="color: #01b301; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">{{ alert }}</p>
    {% endif %}
    {% if error %}
        <p style="color: #770010; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">{{ error }}</p>
    {% endif %}
    <div class="foreground">
        <div style="margin: 0px 0px 0px 15px;">
            <div>
                <h3>Plex Account</h3>
                <button id="connect_plex" class="button">Connect Plex</button>
                <div id="plex_status">{% if settings.plex_token %}<p style="padding-left: 8px; color: #01b301; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">Connected</p>{% endif %}</div>
            </div><br>

            <form method="POST" id="settings_form">
                <label for="from_email">From:</label><br>
                <input type="email" id="from_email" name="from_email"
                    {% if settings.from_email != "" %}value="{{ settings.from_email }}"{% endif %}
                    placeholder="Your email" required><br><br>

                <label for="alias_email">Send-As Alias (Optional - used for domain specific email addresses):</label><br>
                <input type="email" id="alias_email" name="alias_email"
                    {% if settings.alias_email != "" %}value="{{ settings.alias_email }}"{% endif %}
                    placeholder="Blank if no alias"><br><br>

                <label for="reply_to_email">Reply-To (Optional - used to specify a specific email address for replies):</label><br>
                <input type="email" id="reply_to_email" name="reply_to_email"
                    {% if settings.reply_to_email != "" %}value="{{ settings.reply_to_email }}"{% endif %}
                    placeholder="Optional reply-to email"><br><br>

                <label for="password">Password:</label><br>
                <input type="password" id="password" name="password"
                    {% if settings.password != "" %}value="{{ settings.password }}"{% endif %}
                    placeholder="Email Password or App Password" required><br><br>

                <label for="smtp_username">SMTP Username (Optional - used for SMTP clients that need username login):</label><br>
                <input type="text" id="smtp_username" name="smtp_username"
                    {% if settings.smtp_username != "" %}value="{{ settings.smtp_username }}"{% endif %}
                    placeholder="Leave blank to use your email address"><br><br>

                <label for="smtp_server">SMTP Server:</label><br>
                <input type="text" id="smtp_server" name="smtp_server"
                    {% if settings.smtp_server != "" %}value="{{ settings.smtp_server }}"{% endif %}
                    placeholder="SMTP Server (e.g. smtp.gmail.com)" required><br><br>

                <label for="smtp_port">SMTP Port:</label><br>
                <input type="number" id="smtp_port" name="smtp_port"
                    {% if settings.smtp_port != "" %}value="{{ settings.smtp_port }}"{% endif %}
                    placeholder="SMTP Port (i.e. 465 or 587)" required><br><br>

                <label for="smtp_protocol">SMTP Protocol (SSL typically used with port 465, TLS typically used with port 587):</label><br>
                <select id="smtp_protocol" name="smtp_protocol">
                    <option value="SSL" {% if settings.smtp_protocol == "SSL" %}selected{% endif %}>SSL</option>
                    <option value="TLS" {% if settings.smtp_protocol == "TLS" %}selected{% endif %}>TLS</option>
                </select><br><br>

                <label for="server_name">Plex Server Name:</label><br>
                <input type="text" id="server_name" name="server_name"
                    {% if settings.server_name != "" %}value="{{ settings.server_name }}"{% endif %}
                    placeholder="Paramount Plex" required><br><br>

                <label for="plex_url">Plex URL (Optional - used for posters on 'recently added' and 'stats'):</label><br>
                <input type="text" id="plex_url" name="plex_url"
                    {% if settings.plex_url != "" %}value="{{ settings.plex_url }}"{% endif %}
                    placeholder="http://localhost:32400"><br><br>

                <label for="tautulli_url">Tautulli Base URL (Optional - used for user emails, stats, graphs, and recently added):</label><br>
                <input type="text" id="tautulli_url" name="tautulli_url"
                    {% if settings.tautulli_url != "" %}value="{{ settings.tautulli_url }}"{% endif %}
                    placeholder="http://localhost:8181"><br><br>

                <label for="tautulli_api">Tautulli API Key (Optional - see above):</label><br>
                <input type="text" id="tautulli_api" name="tautulli_api"
                    {% if settings.tautulli_api != "" %}value="{{ settings.tautulli_api }}"{% endif %}
                    placeholder="Tautulli API Key"><br><br>

                <label for="conjurr_url">Conjurr Base URL (Optional - used for recommendations):</label><br>
                <input type="text" id="conjurr_url" name="conjurr_url"
                    {% if settings.conjurr_url != "" %}value="{{ settings.conjurr_url }}"{% endif %}
                    placeholder="http://localhost:2665"><br><br>

                <label for="logo_filename">Logo Filename (Optional - used for custom logos at the top of emails):</label><br>
                <input type="text" id="logo_filename" name="logo_filename"
                    {% if settings.logo_filename != "" %}value="{{ settings.logo_filename }}"{% endif %}
                    placeholder="Asset_45x.png"><br><br>

                <label for="logo_width">Logo Width (Optional - used to size custom logos):</label><br>
                <input type="number" id="logo_width" name="logo_width"
                    {% if settings.logo_width != "" %}value="{{ settings.logo_width }}"{% endif %}
                    placeholder="80"><br><br>

                <label for="email_theme">Email Theme:</label><br>
                <select id="email_theme" name="email_theme">
                    <option value="newsletterr_blue" {% if settings.email_theme == 'newsletterr_blue' %}selected{% endif %}>Newsletterr Blue</option>
                    <option value="plex_orange" {% if settings.email_theme == 'plex_orange' %}selected{% endif %}>Plex Orange</option>
                    <option value="custom" {% if settings.email_theme == 'custom' %}selected{% endif %}>Custom</option>
                </select><br><br>

                <div id="color_inputs" style="display: {% if settings.email_theme == 'custom' %}block{% else %}none{% endif %};">
                    <label for="primary_color">Primary Color (Main brand color for headers and accents):</label>
                    <div class="input-group">
                        <input type="color" id="primary_color" name="primary_color" value="{{ settings.primary_color }}">
                        <input type="text" value="{{ settings.primary_color }}" readonly>
                    </div><br>

                    <label for="secondary_color">Secondary Color (Secondary color for footers and borders):</label>
                    <div class="input-group">
                        <input type="color" id="secondary_color" name="secondary_color" value="{{ settings.secondary_color }}">
                        <input type="text" value="{{ settings.secondary_color }}" readonly>
                    </div><br>

                    <label for="accent_color">Accent Color (Accent color for links and highlights):</label>
                    <div class="input-group">
                        <input type="color" id="accent_color" name="accent_color" value="{{ settings.accent_color }}">
                        <input type="text" value="{{ settings.accent_color }}" readonly>
                    </div><br>

                    <label for="background_color">Background Color:</label>
                    <div class="input-group">
                        <input type="color" id="background_color" name="background_color" value="{{ settings.background_color }}">
                        <input type="text" value="{{ settings.background_color }}" readonly>
                    </div><br>

                    <label for="text_color">Text Color:</label>
                    <div class="input-group">
                        <input type="color" id="text_color" name="text_color" value="{{ settings.text_color }}">
                        <input type="text" value="{{ settings.text_color }}" readonly>
                    </div><br>
                </div>
                
                <button id="apply_settings" class="button">Apply Settings</button>
            </form>
        </div>
        <script>
            document.getElementById('settings_form').addEventListener('submit', (e) => {
                showSpinner('Applying settings...');
            });
        </script>
        <script>
            document.querySelectorAll('input[type="color"]').forEach(colorInput => {
                const textInput = colorInput.parentElement.querySelector('input[type="text"]');
                
                colorInput.addEventListener('change', function() {
                    textInput.value = this.value;
                });
                
                textInput.addEventListener('change', function() {
                    if (this.value.match(/^#[0-9A-F]{6}$/i)) {
                        colorInput.value = this.value;
                    }
                });
            });
        </script>
        <script>
            document.getElementById('email_theme').addEventListener('change', function() {
                const colorInputs = document.getElementById('color_inputs');
                if (this.value === 'custom') {
                    colorInputs.style.display = 'block';
                } else {
                    colorInputs.style.display = 'none';
                }
            });
        </script>
        <script>
            function openCenteredPopup(url, w = 520, h = 680, name = 'plex-auth', offsetX = 0, offsetY = 0) {
                const dualLeft = window.screenLeft ?? window.screenX;
                const dualTop  = window.screenTop  ?? window.screenY;

                const vw = window.innerWidth  || document.documentElement.clientWidth  || screen.width;
                const vh = window.innerHeight || document.documentElement.clientHeight || screen.height;

                let left = dualLeft + (vw - w) / 2 + offsetX;
                let top  = dualTop  + (vh - h) / 2 + offsetY;

                left = Math.max(dualLeft, Math.min(left, dualLeft + vw - w));
                top  = Math.max(dualTop,  Math.min(top,  dualTop  + vh - h));

                const features = `width=${w},height=${h},left=${Math.round(left)},top=${Math.round(top)},` +
                                `resizable=yes,scrollbars=yes,toolbar=no,menubar=no,location=yes,noopener,noreferrer`;

                const win = window.open(url, name, features);
                if (!win) return window.open(url, '_blank', 'noopener,noreferrer');
                win.focus();
                return win;
            }
            
            const button = document.getElementById('connect_plex');
            const statusEl = document.getElementById('plex_status');
            let pollTimer = null;
            let connected_to_plex = false;

            button?.addEventListener('click', async () => {
                button.disabled = true;
                statusEl.textContent = '';
                showSpinner('Waiting for Plex approval...');

                try {
                    const r = await fetch('/api/plex/pin', {method: 'POST'});
                    if (!r.ok) throw new Error('Failed to create PIN');
                    const data = await r.json();

                    hideSpinner();
                    showSpinner(`Enter this code into Plex: ${data.code}`);
                    const authWin = openCenteredPopup(data.auth_url, 520, 480, 'plex-auth', 520);

                    const start = Date.now();
                    const timeoutMs = (data.expires_in ?? 600) * 1000;

                    async function waitForPIN() {
                        return new Promise((resolve, reject) => {
                            const poll = async () => {
                                const pollr = await fetch(`/api/plex/pin/${data.pin_id}`);
                                const polld = await pollr.json();
                                if (polld.connected) {
                                    hideSpinner();
                                    statusEl.textContent = 'Connected! Your Plex token is saved.';
                                    clearInterval(pollTimer);
                                    button.disabled = false;
                                    resolve(polld);
                                    return;
                                }
                                if (Date.now() - start > timeoutMs) {
                                    hideSpinner();
                                    statusEl.textContent = 'PIN expired. Please try again.';
                                    clearInterval(pollTimer);
                                    button.disabled = false;
                                    reject(new Error('PIN expired.'));
                                }
                            };
                            pollTimer = setInterval(poll, 1500);
                            poll();
                        });
                    }

                    async function getPlexInfo(authWin) {
                        const polld = await waitForPIN();

                        showSpinner('Retreiving Plex information...');
                        const infor = await fetch('/api/plex/info', {method: 'GET'});
                        if (!infor.ok) throw new Error('Failed to get info');
                        const infod = await infor.json();

                        if (infod.connected) {
                            try { if (authWin && !authWin.closed) authWin.close(); } catch {}
                            hideSpinner();
                            statusEl.textContent = 'Plex information retrieved.';
                            setTimeout(() => location.replace(location.href), 2000);
                            return;
                        }
                    }

                    getPlexInfo(authWin);
                } catch (e) {
                    hideSpinner();
                    statusEl.textContent = 'Error starting Plex connection.';
                    button.disabled = false;
                }
            });

            document.addEventListener('keydown', function(event) {
                if (event.ctrlKey && event.key === 's') {
                    event.preventDefault();
                    
                    const settingsForm = document.getElementById('settings_form');
                    const applyButton = document.getElementById('apply_settings');
                    
                    if (settingsForm && applyButton) {
                        showSpinner('Applying settings...');
                        settingsForm.submit();
                    }
                }
            });
        </script>
    </div>
</div>
{% endblock %}
