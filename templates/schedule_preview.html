{% extends "base.html" %}
{% block title %}Email Preview{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="card theme-card">
                <div class="card-header theme-card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">ðŸ“§ Email Preview - <span id="schedule-name"></span></h3>
                    <button class="btn btn-primary" onclick="window.close()">Close Preview</button>
                </div>
                <div class="card-body">
                    <div id="loading" class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-info">Loading template data and generating preview...</p>
                    </div>
                    
                    <div id="error" class="alert alert-danger" style="display: none;"></div>
                    
                    <div id="preview-section" aria-hidden="true" style="opacity:0; z-index:-1;">
                        <input type="hidden" id="subject" value="">
                        <input type="hidden" id="email_text" value="">
                        <input type="hidden" id="layout" value="standard">
                        <input type="hidden" id="graph_placeholder" value="">
                        <input type="hidden" id="stat_placeholder" value="">
                        
                        <div class="row mt-3">
                            <div class="col-lg-12">
                                <div class="card theme-card">
                                    <div class="card-header theme-card-header">
                                        <h5 class="mb-0">ðŸ“§ Email Preview</h5>
                                    </div>
                                    <div class="card-body">
                                        <iframe id="preview" style="width: 100%; height: 600px; border: 1px solid #dee2e6; border-radius: 4px; background: white;"></iframe>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="stats-container" style="display: none;"></div>
                        <div id="graphs-container" style="display: none;"></div>
                        <div id="workbench" style="position:fixed; left:-10000px; top:-10000px; width:1920px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/10.3.3/highcharts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/10.3.3/modules/exporting.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const scheduleId = urlParams.get('schedule_id');
    const themeSettings = {{ theme_settings | tojson }};
    const displayPreference = "{{ settings.recipient_display_name }}";

    let templateData = {};
    let stats = [];
    let graphData = [];
    let recentData = [];
    let recsPayload = {};
    let selectedItems = [];
    let graphCommands = [];
    let recentCommands = [];
    let userDict = {};
    let usersFullData = {};
    let expandedCollections = {};

    async function blurImageElement(imgElement) {
        const tempImg = new Image();
        tempImg.crossOrigin = 'anonymous';
        tempImg.src = imgElement.src;

        await new Promise((resolve, reject) => {
            tempImg.onload = resolve;
            tempImg.onerror = reject;
        });

        const rect = imgElement.getBoundingClientRect();
        const canvas = document.createElement('canvas');
        canvas.width = rect.width || 800;
        canvas.height = rect.height || 450;

        const ctx = canvas.getContext('2d');
        ctx.filter = 'blur(4px) brightness(0.75)';
        ctx.drawImage(tempImg, 0, 0, canvas.width, canvas.height);

        const blurredDataURL = canvas.toDataURL('image/png');
        imgElement.src = blurredDataURL;
        imgElement.style.position = 'absolute';
        imgElement.style.width = '100%';
        imgElement.style.height = '100%';
        imgElement.style.objectFit = 'cover';
        imgElement.style.zIndex = '0';
    }

    const esc = (s='') => String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');

    function getThemedEmailCSS() {
        const emailTheme = themeSettings.email_theme || 'newsletter_blue';
        const isDark = document.documentElement.classList.contains('dark');
        
        let bgColor, textColor, cardBg, borderColor, mutedColor;

        bgColor = themeSettings.background_color || '#333333';
        textColor = themeSettings.text_color || '#62a1a4';
        cardBg = '#2d2d2d';
        borderColor = '#404040';
        mutedColor = '#cccccc';
        
        const primaryColor = themeSettings.primary_color || '#8acbd4';
        const secondaryColor = themeSettings.secondary_color || '#222222';
        const accentColor = themeSettings.accent_color || '#62a1a4';
        const logoWidth = "{{ settings.logo_width or 80 }}";
        
        return `
            <style>
                @import url(https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400,700&display=swap);

                :root {
                    --email-bg: ${bgColor};
                    --email-text: ${textColor};
                    --email-primary: ${primaryColor};
                    --email-secondary: ${secondaryColor};
                    --email-accent: ${accentColor};
                    --email-card-bg: ${cardBg};
                    --email-border: ${borderColor};
                    --email-muted: ${mutedColor};
                }
                
                body {
                    margin: 0;
                    padding: 0;
                    font-family: 'IBM Plex Sans';
                    background-color: var(--email-bg);
                    line-height: 1.6;
                    color: var(--email-text);
                }
                
                .email-container {
                    width: 100%;
                    background: var(--email-card-bg);
                    border-radius: 8px;
                    overflow: hidden;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    border: 1px solid var(--email-border);
                }
                
                .email-header {
                    background: linear-gradient(135deg, var(--email-accent) 0%, var(--email-primary) 100%);
                    color: white;
                    padding: 10px 20px;
                    text-align: center;
                }
                
                .email-logo {
                    max-width: ${logoWidth}px;
                    height: auto;
                }
                
                .email-title {
                    font-size: 28px;
                    font-weight: bold;
                    margin: 0;
                    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                }
                
                .email-content {
                    padding: 10px 15px;
                    color: var(--email-text);
                    background: var(--email-card-bg);
                }
                
                .email-footer {
                    background: var(--email-secondary);
                    padding: 20px;
                    text-align: center;
                    border-top: 3px solid var(--email-primary);
                    color: var(--email-muted);
                    font-size: 12px;
                }
                
                .email-footer a {
                    color: var(--email-accent);
                    text-decoration: none;
                }
                
                .stats-card {
                    margin: 20px 0;
                    border-radius: 8px;
                    overflow: hidden;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    border: 1px solid var(--email-border);
                    position: relative;
                }
                
                .stats-bg-blur {
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-size: cover;
                    background-position: center;
                    background-repeat: no-repeat;
                    filter: blur(5px) brightness(1);
                    z-index: 0;
                }
                
                .stats-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.3);
                    z-index: 1;
                }
                
                .stats-content {
                    position: relative;
                    z-index: 2;
                }
                
                .stats-header {
                    background: var(--email-bg);
                    color: var(--email-primary);
                    padding: 15px;
                    text-align: center;
                    font-weight: bold;
                    font-size: 18px;
                }
                
                .stats-table {
                    width: 100%;
                    border-collapse: collapse;
                }
                
                .stats-table th {
                    padding: 12px;
                    background: rgba(52, 58, 64, 0.9);
                    color: white;
                    font-weight: bold;
                    border: none;
                }
                
                .stats-table td {
                    padding: 12px;
                    background: rgba(255, 255, 255, 0.5);
                    color: #333;
                    border-bottom: 1px solid rgba(222, 226, 230, 0.8);
                }

                .recently-added {
                    background: var(--email-card-bg);
                    padding-bottom: 10px;
                    border-radius: 8px;
                    margin: 20px 0;
                    border: 1px solid var(--email-border);
                }
                
                .recently-added h2 {
                    text-align: center;
                    color: var(--email-text);
                    margin-bottom: 10px;
                    margin-top: 0;
                }
                
                .recommendations-block {
                    margin: 30px 0;
                    padding: 20px;
                    background: var(--email-card-bg);
                    border-radius: 8px;
                    border: 1px solid var(--email-border);
                }
                
                .recommendations-block h2, .recommendations-block h3 {
                    color: var(--email-text);
                }
                
                .chart-placeholder {
                    margin: 20px 0;
                    padding: 30px;
                    background: var(--email-card-bg);
                    border: 2px dashed var(--email-border);
                    border-radius: 8px;
                    text-align: center;
                }
                
                .chart-placeholder h3, .chart-placeholder p {
                    color: var(--email-muted);
                }
            </style>
        `;
    }

    function msToHMS(ms) {
        ms = parseInt(ms || 0, 10);
        const s = Math.round(ms / 1000);
        const h = Math.floor(s/3600);
        const m = Math.floor((s%3600)/60);
        return h ? `${h}h ${m}m` : `${m}m`;
    }

    function formatDate(d) {
        if (!d) return '';
        
        let targetDate;
        if (/^\d+$/.test(String(d))) {
            targetDate = new Date(parseInt(d, 10) * 1000);
        } else {
            targetDate = new Date(d);
        }
        
        if (isNaN(targetDate)) return '';
        
        const now = new Date();
        const diffMs = now - targetDate;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
            return `in ${Math.abs(diffDays)} days`;
        } else if (diffDays === 0) {
            return 'today';
        } else if (diffDays === 1) {
            return 'yesterday';
        } else {
            return `${diffDays} days ago`;
        }
    }

    function pickThumb(it) {
        const type = (it.media_type || it.type || '').toLowerCase();
        const candidates = (type === 'episode' || type === 'season')
            ? [it.grandparent_thumb, it.parent_thumb, it.thumb, it.art]
            : [it.thumb, it.art, it.parent_thumb, it.grandparent_thumb];
        return candidates.find(Boolean) || '';
    }

    function getUserDisplayName(userKey) {
        if (!usersFullData || !Array.isArray(usersFullData)) {
            return userDict[userKey] || userKey;
        }
        const user = usersFullData.find(u => String(u.user_id) === String(userKey));
        
        if (!user) {
            return userDict[userKey] || userKey;
        }

        if (displayPreference === 'username') {
            return user.username || user.email || userKey;
        } else if (displayPreference === 'friendly_name') {
            return user.friendly_name || user.username || user.email || userKey;
        } else {
            return user.email || user.username || userKey;
        }
    }

    function statTheadHTML(title='') {
        if (title === "Most Watched Movies" || title === "Most Watched TV Shows") {
            return `<thead class="table-dark"><tr>
                <th>Title</th><th>Year</th><th>Plays</th><th>Hours Played</th><th>Rating</th>
                </tr></thead>`;
        } else if (title === "Most Popular Movies" || title === "Most Popular TV Shows") {
            return `<thead class="table-dark"><tr>
                <th>Title</th><th>Year</th><th>Plays</th><th>Users</th><th>Rating</th>
                </tr></thead>`;
        } else if (title === "Most Played Artists") {
            return `<thead class="table-dark"><tr>
                <th>Author</th><th>Year</th><th>Plays</th><th>Hours Played</th>
                </tr></thead>`;
        } else if (title === "Most Popular Artists") {
            return `<thead class="table-dark"><tr>
                <th>Author</th><th>Year</th><th>Plays</th><th>Users</th>
                </tr></thead>`;
        } else if (title === "Recently Watched") {
            return `<thead class="table-dark"><tr>
                <th>Title</th><th>Year</th><th>Rating</th>
                </tr></thead>`;
        } else if (title === "Most Active Libraries") {
            return `<thead class="table-dark"><tr>
                <th>Library</th><th>Plays</th><th>Hours Played</th>
                </tr></thead>`;
        } else if (title === "Most Active Users") {
            return `<thead class="table-dark"><tr>
                <th>Username</th><th>Plays</th><th>Hours Played</th>
                </tr></thead>`;
        } else if (title === "Most Active Platforms") {
            return `<thead class="table-dark"><tr>
                <th>Platform</th><th>Plays</th><th>Hours Played</th>
                </tr></thead>`;
        } else if (title === "Most Concurrent Streams") {
            return `<thead class="table-dark"><tr>
                <th>Category</th><th>Count</th>
                </tr></thead>`;
        }
        return '';
    }

    function statRowHTML(title, row) {
        const firstCol =
            title === "Most Active Libraries" ? row.section_name :
            title === "Most Active Users" ? row.user :
            title === "Most Active Platforms" ? row.platform :
            row.title;

        const showYear = !["Most Active Libraries", "Most Active Users", "Most Active Platforms", "Most Concurrent Streams"].includes(title);
        const showPlays = !(title.includes("Recently") || title.includes("Concurrent"));
        const hours = Math.ceil((row.total_duration || 0)/3600);
        const rating = row.content_rating || '';
        const usersWatch = row.users_watched;

        let tds = `<td>${esc(firstCol||'')}</td>`;
        if (showYear) tds += `<td>${esc(row.year||'')}</td>`;
        if (showPlays) tds += `<td>${esc(row.total_plays ?? row.plays ?? row.count ?? 0)}</td>`;

        if (["Most Watched Movies", "Most Watched TV Shows", "Most Played Artists", "Most Active Libraries", "Most Active Users", "Most Active Platforms"].includes(title)) {
            tds += `<td>${hours}</td>`;
        } else if (["Most Popular Movies", "Most Popular TV Shows", "Most Popular Artists"].includes(title)) {
            tds += `<td>${esc(usersWatch ?? '')}</td>`;
        }

        if (!["Most Active Libraries", "Most Played Artists", "Most Popular Artists", "Most Active Users", "Most Active Platforms", "Most Concurrent Streams"].includes(title)) {
            tds += `<td>${esc(rating)}</td>`;
        }

        if (title === "Most Concurrent Streams") {
            tds += `<td>${esc(row.count ?? 0)}</td>`;
        }

        return `<tr>${tds}</tr>`;
    }

    function buildStatCardHTML(stat, dateRange) {
        const title = stat.stat_title || 'Stats';
        const rows = Array.isArray(stat.rows) ? stat.rows : [];
        const bg = rows[0]?.art || rows[0]?.grandparent_thumb || '';

        const body = rows.length
            ? rows.map(r => statRowHTML(title, r)).join('')
            : `<tr><td class="p-3" colspan="8">No data available.</td></tr>`;

        return `
            <div class="card my-4">
                <div class="card-header bg-primary text-white">${esc(title)}</div>
                <div class="card-body blur-container p-0" style="position:relative;">
                ${bg ? `<img src="/proxy-art${esc(bg)}" class="bg-blur" alt="">` : ''}
                <table class="table table-striped content-table m-0">
                    ${statTheadHTML(title)}
                    <tbody>${body}</tbody>
                </table>
                </div>
            </div>`;
    }

    function themeVars(isDark) {
        return {
            text: isDark ? '#8acbd4' : '#333',
            grid: isDark ? '#e5e7eb' : '#374151',
            axis: isDark ? '#e5e7eb' : '#374151',
            bg: isDark ? '#333' : '#8acbd4',
        };
    }

    function applyChartTheme(isDark) {
        const t = themeVars(isDark);
        Highcharts.setOptions({
            chart: { backgroundColor: t.bg, style: { fontFamily: 'IBM Plex Sans' } },
            title: { style: { color: t.text } },
            legend:{ itemStyle: { color: t.text } },
            xAxis: { labels:{ style:{ color: t.text }}, gridLineColor:t.grid, lineColor:t.axis, tickColor:t.axis },
            yAxis: { labels:{ style:{ color: t.text }}, title:{ style:{ color: t.text }}, gridLineColor:t.grid, lineColor:t.axis, tickColor:t.axis },
            credits:{ enabled:false }
        });
        Highcharts.charts.filter(Boolean).forEach(c=>{
            c.update({ chart:{ backgroundColor:t.bg }, title:{ style:{ color:t.text }}, legend:{ itemStyle:{ color:t.text }} });
            c.xAxis?.forEach(ax=>ax.update({ labels:{ style:{ color:t.text }}, gridLineColor:t.grid, lineColor:t.axis, tickColor:t.axis }));
            c.yAxis?.forEach(ax=>ax.update({ labels:{ style:{ color:t.text }}, title:{ style:{ color:t.text }}, gridLineColor:t.grid, lineColor:t.axis, tickColor:t.axis }));
            c.redraw();
        });
    }

    async function loadPreview() {
        try {
            if (!scheduleId) {
                throw new Error('No schedule ID provided');
            }
            
            const response = await fetch(`/scheduling/${scheduleId}/preview`);
            const data = await response.json();
            
            if (data.status !== 'success') {
                throw new Error(data.message);
            }
            
            templateData = data;
            selectedItems = data.selected_items || [];
            expandedCollections = data.expanded_collections || {};
            
            stats = data.stats || [];
            graphData = data.graph_data || [];
            recentData = data.recent_data || [];
            recsPayload = data.recommendations || {};
            graphCommands = data.graph_commands || [];
            recentCommands = data.recent_commands || [];
            userDict = data.user_dict || {};
            usersFullData = data.users_full_data || {};
            dateRange = data.date_range || '';

            console.log('Loaded fresh data:', { 
                stats: stats.length, 
                graphs: graphData.length, 
                recent: recentData.length,
                recos: Object.keys(recsPayload).length,
                dateRange: dateRange,
                itemsCount: data.items_count,
                graphCommands: graphCommands.length
            });
            
            document.getElementById('schedule-name').textContent = data.template_name;
            
            document.getElementById('subject').value = data.subject || '';
            document.getElementById('email_text').value = data.email_text || '';
            document.getElementById('layout').value = data.layout || 'standard';
            
            await generateStatsAndGraphs(dateRange);

            await new Promise(resolve => setTimeout(resolve, 5000));
            
            await updatePreview();
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('preview-section').style.display = 'block';
            document.getElementById('preview-section').ariaHidden = 'false';
            document.getElementById('preview-section').style.opacity = '1';
            document.getElementById('preview-section').style.zIndex = '1';
        } catch (error) {
            console.error('Error loading preview:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = 'Error: ' + error.message;
        }
    }

    async function generateStatsAndGraphs(dateRange) {
        console.log('generateStatsAndGraphs: Starting with graphData:', graphData);
        
        const statsContainer = document.getElementById('stats-container');
        const graphsContainer = document.getElementById('graphs-container');
        
        statsContainer.innerHTML = '';
        graphsContainer.innerHTML = '';
        
        if (Array.isArray(stats) && stats.length) {
            stats.forEach((stat, i) => {
                const wrap = document.createElement('div');
                wrap.id = `stat-${i}`;
                wrap.className = 'stat-table d-none';
                wrap.innerHTML = buildStatCardHTML(stat, dateRange);
                const bg = wrap.querySelector('.bg-blur');
                if (bg) { blurImageElement(bg).catch(()=>{}); }
                statsContainer.appendChild(wrap);
            });
        }
        
        if (Array.isArray(graphData) && graphData.length) {
            console.log(`generateStatsAndGraphs: Processing ${graphData.length} graphs`);
            
            graphData.forEach((g, i) => {
                const id = `graph-${i}`;
                const div = document.createElement('div');
                div.id = id;
                div.className = 'graph-table d-none';
                div.style.width = '600px';
                div.style.height = '400px';
                graphsContainer.appendChild(div);
            });

            await new Promise(resolve => setTimeout(resolve, 100));

            for (let i = 0; i < graphData.length; i++) {
                const g = graphData[i];
                const id = `graph-${i}`;
                const cmd = graphCommands[i] || { name: `Chart ${i+1}`, command: '' };
                                
                const container = document.getElementById(id);
                
                if (!container) {
                    console.error(`generateStatsAndGraphs: Container ${id} not found!`);
                    continue;
                }
                
                try {
                    const cfg = {
                        chart: { type: 'line', style: { fontFamily: 'IBM Plex Sans, Segoe UI, Helvetica, Arial, sans-serif' } },
                        title: { text: cmd.name + ' - Last ' + `${dateRange}` + ' days' },
                        exporting: { enabled: true },
                        xAxis: { categories: g.categories || [] },
                        yAxis: { title: { text: 'Plays' } },
                        series: g.series || []
                    };
                    
                    if (typeof Highcharts === 'undefined') {
                        console.error('generateStatsAndGraphs: Highcharts is not available!');
                        break;
                    }
                    
                    const chart = Highcharts.chart(id, cfg);
                    
                    const chartInArray = Highcharts.charts.find(c => c && c.renderTo && c.renderTo.id === id);
                    
                    await new Promise(resolve => setTimeout(resolve, 50));
                } catch (error) {
                    console.error(`generateStatsAndGraphs: Error creating chart ${id}:`, error);
                }
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const totalCharts = Highcharts.charts.filter(Boolean).length;
            console.log(`generateStatsAndGraphs: Final chart count: ${totalCharts}`);
            console.log(`generateStatsAndGraphs: All chart IDs:`, 
                Highcharts.charts.filter(Boolean).map(c => c.renderTo?.id).filter(Boolean));
        } else {
            console.log('generateStatsAndGraphs: No graph data available');
        }
        
        const nowDark = document.documentElement.classList.contains('dark');
        applyChartTheme(nowDark);
        document.getElementById('theme-toggle')?.addEventListener('click', () => {
            const darkNow = document.documentElement.classList.contains('dark');
            applyChartTheme(!darkNow);
        });
    }

    async function updatePreview() {
        try {
            console.log('updatePreview called with selectedItems:', selectedItems);
            
            if (typeof selectedItems === 'undefined') {
                console.error('selectedItems is undefined in updatePreview');
                return;
            }
            
            const emailHTML = await generateEmailHTML();
            
            const frame = document.getElementById('preview');
            if (!frame) {
                console.error('Preview iframe not found!');
                return;
            }
            
            frame.srcdoc = emailHTML;
            
            frame.onload = function() {
                try {
                    const doc = frame.contentDocument || frame.contentWindow.document;
                    if (doc && doc.documentElement) {
                        resizePreviewFrame(frame);
                    }
                } catch (e) {
                    console.log('Could not resize iframe:', e);
                }
            };
            
            console.log('Preview updated successfully');
        } catch (error) {
            console.error('Error in updatePreview:', error);
            const frame = document.getElementById('preview');
            if (frame) {
                frame.srcdoc = `<html><body><p>Error updating preview: ${error.message}</p></body></html>`;
            }
        }
    }

    async function generateEmailHTML() {
        const serverName = templateData.settings?.server_name || '';
        const subject = document.getElementById('subject').value;
        const emailText = document.getElementById('email_text').value;

        let contentHTML = "";
        
        for (let [itemIndex, item] of selectedItems.entries()) {
            if (item.type === 'textblock') {
                const content = item.content || '';
                if (content && content.trim().length > 0) {
                    const formattedContent = content.trim().replace(/\n/g, "<br>");
                    contentHTML += `<div style="margin-bottom: 15px; line-height: 1.6; text-align: center">${formattedContent}</div>`;
                }
            } else if (item.type === 'headerblock') {
                const content = item.content || '';
                if (content && content.trim().length > 0) {
                    const formattedContent = content.trim().replace(/\n/g, "<br>");
                    contentHTML += `<div style="margin-bottom: 20px; font-size: 1.5em; font-weight: bold; text-align: center;">${formattedContent}</div>`;
                }
            } else if (item.type === 'titleblock') {
                const content = item.content || '';
                if (content && content.trim().length > 0) {
                    const formattedContent = content.trim().replace(/\n/g, "<br>");
                    contentHTML += `<div style="margin-bottom: 20px; font-size: 2em; font-weight: bold; text-align: center;">${formattedContent}</div>`;
                }
            } else if (item.type === 'stat') {
                contentHTML += buildStatHTML(item.id, dateRange);
            } else if (item.type === 'graph') {
                console.log('Processing graph item:', item.id);
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const availableCharts = Highcharts.charts.filter(Boolean);
                
                const chart = Highcharts.charts.find(c => c && c.renderTo && c.renderTo.id === item.id);
                
                if (chart) {
                    try {
                        console.log(`Processing chart ${item.id} - Title: ${chart.title?.textStr || 'No title'}`);
                        
                        const svg = chart.getSVG();
                        
                        const canvas = document.createElement("canvas");
                        const ctx = canvas.getContext("2d");
                        const img = new Image();

                        await new Promise((resolve, reject) => {
                            img.onload = () => {
                                canvas.width = img.width;
                                canvas.height = img.height;
                                ctx.drawImage(img, 0, 0);
                                const dataUrl = canvas.toDataURL("image/png");
                                contentHTML += `<div style="text-align: center"><img src="${dataUrl}" style="max-width: 100%; margin-bottom: 10px;"></div>`;
                                resolve();
                            };
                            img.onerror = (error) => {
                                console.warn('Failed to load graph image for', item.id, error);
                                reject(error);
                            };
                            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
                        });
                    } catch (error) {
                        console.warn('Error processing graph', item.id, error);
                        const graphIndex = parseInt(item.id.split('-')[1]);
                        const commandInfo = graphCommands[graphIndex] || { name: 'Chart' };
                        contentHTML += `
                            <div style="margin: 20px 0; padding: 20px; background: #333; border-radius: 5px; border-left: 4px solid #E5A00D;">
                                <h3 style="color: #E5A00D;">${commandInfo.name}</h3>
                                <p style="color: #fff;">Chart data for the past ${templateData.date_range || 7} days</p>
                                <p style="color: #ccc; font-size: 14px;">Chart will be generated when email is sent with fresh data</p>
                            </div>`;
                    }
                } else {
                    console.warn('Chart not found for', item.id, 'Available chart IDs:', 
                        Highcharts.charts.filter(Boolean).map(c => c.renderTo?.id).filter(Boolean));
                    const graphIndex = parseInt(item.id.split('-')[1]);
                    const commandInfo = graphCommands[graphIndex] || { name: 'Chart' };
                    contentHTML += `
                        <div style="margin: 20px 0; padding: 20px; background: #333; border-radius: 5px; border-left: 4px solid #E5A00D;">
                            <h3 style="color: #E5A00D;">${commandInfo.name}</h3>
                            <p style="color: #fff;">Chart data for the past ${templateData.date_range || 7} days</p>
                            <p style="color: #ccc; font-size: 14px;">Chart will be generated when email is sent with fresh data</p>
                        </div>`;
                }
            } else if (item.type === 'recently added') {
                contentHTML += buildRecentlyAddedHTML(item.raLibrary);
            } else if (item.type === 'recommendations') {
                contentHTML += buildRecommendationsHTML(item.userKey);
            } else if (item.type === 'collection_group') {
                const groupTitle = item.title || 'Collections';
                const groupCollections = item.collections || [];
                if (groupCollections.length > 0) {
                    contentHTML += buildCollectionPreviewHTMLForEmail(groupTitle, groupCollections, itemIndex);
                }
            }
        }

        return buildCompleteEmailHTML(contentHTML, serverName, subject);
    }

    function buildStatHTML(statId, dateRange) {
        const statIndex = parseInt(statId.split('-')[1]);
        if (statIndex >= stats.length) return '';
        
        const stat = stats[statIndex];
        if (!stat || !stat.rows) return '';
        
        const title = stat.stat_title || 'Statistics';
        const rows = stat.rows;
        
        let backgroundElements = '';
        let hasBackground = false;
        if (rows.length > 0) {
            const artwork = rows[0].art || rows[0].grandparent_thumb;
            if (artwork) {
                const baseUrl = window.location.origin;
                const artworkUrl = `${baseUrl}/proxy-art${artwork}`;
                hasBackground = true;
                backgroundElements = `
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-image: url('${artworkUrl}');
                        background-size: cover;
                        background-position: center;
                        background-repeat: no-repeat;
                        filter: blur(5px) brightness(1);
                        z-index: 0;
                    "></div>
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.3);
                        z-index: 1;
                    "></div>
                `;
            }
        }
        
        function getStatHeaders(title) {
            if (title === "Most Watched Movies" || title === "Most Watched TV Shows") {
                return ["Title", "Year", "Plays", "Hours Played", "Rating"];
            } else if (title === "Most Popular Movies" || title === "Most Popular TV Shows") {
                return ["Title", "Year", "Plays", "Users", "Rating"];
            } else if (title === "Most Played Artists") {
                return ["Author", "Year", "Plays", "Hours Played"];
            } else if (title === "Most Popular Artists") {
                return ["Author", "Year", "Plays", "Users"];
            } else if (title === "Recently Watched") {
                return ["Title", "Year", "Rating"];
            } else if (title === "Most Active Libraries") {
                return ["Library", "Plays", "Hours Played"];
            } else if (title === "Most Active Users") {
                return ["Username", "Plays", "Hours Played"];
            } else if (title === "Most Active Platforms") {
                return ["Platform", "Plays", "Hours Played"];
            } else if (title === "Most Concurrent Streams") {
                return ["Category", "Count"];
            }
            return ["Title", "Value"];
        }
        
        function getStatCells(title, row) {
            const cells = [];
            
            if (title === "Most Active Libraries") {
                cells.push(row.section_name || '');
            } else if (title === "Most Active Users") {
                cells.push(row.user || '');
            } else if (title === "Most Active Platforms") {
                cells.push(row.platform || '');
            } else {
                cells.push(row.title || '');
            }
            
            const skipYearStats = ["Most Active Libraries", "Most Active Users", "Most Active Platforms", "Most Concurrent Streams"];
            if (!skipYearStats.includes(title)) {
                cells.push(row.year || '');
            }
            
            if (!title.includes("Recently") && !title.includes("Concurrent")) {
                cells.push(row.total_plays || 0);
            }
            
            const hoursStats = ["Most Watched Movies", "Most Watched TV Shows", "Most Played Artists", "Most Active Libraries", "Most Active Users", "Most Active Platforms"];
            const usersStats = ["Most Popular Movies", "Most Popular TV Shows", "Most Popular Artists"];
            
            if (hoursStats.includes(title)) {
                const hours = Math.ceil((row.total_duration || 0) / 3600);
                cells.push(hours);
            } else if (usersStats.includes(title)) {
                cells.push(row.users_watched || '');
            }
            
            const skipRatingStats = ["Most Active Libraries", "Most Played Artists", "Most Popular Artists", "Most Active Users", "Most Active Platforms", "Most Concurrent Streams"];
            if (!skipRatingStats.includes(title)) {
                cells.push(row.content_rating || '');
            }
            
            if (title === "Most Concurrent Streams") {
                cells.push(row.count || 0);
            }
            
            return cells;
        }
        
        const headers = getStatHeaders(title);
        const headerHTML = headers.map(h => 
            `<th style="padding: 12px; background: rgba(52, 58, 64, 0.9); color: white; font-weight: bold;">${h}</th>`
        ).join('');
        
        const rowsHTML = rows.map(row => {
            const cells = getStatCells(title, row);
            const cellsHTML = cells.map(cell => 
                `<td style="color: black; padding: 12px; background: rgba(255, 255, 255, 0.5); border-bottom: 1px solid rgba(222, 226, 230, 0.8);">${cell}</td>`
            ).join('');
            return `<tr>${cellsHTML}</tr>`;
        }).join('');

        const containerStyle = `
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--email-border);
            position: relative;
            ${hasBackground ? '' : 'background: var(--email-card-bg);'}
        `;
        
        const headerStyle = `
            background: var(--email-bg);
            color: var(--email-primary);
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            position: relative;
            z-index: 2;
        `;
        
        const tableStyle = `
            width: 100%;
            border-collapse: collapse;
            position: relative;
            z-index: 2;
        `;
        
        return `
            <div class="stats-card" style="${containerStyle}">
                ${backgroundElements}
                <div class="stats-content" style="position: relative; z-index: 2;">
                    <div class="stats-header" style="${headerStyle}">${title} - Last ${dateRange} days</div>
                    <table class="stats-table" style="${tableStyle}">
                        <thead>
                            <tr>${headerHTML}</tr>
                        </thead>
                        <tbody>
                            ${rowsHTML}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function buildRecentlyAddedHTML(libraryFilter) {
        if (!recentData || recentData.length === 0) {
            return `<div class="recently-added"><p style="text-align: center; color: var(--email-muted); padding: 20px;">No recently added items available</p></div>`;
        }
        
        let allItems = [];
        recentData.forEach(section => {
            if (section && section.recently_added) {
                allItems = allItems.concat(section.recently_added);
            }
        });
        
        if (libraryFilter) {
            allItems = allItems.filter(item => 
                item.library_name && item.library_name.toLowerCase().includes(libraryFilter.toLowerCase())
            );
        }
        
        const seenShows = new Set();
        const deduplicated = [];
        
        for (const item of allItems) {
            const itemType = (item.media_type || item.type || '').toLowerCase();
            
            if (itemType === 'episode' || itemType === 'season') {
                const showId = item.grandparent_rating_key || item.grandparent_title;
                
                if (showId && !seenShows.has(showId)) {
                    seenShows.add(showId);
                    const displayItem = { ...item };
                    displayItem.original_title = item.title;
                    displayItem.title = item.grandparent_title || item.title;
                    deduplicated.push(displayItem);
                }
            } else {
                deduplicated.push(item);
            }
        }

        const maxItems = templateData.items_count ? parseInt(templateData.items_count) : 10;
        allItems = deduplicated.slice(0, maxItems);
        
        if (allItems.length === 0) {
            return `<div class="recently-added"><p style="text-align: center; color: var(--email-muted); padding: 20px;">No recently added items found${libraryFilter ? ` for ${libraryFilter}` : ''}</p></div>`;
        }
        
        const gridItems = allItems.map(item => {
            const item_type = (item.media_type || item.type || '').toLowerCase();
            const title = item.title || item.full_title || item.parent_title || item.grandparent_title || '(untitled)';
            const sub = item.year || item.grandparent_title || item.parent_title || '';
            const thumbPath = pickThumb(item);
            let duration = '';
            if (item_type === 'album') {
                duration = item.duration || item.grandparent_title || item.parent_title || 'Audio';
            } else {
                duration = msToHMS(item.duration);
            }
            const added = formatDate(item.updated_at || item.originally_available_at);
            const library = item.library_name || item.section_name || '';

            let summary = '';
            if (item_type === 'episode' || item_type === 'season') {
                summary = item.grandparent_tagline || item.grandparent_summary || item.parent_summary || item.tagline || item.summary || '';
            } else {
                summary = item.tagline || item.summary || '';
            }
            
            return {
                title,
                sub,
                summary: summary,
                duration,
                added,
                thumb: thumbPath,
                library,
                plex_url: item.plex_url || ''
            };
        });
        
        const itemsHTML = gridItems.map(item => {
            const imgURL = item.thumb ? `/proxy-art${item.thumb.startsWith('/') ? item.thumb : '/' + item.thumb}` : '/static/img/no-poster.png';
            
            const cardContent = `
                <div style="
                    position: relative;
                    background: var(--email-card-bg);
                    border-radius: 12px;
                    overflow: hidden;
                    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
                    border: 1px solid var(--email-border);
                    width: 100%;
                    max-width: 200px;
                    margin: 0 auto;
                    height: 310px;
                    display: flex;
                    flex-direction: column;
                ">
                    <div style="position: relative; aspect-ratio: 2/3; background: #f8f9fa;">
                        <img src="${imgURL}" style="width: 100%; height: 100%; object-fit: cover; display: block;" alt="${item.title}">
                        ${item.added ? `
                            <div style="
                                position: absolute;
                                bottom: 1px;
                                right: 1px;
                                background: rgba(0, 0, 0, 0.6);
                                color: rgba(255, 255, 255, 0.9);
                                padding: 2px 6px;
                                border-radius: 4px;
                                font-size: 9px;
                                line-height: 1;
                            ">${item.added}</div>
                        ` : ''}
                    </div>
                    <div style="padding: 6px;">
                        <div style="font-weight: bold; font-size: 14px; color: var(--email-text); margin-bottom: 4px; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${item.title}
                        </div>
                        <div style="font-size: 11px; color: var(--email-muted); margin-bottom: 8px; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${item.sub ? item.sub + ' â€¢ ' : ''}${item.duration}
                        </div>
                        ${item.summary ? `
                            <div style="font-size: 11px; color: var(--email-text); opacity: 0.8; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden;">
                                ${item.summary}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            if (item.plex_url) {
                return `
                    <a href="${item.plex_url}" 
                    class="plex-link"
                    style="text-decoration: none; color: inherit; display: block;" 
                    target="_blank"
                    title="Open in Plex">
                        ${cardContent}
                    </a>
                `;
            }
            
            return cardContent;
        }).join('');
        
        return `
            <div class="recently-added">
                <h2>Recently Added${libraryFilter ? ` - ${libraryFilter}` : ''}</h2>
                <div style="
                    display: grid;
                    grid-template-columns: repeat(5, 1fr);
                    gap: 12px;
                    margin: 15px auto 0 auto;
                    padding: 0;
                    width: 60%;
                ">
                    ${itemsHTML}
                </div>
            </div>
        `;
    }

    function buildRecommendationsHTML(userKey) {
        if (!recsPayload || !userKey || !recsPayload[userKey]) {
            return `<div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">No recommendations available for this user</div>`;
        }
        
        const userRecs = recsPayload[userKey];
        const userEmail = getUserDisplayName(userKey);
        
        let sectionsHTML = '';
        
        if (userRecs.movie_posters && userRecs.movie_posters.length > 0) {
            sectionsHTML += buildRecommendationsSectionHTML(
                userRecs.movie_posters.slice(0, 20),
                userRecs.movie_posters_unavailable?.slice(0, 20) || [],
                'Recommended Movies'
            );
        }
        
        if (userRecs.show_posters && userRecs.show_posters.length > 0) {
            sectionsHTML += buildRecommendationsSectionHTML(
                userRecs.show_posters.slice(0, 20),
                userRecs.show_posters_unavailable?.slice(0, 20) || [],
                'Recommended TV Shows'
            );
        }
        
        if (!sectionsHTML) {
            return `<div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">No recommendations for ${userEmail}</div>`;
        }
        
        return `
            <div class="recs-block" data-recs-user="${userKey}" style="margin: 30px 0; background: --email-bg; padding: 20px; border-radius: 8px;">
                <h2 style="text-align: center; color: --email-text; margin-bottom: 20px;">Recommendations for ${userEmail}</h2>
                ${sectionsHTML}
            </div>
        `;
    }

    function buildRecommendationsSectionHTML(availableItems, unavailableItems, title) {
        const allItems = [...availableItems, ...unavailableItems];
        
        const itemsHTML = allItems.map((item, index) => {
            const isUnavailable = index >= availableItems.length;
            const posterURL = item.url ? `/proxy-img?u=${encodeURIComponent(item.url)}` : '/static/img/no-poster.png';
            const titleText = item.title || 'Unknown';
            const year = item.year || '';
            const vote = item.vote ? `â˜… ${item.vote.toFixed(1)}` : '';
            const overview = item.overview || '';
            const runtime = item.runtime || '';

            let href;
            let linkTitle;
            if (isUnavailable) {
                href = item.href || '#';
                linkTitle = 'Request on Overseerr';
            } else {
                if (item.plex_url) {
                    href = item.plex_url;
                    linkTitle = 'Open in Plex';
                } else if (item.rating_key && item.machine_id) {
                    const metadataKey = encodeURIComponent(`/library/metadata/${item.rating_key}`);
                    href = `plex://preplay?metadataKey=${metadataKey}&server=${item.machine_id}`;
                    linkTitle = 'Open in Plex';
                } else {
                    const searchQuery = encodeURIComponent(titleText);
                    href = `https://app.plex.tv/desktop#!/search?query=${searchQuery}`;
                    linkTitle = 'Search in Plex';
                }
            }
            
            const unavailableStyle = isUnavailable ? 'opacity: 0.7; filter: grayscale(30%);' : '';
            
            return `
                <div style="
                    position: relative;
                    background: var(--email-card-bg);
                    border-radius: 12px;
                    overflow: hidden;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    border: 1px solid var(--email-border);
                    ${unavailableStyle}
                    width: 100%;
                    max-width: 200px;
                    margin: 0 auto;
                ">
                    <a href="${href}" style="text-decoration: none; color: inherit; display: block;" target="_blank" title="${linkTitle}">
                        <div style="position: relative; aspect-ratio: 2/3; background: #f8f9fa;">
                            <img src="${posterURL}" style="width: 100%; height: 100%; object-fit: cover; display: block;" alt="${titleText}">
                            
                            ${(year || vote) ? `
                                <div style="
                                    position: absolute;
                                    top: 1px;
                                    left: 1px;
                                    background: rgba(0, 0, 0, 0.7);
                                    color: white;
                                    padding: 2px 6px;
                                    border-radius: 4px;
                                    font-size: 9px;
                                    line-height: 1;
                                ">${year} ${vote}</div>
                            ` : ''}
                            
                            ${isUnavailable ? `
                                <div style="
                                    position: absolute;
                                    top: 16px;
                                    left: 1px;
                                    background: rgba(255, 0, 0, 0.8);
                                    color: white;
                                    padding: 2px 6px;
                                    border-radius: 4px;
                                    font-size: 9px;
                                    line-height: 1;
                                ">Unavailable</div>
                            ` : ''}
                            
                            <div style="
                                position: absolute;
                                bottom: 0;
                                left: 0;
                                right: 0;
                                padding: 8px;
                                background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
                            ">
                                <div style="font-weight: bold; font-size: 12px; color: white; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                    ${titleText}
                                </div>
                                ${runtime ? `<div style="font-size: 10px; color: rgba(255, 255, 255, 0.8); margin-top: 2px;">${runtime}</div>` : ''}
                            </div>
                        </div>
                    </a>
                </div>
            `;
        }).join('');
        
        return `
            <div style="margin: 20px 0;">
                <h3 style="color: var(--email-text); margin-bottom: 5px;">${title}</h3>
                <div style="
                    display: grid;
                    grid-template-columns: repeat(5, 1fr);
                    gap: 12px;
                    padding: 0;
                    margin: 0 auto 0 auto;
                    width: 80%;
                ">
                    ${itemsHTML}
                </div>
            </div>
        `;
    }

    function buildCollectionCard(collection, themeColors) {
        const collectionTitle = collection.title || 'Unknown Collection';
        const count = collection.childCount || 0;
        const subtype = collection.subtype || 'unknown';
        const typeIcon = subtype === 'movie' ? 'ðŸ“½ï¸' : subtype === 'show' ? 'ðŸ“º' : 'ðŸŽ§';
        
        let posterURL = null;
        const thumbUrl = collection.thumb;
        const artUrl = collection.art;
        
        if (thumbUrl) {
            if (thumbUrl.startsWith('http')) {
                try {
                    const url = new URL(thumbUrl);
                    posterURL = `/proxy-art${url.pathname}`;
                } catch (e) {
                    console.log('Failed to parse thumb URL:', thumbUrl);
                }
            } else {
                posterURL = `/proxy-art${thumbUrl.startsWith('/') ? thumbUrl : '/' + thumbUrl}`;
            }
        } else if (artUrl) {
            if (artUrl.startsWith('http')) {
                try {
                    const url = new URL(artUrl);
                    posterURL = `/proxy-art${url.pathname}`;
                } catch (e) {
                    console.log('Failed to parse art URL:', artUrl);
                }
            } else {
                posterURL = `/proxy-art${artUrl.startsWith('/') ? artUrl : '/' + artUrl}`;
            }
        }
        
        if (posterURL) {
            return `
                <table cellpadding="0" cellspacing="0" border="0" style="
                    background-color: ${themeColors.card_bg};
                    border-radius: 12px;
                    width: 120px;
                    margin: 0 auto;
                ">
                    <tr>
                        <td style="
                            background-image: url('${posterURL}');
                            background-size: cover;
                            background-position: center;
                            background-repeat: no-repeat;
                            height: 180px;
                            background-color: #f8f9fa;
                            border-radius: 12px;
                            position: relative;
                            vertical-align: top;
                        ">
                            <table cellpadding="0" cellspacing="0" border="0" width="100%">
                                <tr>
                                    <td style="text-align: right;">
                                        <div style="
                                            background-color: rgba(0, 0, 0, 0.8);
                                            color: white;
                                            padding: 4px 6px;
                                            border-radius: 4px;
                                            font-size: 10px;
                                            font-family: 'IBM Plex Sans';
                                            line-height: 1;
                                            display: inline-block;
                                            margin: 6px;
                                        ">
                                            ${typeIcon} ${count}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="height: 150px; vertical-align: bottom;">
                                        <div style="
                                            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
                                            border-radius: 0 0 11px 11px;
                                            padding: 6px;
                                        ">
                                            <div style="
                                                font-weight: bold;
                                                font-size: 12px;
                                                color: white;
                                                line-height: 1.2;
                                                font-family: 'IBM Plex Sans';
                                            ">${collectionTitle}</div>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            `;
        } else {
            return `
                <table cellpadding="0" cellspacing="0" border="0" style="
                    background-color: ${themeColors.card_bg};
                    border-radius: 12px;
                    border: 1px solid ${themeColors.border};
                    width: 120px;
                    height: 180px;
                    margin: 0 auto;
                ">
                    <tr>
                        <td style="
                            text-align: center;
                            vertical-align: middle;
                            padding: 12px;
                        ">
                            <div style="
                                font-weight: bold;
                                font-size: 14px;
                                color: ${themeColors.text};
                                margin-bottom: 8px;
                                font-family: 'IBM Plex Sans';
                                padding: 2px;
                            ">${collectionTitle}</div>
                            <div style="
                                font-size: 11px;
                                color: ${themeColors.muted_text};
                                font-family: 'IBM Plex Sans';
                            ">${typeIcon} ${count} items</div>
                        </td>
                    </tr>
                </table>
            `;
        }
    }

    function buildIndividualItemCardForSchedule(item, themeColors) {
        const itemTitle = item.title || item.name || 'Unknown Title';
        const year = item.year;
        const itemType = item.type || item.subtype || 'unknown';
        
        let displayTitle = itemTitle;
        if (year) {
            displayTitle += ` (${year})`;
        }
        
        const typeIcons = {
            'movie': 'ðŸŽ¬',
            'show': 'ðŸ“º', 
            'album': 'ðŸ’¿',
            'track': 'ðŸŽµ',
            'artist': 'ðŸŽ¤'
        };
        const typeIcon = typeIcons[itemType] || 'ðŸ“„';
        
        let subtitle = "";
        if (item.artist && itemType !== 'show') {
            subtitle = item.artist;
        } else if (item.parentTitle && itemType === 'track') {
            subtitle = item.parentTitle;
        } else if (item.grandparentTitle && itemType === 'track') {
            subtitle = item.grandparentTitle;
        } else if (itemType === 'show') {
            const seasonCount = item.season_count || item.childCount || 0;
            const episodeCount = item.episode_count || item.leafCount || 0;
            if (seasonCount > 0) {
                subtitle = `${seasonCount} season${seasonCount !== 1 ? 's' : ''}`;
            } else if (episodeCount > 0) {
                subtitle = `${episodeCount} episode${episodeCount !== 1 ? 's' : ''}`;
            }
        }
        
        let posterURL = null;
        const thumbUrl = item.thumb;
        const artUrl = item.art;
        
        if (thumbUrl) {
            if (thumbUrl.startsWith('http')) {
                try {
                    const url = new URL(thumbUrl);
                    posterURL = `/proxy-art${url.pathname}`;
                } catch (e) {
                    console.log('Failed to parse thumb URL:', thumbUrl);
                }
            } else {
                posterURL = `/proxy-art${thumbUrl.startsWith('/') ? thumbUrl : '/' + thumbUrl}`;
            }
        } else if (artUrl) {
            if (artUrl.startsWith('http')) {
                try {
                    const url = new URL(artUrl);
                    posterURL = `/proxy-art${url.pathname}`;
                } catch (e) {
                    console.log('Failed to parse art URL:', artUrl);
                }
            } else {
                posterURL = `/proxy-art${artUrl.startsWith('/') ? artUrl : '/' + artUrl}`;
            }
        }
        
        if (posterURL) {
            return `
            <table cellpadding="0" cellspacing="0" border="0" style="
                background-color: ${themeColors.card_bg};
                border-radius: 12px;
                width: 120px;
                margin: 0 auto;
            ">
                <tr>
                    <td style="
                        background-image: url('${posterURL}');
                        background-size: cover;
                        background-position: center;
                        background-repeat: no-repeat;
                        height: 180px;
                        background-color: #f8f9fa;
                        border-radius: 12px;
                        position: relative;
                        vertical-align: top;
                    ">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%">
                            <tr>
                                <td style="text-align: right;">
                                    <div style="
                                        background-color: rgba(0, 0, 0, 0.8);
                                        color: white;
                                        padding: 4px 6px;
                                        border-radius: 4px;
                                        font-size: 10px;
                                        font-family: 'IBM Plex Sans';
                                        line-height: 1;
                                        display: inline-block;
                                        margin: 6px;
                                    ">
                                        ${typeIcon}
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="height: 150px; vertical-align: bottom;">
                                    <div style="
                                        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
                                        border-radius: 0 0 11px 11px;
                                        padding: 6px;
                                    ">
                                        <div style="
                                            font-weight: bold;
                                            font-size: 12px;
                                            color: white;
                                            line-height: 1.2;
                                            font-family: 'IBM Plex Sans';
                                        ">${displayTitle}</div>
                                        ${subtitle ? `
                                            <div style="
                                                font-size: 9px;
                                                color: #ccc;
                                                line-height: 1.2;
                                                font-family: 'IBM Plex Sans';
                                                margin-top: 2px;
                                            ">${subtitle}</div>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
            `;
        } else {
            return `
            <table cellpadding="0" cellspacing="0" border="0" style="
                background-color: ${themeColors.card_bg};
                border-radius: 12px;
                border: 1px solid ${themeColors.border};
                width: 120px;
                height: 180px;
                margin: 0 auto;
            ">
                <tr>
                    <td style="
                        text-align: center;
                        vertical-align: middle;
                        padding: 12px;
                        color: ${themeColors.text};
                        font-family: 'IBM Plex Sans';
                    ">
                        <div style="
                            font-size: 11px;
                            margin-bottom: 8px;
                        ">${typeIcon}</div>
                        <div style="
                            font-weight: bold;
                            font-size: 14px;
                            line-height: 1.2;
                            margin-bottom: 8px;
                            padding: 2px;
                        ">${displayTitle}</div>
                        ${subtitle ? `
                            <div style="
                                font-size: 9px;
                                color: ${themeColors.muted_text};
                                line-height: 1.2;
                            ">${subtitle}</div>
                        ` : ''}
                    </td>
                </tr>
            </table>
            `;
        }
    }

    function buildCollectionPreviewHTMLForEmail(title, collections, groupIndex = 0) {
        const themeColors = {
            card_bg: 'var(--email-card-bg)',
            text: 'var(--email-text)', 
            border: 'var(--email-border)',
            muted_text: 'var(--email-muted)'
        };
        
        if (!collections || collections.length === 0) {
            return `
                <div style="background-color: ${themeColors.card_bg}; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid ${themeColors.border}; font-family: 'IBM Plex Sans';">
                    <p style="text-align: center; color: ${themeColors.muted_text}; padding: 20px; margin: 0; font-family: 'IBM Plex Sans';">No collections available.</p>
                </div>
            `;
        }

        let allItemsToDisplay = [];
                
        collections.forEach((collection, index) => {
            const collectionId = `${groupIndex}-${index}-${collection.key}`;
            const expandedItems = expandedCollections[collectionId];
            
            if (expandedItems && Object.keys(expandedItems).length > 0) {
                Object.values(expandedItems).forEach(item => {
                    allItemsToDisplay.push({
                        ...item,
                        isIndividualItem: true,
                        originalCollection: collection.title
                    });
                });
            } else {
                allItemsToDisplay.push({
                    ...collection,
                    isIndividualItem: false
                });
            }
        });

        const itemsPerRow = 5;
        let itemsHTML = "";
        
        for (let i = 0; i < allItemsToDisplay.length; i += itemsPerRow) {
            const rowItems = allItemsToDisplay.slice(i, i + itemsPerRow);
            const isPartialRow = rowItems.length < itemsPerRow;
            
            if (isPartialRow) {
                const itemsCount = rowItems.length;
                
                let rowHTML = `<tr><td colspan="${itemsPerRow}" style="text-align: center; padding: 8px;">`;
                rowHTML += '<table cellpadding="0" cellspacing="0" border="0" style="margin: 0 auto; border-collapse: separate;">';
                rowHTML += '<tr>';
                
                rowItems.forEach((item, j) => {
                    let cellSpacing = "0";
                    if (itemsCount === 2) {
                        cellSpacing = j === 0 ? "60px" : "0";
                    } else if (itemsCount === 3) {
                        cellSpacing = j < 2 ? "40px" : "0";
                    } else if (itemsCount === 4) {
                        cellSpacing = j < 3 ? "20px" : "0";
                    } else if (itemsCount > 1) {
                        cellSpacing = j < itemsCount - 1 ? "6px" : "0";
                    }
                    
                    const cardHTML = item.isIndividualItem
                        ? buildIndividualItemCardForSchedule(item, themeColors)
                        : buildCollectionCard(item, themeColors);
                    rowHTML += `<td style="vertical-align: top; padding-right: ${cellSpacing};">${cardHTML}</td>`;
                });
                
                rowHTML += '</tr></table></td></tr>';
                itemsHTML += rowHTML;
            } else {
                let rowHTML = "<tr style='text-align: center;'>";
                
                rowItems.forEach((item) => {
                    const cellStyle = `
                        width: 20%;
                        padding: 6px;
                        vertical-align: top;
                        font-family: 'IBM Plex Sans';
                    `;
                    
                    const cardHTML = item.isIndividualItem
                        ? buildIndividualItemCardForSchedule(item, themeColors)
                        : buildCollectionCard(item, themeColors);
                    rowHTML += `<td style="${cellStyle}">${cardHTML}</td>`;
                });
                
                rowHTML += "</tr>";
                itemsHTML += rowHTML;
            }
        }
        
        const containerStyle = `
            background-color: ${themeColors.card_bg};
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid ${themeColors.border};
            font-family: 'IBM Plex Sans';
        `;
        
        const titleStyle = `
            text-align: center;
            color: ${themeColors.text};
            margin: 0 0 20px 0;
            font-size: 24px;
            font-weight: bold;
            font-family: 'IBM Plex Sans';
        `;
        
        const tableStyle = `
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            padding: 0;
        `;
        
        return `
            <div style="${containerStyle}">
                <h2 style="${titleStyle}">${title}</h2>
                <table cellpadding="0" cellspacing="0" border="0" style="${tableStyle}">
                    ${itemsHTML}
                </table>
            </div>
        `;
    }

    function getItemPosterURL(item) {
        const candidates = [item.thumb, item.art, item.parent_thumb, item.grandparent_thumb];
        for (const candidate of candidates) {
            if (candidate) {
                return `/proxy-art${candidate.startsWith('/') ? candidate : '/' + candidate}`;
            }
        }
        return '/static/img/no-poster.png';
    }

    function buildCompleteEmailHTML(contentHTML, serverName, subject) {
        const logoFilename = "{{ settings.logo_filename }}";
        const logoWidth = "{{ settings.logo_width }}";
        const customLogoFilename = "{{ settings.custom_logo_filename }}"
        const themedCSS = getThemedEmailCSS();

        let logoHTML = "";
        if (logoFilename && logoWidth) {
            if (logoFilename == 'custom') {
                logoHTML = `<img src="/static/uploads/logos/${customLogoFilename}" alt="${serverName}" class="email-logo" style="max-width: ${logoWidth}px; width: auto; height: auto;">`;
            } else {
                logoHTML = `<img src="/static/img/${logoFilename}" alt="${serverName}" class="email-logo" style="max-width: ${logoWidth}px; width: auto; height: auto;">`;
            }
        }
        
        return `<!DOCTYPE html>
            <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${subject}</title>
                    ${themedCSS}
                </head>
                <body>
                    <div class="email-container">
                        <div class="email-header">
                            ${logoHTML}
                            <h1 class="email-title">${serverName} Newsletter</h1>
                        </div>
                        
                        <div class="email-content">
                            ${contentHTML}
                        </div>
                        
                        <div class="email-footer">
                            <div style="margin-bottom: 10px;">
                                Generated for Plex Media Server by 
                                <a href="https://github.com/jma1ice/newsletterr">newsletterr</a>
                            </div>
                            <div>
                                newsletterr is not affiliated with or a product of Plex, Inc.
                            </div>
                        </div>
                    </div>
                </body>
            </html>`;
    }

    function resizePreviewFrame(frame) {
        try {
            const doc = frame.contentDocument || frame.contentWindow.document;
            if (doc && doc.body) {
                const contentHeight = Math.max(
                    doc.body.scrollHeight,
                    doc.body.offsetHeight,
                    doc.documentElement.clientHeight,
                    doc.documentElement.scrollHeight,
                    doc.documentElement.offsetHeight
                );
                
                const minHeight = 480;
                const maxHeight = 1200;
                const newHeight = Math.max(minHeight, Math.min(maxHeight, contentHeight + 40));
                
                frame.style.height = newHeight + 'px';
            }
        } catch (e) {
            console.log('Could not resize iframe:', e);
        }
    }

    document.addEventListener('DOMContentLoaded', loadPreview);
</script>
{% endblock %}
